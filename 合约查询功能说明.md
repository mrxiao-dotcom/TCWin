# 合约查询功能说明

## 🎯 解决的问题

**用户反馈**：在合约栏中输入了合约名，现在不会触发自动获取这个合约的价格，还是之前的旧合约。

**用户建议**：加一个查询按钮，点击后展示新的合约数据，更新其他栏目。

## 🚀 解决方案

### 🆕 新增"查询"按钮
- **位置**：合约名称输入框右侧
- **外观**：蓝色小按钮，白色字体
- **尺寸**：35x25像素，便于点击
- **提示**："查询合约信息：价格、交易规则、持仓、订单等"

### ⚡ 查询功能详解

#### 🔍 **步骤1：获取最新价格**
- 调用币安API获取指定合约的实时价格
- 更新界面显示的"最新价"字段
- 将价格缓存到服务中供其他功能使用
- 如果价格获取失败，提示用户检查合约名称

#### 📋 **步骤2：获取交易规则**
- 调用真实的币安交易规则API（`/fapi/v1/exchangeInfo`）
- 获取精确的交易限制：
  - **最小/最大下单量**：如BTC 0.001-1000, ETH 0.001-10000
  - **价格精度**：如BTC 0.1, ETH 0.01
  - **数量精度**：如BTC 0.001, ADA 1
  - **最大杠杆**：如BTC 125x, ETH 100x
  - **最大名义价值**：风险控制限制
- 如果API失败，使用动态计算的备选方案

#### 📈 **步骤3：刷新持仓信息**
- 获取所有持仓，寻找指定合约的持仓
- 如果找到持仓：
  - 自动选择该持仓（`SelectedPosition`）
  - 在持仓列表中高亮选中
  - 显示详细持仓信息（数量、开仓价等）
- 如果无持仓：显示"当前无持仓"

#### 📋 **步骤4：更新订单信息**
- 获取指定合约的所有未成交订单
- 更新委托列表显示
- 自动过滤显示该合约相关的订单
- 统计并显示订单数量

#### 🎯 **步骤5：重新计算止损价**
- 如果用户设置了止损比例
- 基于新价格自动重新计算止损价
- 确保止损设置与新合约匹配

#### 🎚️ **步骤6：调整杠杆设置**
- 检查当前杠杆是否超过该合约最大杠杆
- 如果超过，自动调整为合理值
- 提示用户杠杆已自动调整

### 📊 查询结果展示

#### ✅ **成功结果对话框**
```
✅ ETHUSDT 合约信息查询完成！

💰 当前价格: 2,850.25
📦 交易限制: 0.001 - 10000
🎚️ 最大杠杆: 100x
📈 持仓状态: 有持仓 0.5 (或无持仓)
📋 委托单数: 3 个
```

#### ❌ **失败情况处理**
- **合约名错误**：提示检查合约名称是否正确
- **网络异常**：提示检查网络连接
- **API异常**：提示检查API配置

### 🔧 界面改进

#### **合约输入区域**
- 将合约输入框宽度从120调整为80
- 在右侧添加35宽的"查询"按钮
- 保持整体布局的协调性

#### **智能响应更新**
- 强制刷新所有相关UI属性
- 更新持仓选择状态
- 更新订单选择状态
- 确保界面数据同步

## 🎯 使用场景

### 1. **切换交易合约**
```
输入: ETHUSDT → 点击"查询" → 获取ETH相关的所有信息
```

### 2. **验证合约有效性**
```
输入: INVALIDCOIN → 点击"查询" → 提示合约名无效
```

### 3. **快速了解合约状态**
```
输入: ADAUSDT → 点击"查询" → 显示ADA的价格、持仓、订单、交易限制
```

### 4. **重新计算交易参数**
```
切换合约后 → 止损价自动重新计算 → 杠杆自动调整
```

## 💡 技术优势

### 🚀 **真实API集成**
- 使用币安真实的`exchangeInfo` API
- 获得最准确的交易规则和限制
- 避免硬编码带来的错误

### 🛡️ **多层容错机制**
- API失败时自动使用备选方案
- 网络异常时友好的错误提示
- 数据验证确保界面稳定

### ⚡ **智能数据联动**
- 一键查询更新所有相关数据
- 自动选择相关持仓和订单
- 智能重新计算交易参数

### 🎯 **用户体验优化**
- 直观的蓝色查询按钮
- 详细的查询结果摘要
- 清晰的进度和状态提示

## 🔄 与现有功能的集成

### **与定时器的配合**
- 查询功能独立于自动刷新
- 可以随时手动触发查询
- 不影响定时器的正常运行

### **与交易规则API的结合**
- 复用了真实交易规则API
- 查询结果可用于下单校验
- 确保数据一致性

### **与选择状态的协调**
- 查询后自动选择相关持仓
- 保持界面状态的逻辑性
- 便于后续操作

## 📝 使用建议

1. **输入合约名后立即点击查询**：确保获取最新信息
2. **查看查询结果对话框**：了解合约的完整状态
3. **检查止损价是否需要调整**：价格变化可能影响止损设置
4. **确认杠杆设置**：不同合约的最大杠杆不同
5. **观察持仓和订单状态**：了解当前交易状况

## 🎉 总结

新的合约查询功能完美解决了用户的需求：
- ✅ **手动触发**：不依赖自动机制，用户完全控制
- ✅ **全面更新**：一键获取价格、交易规则、持仓、订单等全部信息
- ✅ **智能联动**：自动更新相关栏目，保持数据一致性
- ✅ **友好交互**：清晰的按钮和详细的结果反馈

这个功能让用户可以快速、准确地切换和查询不同合约的信息，大大提升了交易效率和体验！ 