# 一键保本加仓功能实现说明

## 🎯 功能概述

在条件单按钮旁新增"一键保本加仓"按钮，实现智能的保本加仓操作。该功能能够自动判断条件、计算加仓数量、执行加仓操作，并设置保本止损委托。

## ✨ 功能特点

### 🔍 智能条件判断
- **持仓检查**: 自动检测当前合约是否有持仓
- **浮盈验证**: 确保持仓有账面浮盈（大于0）
- **风险金门槛**: 浮盈必须大于0.5倍风险金（风险金 = 权益/笔数）

### 📊 自动计算逻辑
- **加仓方向**: 自动与当前持仓方向保持一致
- **风险金计算**: 账户权益 ÷ 账户设置的笔数（允许单笔亏损金额）
- **货值计算**: 风险金 ÷ 止损比例
- **加仓数量**: 货值 ÷ 最新价格
- **保本价格**: 使用加仓后的综合开仓价作为止损价

### 🛡️ 风险控制机制
- **旧委托清理**: 自动删除无效的止损委托（保留止盈、条件单等）
- **保本止损**: 立即设置综合开仓价止损，确保保本
- **数量匹配**: 止损数量与加仓后总持仓数量一致

## 🎮 使用方法

### 前置条件
1. **账户配置**: 确保已选择有效的账户配置
2. **合约选择**: 输入要操作的交易合约
3. **持仓要求**: 当前合约需要有持仓且有浮盈
4. **风险设置**: 账户配置中已设置风险次数（用于计算风险金）

### 操作步骤
1. 在交易界面输入合约符号（如：BTC）
2. 确认当前持仓有足够的浮盈（>0.5倍风险金）
3. 点击"一键保本加仓"按钮
4. 系统自动计算加仓金额（等于风险金）并执行完整流程

## 🔧 技术实现

### UI层实现
```xml
<!-- MainWindow.xaml 新增按钮 -->
<Button Content="一键保本加仓" Command="{Binding OneClickBreakEvenAddPositionCommand}"
       Background="Purple" Foreground="White" FontWeight="Bold"
       Width="95" Height="30" FontSize="10"
       ToolTip="自动判断条件并进行保本加仓操作：需要浮盈>0.5倍风险金"/>
```

### ViewModel层实现
```csharp
// MainViewModel.Trading.cs 新增命令
[RelayCommand]
private async Task OneClickBreakEvenAddPositionAsync()
{
    // 完整的保本加仓逻辑实现
}
```

### 核心执行流程

#### 1. 条件检查阶段
```csharp
// 基础条件验证
- 账户配置检查
- 合约输入验证  
- 账户信息确认

// 持仓条件验证
- 当前合约持仓存在性
- 浮盈为正值确认
- 浮盈达到0.5倍风险金门槛
```

#### 2. 参数计算阶段
```csharp
// 风险金计算
风险金 = 账户权益 ÷ 风险机会次数（允许单笔亏损金额）
最低浮盈要求 = 风险金 × 0.5

// 加仓参数确定
加仓方向 = 当前持仓方向（多头→BUY，空头→SELL）
止损比例 = 界面设置的止损比例
货值 = 风险金 ÷ 止损比例
加仓数量 = 货值 ÷ 当前市价
加仓价格 = 当前市价
```

#### 3. 执行操作阶段
```csharp
// 加仓下单
市价单下单 → 等待成交 → 刷新持仓数据

// 委托管理
删除旧止损委托 → 保留止盈和条件单 → 设置新保本止损

// 保本止损设置
止损价格 = 综合开仓价（加仓后）
止损数量 = 总持仓数量
止损类型 = STOP_MARKET + ReduceOnly
```

## 📋 功能逻辑详解

### 🎯 条件判断逻辑
```csharp
// 1. 基础条件
✅ 账户已配置 && 合约已选择 && 账户信息已加载

// 2. 持仓条件  
✅ 当前合约有持仓 && 持仓浮盈 > 0

// 3. 风险金条件
✅ 持仓浮盈 > (账户权益 ÷ 风险次数) × 0.5
```

### 📊 数量计算逻辑
```csharp
// 基于风险金和止损比例计算加仓数量
1. 计算风险金 = 账户权益 ÷ 风险次数（允许单笔亏损金额）
2. 计算货值 = 风险金 ÷ 止损比例
3. 计算加仓数量 = 货值 ÷ 最新价格
4. 调整到合约精度要求
```

### 🛡️ 风险控制逻辑
```csharp
// 委托单清理策略
保留类型: TAKE_PROFIT_* (止盈单)
保留类型: 条件单 (非ReduceOnly)
删除类型: STOP_MARKET + ReduceOnly (旧止损单)
删除类型: STOP_LIMIT + ReduceOnly (旧限价止损)

// 保本止损设置
止损触发价 = 加仓后的综合开仓价
确保盈亏平衡点保护
```

## 🎨 用户体验设计

### 📱 界面位置
- **位置**: 下单区域，条件单按钮右侧
- **样式**: 紫色背景，白色文字，醒目设计
- **尺寸**: 95px宽，30px高，10号字体

### 💬 状态反馈
- **执行中**: 显示加载状态，按钮不可用
- **成功**: 详细的成功信息（浮盈→保本价）
- **失败**: 明确的错误原因和建议

### 🔔 工具提示
```
自动判断条件并进行保本加仓操作：需要浮盈>0.5倍风险金
```

## 📊 状态消息示例

### ✅ 成功状态
```
✅ 一键保本加仓完成 - 浮盈: 125.50U → 保本价: 45230.25
```

### ❌ 错误状态
```
❌ 当前浮盈 45.20U < 0.5倍风险金(62.50U)，条件不满足
❌ 当前合约 BTCUSDT 无持仓，无法执行保本加仓  
❌ 当前持仓浮盈为 -12.30U，需要有浮盈才能执行保本加仓
```

### ⚠️ 警告状态
```
⚠️ 加仓成功但保本止损设置失败，请手动设置
⚠️ 加仓完成但无法获取更新后的持仓信息
```

## 🔍 日志记录

### 执行日志
```csharp
_logger.LogInformation("开始执行一键保本加仓操作");
_logger.LogInformation($"条件检查通过 - 持仓: {symbol}, 浮盈: {profit:F2}U");
_logger.LogInformation($"计算加仓参数 - 方向: {side}, 数量: {quantity:F6}");
_logger.LogInformation($"加仓下单成功: {symbol} {side} {quantity:F6}");
_logger.LogInformation($"保本止损设置成功: {symbol} @ {stopPrice:F4}");
```

### 错误日志
```csharp
_logger.LogError(ex, "一键保本加仓操作失败");
_logger.LogWarning(ex, $"取消旧止损单失败: {orderId}");
_logger.LogWarning("保本止损设置失败");
```

## 🚀 优势特点

### 🎯 自动化程度高
- **一键操作**: 无需手动计算和多步骤操作
- **智能判断**: 自动验证所有必要条件
- **风险控制**: 自动设置保本保护

### 📊 计算准确性
- **风险金计算**: 基于账户权益和风险次数的科学计算
- **数量计算**: 复用现有成熟的计算逻辑
- **价格获取**: 实时获取最新市价

### 🛡️ 安全性保障
- **条件门槛**: 0.5倍风险金的安全门槛
- **保本机制**: 确保不低于综合开仓价
- **委托管理**: 智能清理旧委托，保留有效订单

## 📈 使用场景

### 🎯 适用情况
1. **趋势行情**: 持仓已有一定浮盈，趋势可能继续
2. **加仓时机**: 满足技术分析的加仓信号
3. **风险管理**: 希望在加仓同时确保保本

### ⚠️ 注意事项
1. **市场波动**: 加仓可能增加持仓风险
2. **滑点影响**: 市价单可能存在滑点
3. **网络延迟**: 操作期间避免网络中断

## 🔧 技术依赖

### 现有功能复用
- `CalculateQuantityFromLossAsync()`: 数量计算
- `RefreshDataAsync()`: 数据刷新
- `NormalizeSymbol()`: 合约名称标准化
- `PlaceOrderAsync()`: 订单提交
- `CancelOrderAsync()`: 订单取消

### 新增功能点
- 条件判断逻辑
- 保本止损自动设置
- 旧委托智能清理

---

## 💡 总结

"一键保本加仓"功能为用户提供了安全、便捷的加仓操作方式。通过智能的条件判断、精确的数量计算和完善的风险控制，确保用户能够在有利的市场条件下安全地扩大持仓规模，同时保持资金安全。

该功能充分利用了现有系统的成熟组件，在不影响现有功能的前提下，提供了强大的交易辅助能力。 