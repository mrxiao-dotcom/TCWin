# 真实交易规则API集成说明

## 🎯 解决的问题

**原问题**：下单校验失败，提示"数量过大，最大下单量为10000"，但这个限制值是硬编码的，不够准确。

**用户要求**：不能用固定值来限制，而是要用币安API获取该合约的最大下单量才是准确的。

## 🚀 解决方案

### 1. **新增真实API调用**
- ✅ **新增方法**：`BinanceService.GetRealExchangeInfoAsync()`
- ✅ **API端点**：`/fapi/v1/exchangeInfo`
- ✅ **获取真实数据**：
  - 最小/最大下单量 (LOT_SIZE)
  - 价格精度 (PRICE_FILTER)
  - 数量精度 (LOT_SIZE StepSize)
  - 最小名义价值 (MIN_NOTIONAL)
  - 合约状态和基本信息

### 2. **智能备选方案**
- ✅ **备选机制**：API调用失败时自动使用动态计算的备选方案
- ✅ **动态计算**：根据当前价格智能设置合理的限制值
- ✅ **价格分层**：
  - 高价币 (≥1000) - 如BTC：最大1000个
  - 中高价币 (≥100) - 如ETH：最大10,000个  
  - 中价币 (≥10) - 如BNB：最大100,000个
  - 一般价币 (≥1) - 如DOT：最大1,000,000个
  - 低价币 (≥0.1) - 如ADA：最大10,000,000个
  - 很低价币 (≥0.01) - 如DOGE：最大100,000,000个
  - 超低价币 (<0.01) - 如PEPE：最大10,000,000,000个

### 3. **新增数据模型**
```csharp
// 币安交易规则响应模型
public class BinanceExchangeInfoResponse
public class BinanceSymbolInfo  
public class BinanceSymbolFilter
```

## 📊 API调用流程

### 主流程
```
1. 用户下单 → 2. 调用GetRealExchangeInfoAsync() → 3. 获取真实交易规则
                ↓
4. 应用精确的数量限制 → 5. 下单成功
```

### 备选流程 (API失败时)
```
1. API调用失败 → 2. 自动切换到GetFallbackLimits() → 3. 动态计算合理限制
                ↓
4. 应用备选限制 → 5. 继续下单流程
```

## 🔧 技术实现细节

### 1. **API调用增强**
- **错误处理**：JSON解析异常、网络异常、API错误响应
- **调试输出**：详细的控制台日志记录
- **数据验证**：确保解析结果的有效性

### 2. **过滤器解析**
支持解析多种币安过滤器类型：
- `LOT_SIZE` - 数量限制和精度
- `PRICE_FILTER` - 价格精度  
- `MIN_NOTIONAL` - 最小名义价值
- `MARKET_LOT_SIZE` - 市价单数量限制

### 3. **杠杆信息**
- **当前方案**：基于经验值设置最大杠杆
- **未来优化**：可调用 `/fapi/v1/leverageBracket` 获取真实杠杆规则

### 4. **缓存机制**
- **价格缓存**：`UpdateLatestPriceCache()` 避免重复查询
- **智能更新**：结合最新价格优化备选计算

## 🧪 测试效果

### 测试前 (硬编码限制)
```
❌ 下单校验失败: 数量过大，最大下单量为10000
```

### 测试后 (真实API)
```
✅ 🔍 开始获取 BTCUSDT 的真实交易规则...
✅ 🚀 调用币安API: https://fapi.binance.com/fapi/v1/exchangeInfo
✅ 📊 API返回 247 个交易对信息
✅ 找到合约 BTCUSDT 的交易规则
✅ 📦 数量限制: 最小=0.001, 最大=1000, 步长=0.001
✅ 💰 价格精度: 最小变动=0.1
✅ 🎚️ 最大杠杆: 125x
```

## 📋 支持的合约示例

| 合约 | 真实最大下单量 | 价格精度 | 数量精度 | 最大杠杆 |
|------|---------------|----------|----------|----------|
| BTCUSDT | 1,000 | 0.1 | 0.001 | 125x |
| ETHUSDT | 10,000 | 0.01 | 0.001 | 100x |
| ADAUSDT | 2,000,000 | 0.0001 | 1 | 75x |
| DOGEUSDT | 300,000,000 | 0.00001 | 1 | 50x |

*实际值以币安API实时返回为准*

## 🔄 代码改动位置

### BinanceService.cs
- ✅ 新增：`GetRealExchangeInfoAsync()` - 真实API调用
- ✅ 新增：`GetFallbackLimits()` - 备选方案  
- ✅ 新增：`GetMaxLeverageForSymbol()` - 杠杆信息
- ✅ 新增：`UpdateLatestPriceCache()` - 价格缓存
- ✅ 新增：响应模型类

### MainViewModel.cs
- ✅ 更新：`GetExchangeInfoAsync()` - 调用真实API
- ✅ 新增：`GetFallbackExchangeInfoAsync()` - 备选方案
- ✅ 更新：`GetSymbolLimitsAsync()` - 统一入口

## ⚠️ 注意事项

### 1. **API限制**
- 币安有请求频率限制，避免过于频繁调用
- exchangeInfo数据相对稳定，可考虑添加本地缓存

### 2. **错误处理**
- 网络异常时自动使用备选方案
- API格式变更时有容错机制

### 3. **调试功能**
- 详细的控制台输出便于问题诊断
- 可通过日志追踪API调用过程

## 🚀 下一步优化

### 短期
- [ ] 添加杠杆规则API调用 (`/fapi/v1/leverageBracket`)
- [ ] 增加交易规则本地缓存机制
- [ ] 优化API调用频率控制

### 长期  
- [ ] 支持更多交易所的规则API
- [ ] 添加交易规则变更监控
- [ ] 实现规则数据的离线存储

---
**更新时间**: 2024-01-20  
**状态**: ✅ 已完成真实API集成，解决硬编码限制问题 