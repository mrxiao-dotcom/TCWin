# 定时器功能说明

## 功能概述

程序现在具备了自动更新功能，通过两个定时器在后台自动获取最新数据，无需手动刷新。

## 定时器详情

### 1. 价格更新定时器
- **更新频率**: 每5秒
- **功能**: 自动获取当前选择合约的最新价格
- **触发条件**: 
  - 必须已选择账户
  - 必须已设置合约名称（Symbol字段）
- **显示**: 在状态栏显示更新时间和价格信息

### 2. 账户数据更新定时器  
- **更新频率**: 每5秒
- **功能**: 自动刷新以下数据
  - 账户信息（权益、保证金、浮盈、可用余额）
  - 持仓列表
  - 委托单列表
- **触发条件**: 必须已选择账户
- **显示**: 在状态栏显示最后更新时间

## 自动启动机制

### 启动时机
- 当用户在下拉框中选择账户时，两个定时器自动启动
- 切换到其他账户时，定时器会重新启动
- 当用户选择持仓时，会立即更新该合约的价格
- 当用户手动更改合约名称时，会立即获取新合约的价格

### 停止时机
- 当用户取消选择账户时（选择空值），定时器自动停止
- 程序关闭时，定时器自动停止并释放资源
- 用户可以通过"暂停/恢复定时器"按钮手动控制

## 用户界面变化

### 新增控件
1. **暂停/恢复定时器按钮**: 位于账户选择区域，允许用户手动控制定时器
2. **状态栏**: 位于窗口底部，显示当前操作状态和定时器信息

### 状态栏信息
状态栏会显示以下信息：
- `就绪`: 程序初始状态
- `定时器已启动，开始自动更新数据...`: 定时器启动
- `价格已更新: BTCUSDT = 46000.0000 - 14:30:25`: 价格更新成功
- `数据已更新 - 14:30:30`: 账户数据更新成功
- `定时器已停止`: 定时器停止运行
- 各种操作的成功/失败状态

## 智能更新策略

### 价格更新优化
- 只更新当前选择的合约价格，避免不必要的API调用
- 当用户选择新持仓时，立即更新对应合约价格
- 手动修改合约名称时，立即获取新价格

### 数据同步
- 持仓列表更新后，如果有选中的持仓，会自动刷新相关委托单
- 账户信息与持仓、订单数据同步更新，保持数据一致性

## 性能优化

### 错误处理
- 每个定时器都有独立的异常处理
- 网络错误不会影响定时器继续运行
- 错误信息会显示在状态栏中

### 资源管理
- 程序关闭时自动清理定时器资源
- 避免内存泄漏和后台进程残留

## 使用建议

### 最佳实践
1. **首次使用**: 选择账户后，观察状态栏确认定时器正常工作
2. **监控状态**: 通过状态栏信息了解数据更新情况
3. **网络问题**: 如果网络不稳定，可以暂时暂停定时器，改为手动刷新
4. **节能模式**: 长时间不操作时，可以暂停定时器减少网络请求

### 故障排除
- **定时器未启动**: 确保已选择账户
- **价格不更新**: 检查合约名称是否正确
- **频繁错误**: 检查网络连接和API密钥设置

## 技术实现

### 定时器类型
使用 `System.Windows.Threading.DispatcherTimer` 确保UI线程安全

### 代码结构
```csharp
// 定时器初始化
_priceTimer = new DispatcherTimer();
_priceTimer.Interval = TimeSpan.FromSeconds(5);
_priceTimer.Tick += PriceTimer_Tick;

// 自动启动/停止
partial void OnSelectedAccountChanged(AccountConfig? value)
{
    if (value != null)
    {
        StartTimers();
    }
    else
    {
        StopTimers();
    }
}
```

## 未来增强

计划中的改进：
1. 可配置的更新频率
2. 重要数据变化时的桌面通知
3. 网络状态检测和自动重连
4. 更丰富的状态信息显示 