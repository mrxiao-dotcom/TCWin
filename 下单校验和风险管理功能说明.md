# 下单校验和风险管理功能说明

## 功能概述

本次更新为币安期货交易管理器添加了完整的下单校验和风险管理功能，确保交易的安全性和合规性。

## 主要功能

### 1. 智能下单校验

#### 杠杆设置校验
- **有持仓时**：自动使用现有持仓的杠杆倍数，无法调整
- **新开仓时**：使用用户设置的杠杆倍数
- **杠杆限制**：根据合约类型检查最大杠杆限制（如BTC最大125x，ETH最大100x）

#### 仓位模式校验
- **有持仓时**：自动使用现有持仓的保证金模式（逐仓/全仓）
- **新开仓时**：默认使用逐仓模式（ISOLATED）
- **模式保护**：防止因模式不匹配导致的下单失败

#### 数量限制校验
- **最小数量**：检查是否满足合约最小下单量要求
- **最大数量**：检查是否超过合约最大下单量限制
- **名义价值**：检查下单金额是否超过最大名义价值限制

### 2. 智能止损计算

#### 止损价格计算
- **买入方向**：止损价 = 当前价 × (1 - 止损比例%)
- **卖出方向**：止损价 = 当前价 × (1 + 止损比例%)
- **自动计算**：根据交易方向和止损比例自动计算合理的止损价

#### 止损金额预算
- **预期亏损**：根据止损价和数量计算预期最大亏损
- **风险控制**：显示止损将产生的具体亏损金额
- **以损定量**：根据可承受亏损金额反推合适的交易数量

#### 止损价格校验
- **方向检查**：确保买入时止损价低于开仓价，卖出时止损价高于开仓价
- **合理性验证**：防止设置不合理的止损价格

### 3. 自动止损单功能

#### 主单+止损单组合
- **主单下单**：首先下达主要交易订单
- **自动止损**：主单成功后自动下达对应的止损市价单
- **数量匹配**：止损单数量与主单完全匹配
- **方向反向**：止损单方向与主单相反（买入对应卖出止损）

#### 止损单特性
- **类型**：STOP_MARKET（止损市价单）
- **触发**：价格达到止损价时自动执行
- **减仓模式**：设置为ReduceOnly，只能减少持仓

### 4. 优化的持仓显示

#### 详细信息展示
- **方向显示**：用"买入"/"卖出"替代"BOTH"，并用颜色区分（绿色买入，红色卖出）
- **持仓货值**：数量 × 标记价格，显示持仓的市值
- **保证金占用**：持仓货值 ÷ 杠杆，显示实际占用的保证金
- **收益率**：浮盈 ÷ 保证金 × 100%，显示投资回报率

#### 颜色标识
- **方向颜色**：买入（绿色）、卖出（红色）
- **盈亏颜色**：盈利（绿色）、亏损（红色）

## 使用流程

### 1. 下单前准备
1. 选择合约（如BTCUSDT）
2. 设置交易方向（BUY/SELL）
3. 输入交易数量
4. 设置杠杆倍数（如果是新开仓）
5. 设置止损比例（推荐2-5%）

### 2. 智能计算
1. 点击"更新"按钮获取最新价格
2. 点击"计算止损价"按钮自动计算止损价格
3. 系统显示预期最大亏损金额
4. 可使用"以损定量"功能根据风险金额计算合适数量

### 3. 下单校验
1. 点击"下单"按钮
2. 系统自动执行校验：
   - 杠杆和保证金模式校验
   - 数量限制校验
   - 止损价格合理性校验
3. 显示校验结果和调整后的参数

### 4. 确认下单
1. 查看下单确认信息
2. 确认参数无误后点击"确定"
3. 系统先下主单，成功后自动下止损单
4. 显示下单结果和预期风险

## 安全特性

### 1. 多重校验
- **参数校验**：确保所有参数符合交易所规则
- **风险校验**：计算并显示最大可能亏损
- **确认机制**：下单前必须确认所有信息

### 2. 错误处理
- **校验失败**：显示具体错误原因和建议
- **下单失败**：提供详细的失败信息
- **部分成功**：主单成功但止损单失败时的提醒

### 3. 风险提示
- **预期亏损**：明确显示止损时的预期亏损金额
- **杠杆风险**：显示当前杠杆倍数和风险等级
- **保证金占用**：实时显示保证金使用情况

## 技术实现

### 1. 校验算法
- 基于币安API规则的参数校验
- 智能的杠杆和保证金模式适配
- 精确的止损价格计算算法

### 2. 数据同步
- 实时获取持仓信息用于校验
- 自动更新价格用于计算
- 及时刷新账户状态

### 3. 用户体验
- 一键智能计算功能
- 清晰的确认对话框
- 详细的状态反馈

## 注意事项

1. **首次使用**：建议先在测试网环境熟悉功能
2. **止损设置**：建议设置2-5%的止损比例
3. **杠杆使用**：高杠杆有高风险，请谨慎使用
4. **网络延迟**：止损单可能因网络延迟存在滑点
5. **市场波动**：极端行情下止损可能无法完全保护

## 更新日志

- ✅ 添加完整的下单校验系统
- ✅ 实现智能止损价格计算
- ✅ 添加自动止损单功能
- ✅ 优化持仓信息显示
- ✅ 增强风险管理功能
- ✅ 改进用户交互体验 