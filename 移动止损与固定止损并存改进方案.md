# ç§»åŠ¨æ­¢æŸä¸å›ºå®šæ­¢æŸå¹¶å­˜æ”¹è¿›æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒæ€è·¯

æ‚¨çš„å‘ç°å¾ˆæœ‰ä»·å€¼ï¼å¦‚æœå¸å®‰APIç¡®å®æ”¯æŒä¸€ä¸ªæ–¹å‘æŒä»“æœ‰å¤šä¸ªæ­¢æŸå•ï¼Œé‚£ä¹ˆå¯ä»¥å®ç°**å›ºå®šæ­¢æŸå•ä½œä¸ºåº•çº¿ä¿æŠ¤ï¼Œç§»åŠ¨æ­¢æŸå•è´Ÿè´£é”å®šåˆ©æ¶¦**çš„åŒé‡ä¿æŠ¤æœºåˆ¶ã€‚

## ğŸ” å½“å‰é—®é¢˜åˆ†æ

### **å½“å‰å¼ºåˆ¶æ›¿æ¢çš„ä»£ç é—®é¢˜**

```csharp
// å½“å‰ConvertToTrailingStopAsyncçš„é—®é¢˜ä»£ç 
private async Task<bool> ConvertToTrailingStopAsync(OrderInfo stopOrder)
{
    // âŒ é—®é¢˜ï¼šå¼ºåˆ¶å–æ¶ˆç°æœ‰æ­¢æŸå•
    var cancelled = await _binanceService.CancelOrderAsync(stopOrder.Symbol, stopOrder.OrderId);
    if (!cancelled) return false;
    
    // âŒ é—®é¢˜ï¼šæ›¿æ¢è€Œéå¹¶å­˜
    var success = await _binanceService.PlaceOrderAsync(trailingStopRequest);
    return success;
}
```

### **é—®é¢˜æ ¹æº**

1. **è®¾è®¡å‡è®¾é”™è¯¯**ï¼šå‡è®¾å¸å®‰åªå…è®¸ä¸€ä¸ªæ­¢æŸå•
2. **å¼ºåˆ¶å–æ¶ˆé€»è¾‘**ï¼šä¸»åŠ¨å–æ¶ˆç°æœ‰æ­¢æŸå•
3. **ç¼ºå°‘ç”¨æˆ·é€‰æ‹©**ï¼šæ²¡æœ‰ç»™ç”¨æˆ·"å¹¶å­˜"çš„é€‰é¡¹

## ğŸš€ æ”¹è¿›æ–¹æ¡ˆ

### **æ–¹æ¡ˆ1ï¼šä¿å®ˆå¹¶å­˜æ¨¡å¼**

ä¿®æ”¹ `ConvertToTrailingStopAsync` æ–¹æ³•ï¼Œæ”¯æŒä¿ç•™ç°æœ‰æ­¢æŸå•ï¼š

```csharp
/// <summary>
/// ä¸ºæŒä»“æ·»åŠ ç§»åŠ¨æ­¢æŸå•ï¼ˆä¿ç•™ç°æœ‰æ­¢æŸå•ï¼‰
/// </summary>
private async Task<bool> AddTrailingStopAsync(OrderInfo existingStopOrder)
{
    try
    {
        var position = Positions.FirstOrDefault(p => p.Symbol == existingStopOrder.Symbol);
        if (position == null || position.PositionAmt == 0)
        {
            _logger.LogWarning($"æœªæ‰¾åˆ°å¯¹åº”æŒä»“: {existingStopOrder.Symbol}");
            return false;
        }

        // ğŸ†• è®¡ç®—ç§»åŠ¨æ­¢æŸå›è°ƒç‡ï¼ˆåŸºäºç°æœ‰æ­¢æŸçš„ä¿æŠ¤æ°´å¹³ï¼‰
        var callbackRate = CalculateStopLossRatio(position.EntryPrice, existingStopOrder.StopPrice, position.PositionAmt > 0);
        if (callbackRate <= 0)
        {
            _logger.LogWarning($"æ— æ³•è®¡ç®—æœ‰æ•ˆå›è°ƒç‡: {existingStopOrder.Symbol}");
            return false;
        }

        // ğŸ†• å…³é”®æ”¹è¿›ï¼šä¸å–æ¶ˆç°æœ‰æ­¢æŸå•ï¼Œç›´æ¥åˆ›å»ºç§»åŠ¨æ­¢æŸå•
        var trailingStopRequest = new OrderRequest
        {
            Symbol = existingStopOrder.Symbol,
            Side = existingStopOrder.Side,
            Type = "TRAILING_STOP_MARKET",
            Quantity = existingStopOrder.OrigQty,
            CallbackRate = callbackRate,
            ReduceOnly = true,
            PositionSide = existingStopOrder.PositionSide,
            WorkingType = "CONTRACT_PRICE"
        };

        var success = await _binanceService.PlaceOrderAsync(trailingStopRequest);
        if (success)
        {
            _logger.LogInformation($"ç§»åŠ¨æ­¢æŸå•æ·»åŠ æˆåŠŸï¼ˆä¿ç•™å›ºå®šæ­¢æŸï¼‰: {existingStopOrder.Symbol} å›è°ƒç‡{callbackRate:F2}%");
            _logger.LogInformation($"å½“å‰ä¿æŠ¤: å›ºå®šæ­¢æŸ@{existingStopOrder.StopPrice:F4} + ç§»åŠ¨æ­¢æŸ{callbackRate:F2}%å›è°ƒ");
            return true;
        }
        else
        {
            _logger.LogWarning($"ç§»åŠ¨æ­¢æŸå•åˆ›å»ºå¤±è´¥: {existingStopOrder.Symbol}");
            return false;
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, $"æ·»åŠ ç§»åŠ¨æ­¢æŸå¤±è´¥: {existingStopOrder?.Symbol}");
        return false;
    }
}
```

### **æ–¹æ¡ˆ2ï¼šæ™ºèƒ½åˆ†å±‚ä¿æŠ¤æ¨¡å¼**

å®ç°æ›´æ™ºèƒ½çš„åˆ†å±‚æ­¢æŸç­–ç•¥ï¼š

```csharp
/// <summary>
/// æ™ºèƒ½åˆ†å±‚æ­¢æŸï¼šå›ºå®šæ­¢æŸä½œä¸ºåº•çº¿ï¼Œç§»åŠ¨æ­¢æŸé”å®šåˆ©æ¶¦
/// </summary>
private async Task<bool> CreateLayeredStopProtectionAsync(PositionInfo position)
{
    try
    {
        var isLong = position.PositionAmt > 0;
        var side = isLong ? "SELL" : "BUY";
        var currentPrice = await _binanceService.GetLatestPriceAsync(position.Symbol);
        
        // ğŸ”¥ ç¬¬ä¸€å±‚ï¼šå›ºå®šæ­¢æŸå•ï¼ˆåº•çº¿ä¿æŠ¤ï¼‰
        var baseStopLossRatio = CalculateBaseStopLossRatio(position); // ä¾‹å¦‚ï¼š5%
        var fixedStopPrice = CalculateStopPrice(position.EntryPrice, baseStopLossRatio, isLong);
        
        var fixedStopRequest = new OrderRequest
        {
            Symbol = position.Symbol,
            Side = side,
            Type = "STOP_MARKET",
            Quantity = Math.Abs(position.PositionAmt) * 0.7m, // 70%ä»“ä½ç”¨äºå›ºå®šæ­¢æŸ
            StopPrice = fixedStopPrice,
            ReduceOnly = true,
            PositionSide = position.PositionSideString,
            WorkingType = "CONTRACT_PRICE"
        };
        
        // ğŸš€ ç¬¬äºŒå±‚ï¼šç§»åŠ¨æ­¢æŸå•ï¼ˆåˆ©æ¶¦é”å®šï¼‰
        var trailingCallbackRate = CalculateTrailingCallbackRate(position); // ä¾‹å¦‚ï¼š2%
        
        var trailingStopRequest = new OrderRequest
        {
            Symbol = position.Symbol,
            Side = side,
            Type = "TRAILING_STOP_MARKET",
            Quantity = Math.Abs(position.PositionAmt) * 0.3m, // 30%ä»“ä½ç”¨äºç§»åŠ¨æ­¢æŸ
            CallbackRate = trailingCallbackRate,
            ReduceOnly = true,
            PositionSide = position.PositionSideString,
            WorkingType = "CONTRACT_PRICE"
        };
        
        // å…ˆåˆ›å»ºå›ºå®šæ­¢æŸå•
        var fixedSuccess = await _binanceService.PlaceOrderAsync(fixedStopRequest);
        await Task.Delay(200); // é¿å…APIé™åˆ¶
        
        // å†åˆ›å»ºç§»åŠ¨æ­¢æŸå•
        var trailingSuccess = await _binanceService.PlaceOrderAsync(trailingStopRequest);
        
        if (fixedSuccess && trailingSuccess)
        {
            _logger.LogInformation($"åˆ†å±‚æ­¢æŸä¿æŠ¤åˆ›å»ºæˆåŠŸ: {position.Symbol}");
            _logger.LogInformation($"  â”œâ”€ å›ºå®šæ­¢æŸ: 70%ä»“ä½ @{fixedStopPrice:F4} ({baseStopLossRatio:F1}%ä¿æŠ¤)");
            _logger.LogInformation($"  â””â”€ ç§»åŠ¨æ­¢æŸ: 30%ä»“ä½ {trailingCallbackRate:F1}%å›è°ƒç‡");
            return true;
        }
        else
        {
            _logger.LogWarning($"åˆ†å±‚æ­¢æŸä¿æŠ¤åˆ›å»ºéƒ¨åˆ†å¤±è´¥: å›ºå®š={fixedSuccess}, ç§»åŠ¨={trailingSuccess}");
            return false;
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, $"åˆ›å»ºåˆ†å±‚æ­¢æŸä¿æŠ¤å¤±è´¥: {position.Symbol}");
        return false;
    }
}
```

### **æ–¹æ¡ˆ3ï¼šç”¨æˆ·å¯é€‰æ¨¡å¼**

è®©ç”¨æˆ·è‡ªç”±é€‰æ‹©å¤„ç†æ–¹å¼ï¼š

```csharp
/// <summary>
/// ç§»åŠ¨æ­¢æŸå¤„ç†æ¨¡å¼
/// </summary>
public enum TrailingStopMode
{
    Replace,    // æ›¿æ¢ç°æœ‰æ­¢æŸå•ï¼ˆå½“å‰æ¨¡å¼ï¼‰
    Coexist,    // ä¸ç°æœ‰æ­¢æŸå•å¹¶å­˜
    Layered     // åˆ†å±‚ä¿æŠ¤æ¨¡å¼
}

[ObservableProperty]
private TrailingStopMode _trailingStopMode = TrailingStopMode.Coexist;

private async Task ProcessTrailingStopWithModeAsync()
{
    foreach (var position in eligiblePositions)
    {
        var existingStopOrder = Orders.FirstOrDefault(o => 
            o.Symbol == position.Symbol && 
            o.Type == "STOP_MARKET" && 
            o.ReduceOnly);
            
        if (existingStopOrder != null)
        {
            switch (TrailingStopMode)
            {
                case TrailingStopMode.Replace:
                    // å½“å‰çš„æ›¿æ¢æ¨¡å¼
                    await ConvertToTrailingStopAsync(existingStopOrder);
                    break;
                    
                case TrailingStopMode.Coexist:
                    // ğŸ†• å¹¶å­˜æ¨¡å¼ï¼šä¿ç•™å›ºå®šæ­¢æŸï¼Œæ·»åŠ ç§»åŠ¨æ­¢æŸ
                    await AddTrailingStopAsync(existingStopOrder);
                    break;
                    
                case TrailingStopMode.Layered:
                    // ğŸ†• åˆ†å±‚æ¨¡å¼ï¼šæ™ºèƒ½åˆ†é…ä»“ä½
                    await CreateLayeredStopProtectionAsync(position);
                    break;
            }
        }
        else
        {
            // æ²¡æœ‰ç°æœ‰æ­¢æŸå•æ—¶çš„å¤„ç†
            await CreateTrailingStopOrderAsync(position);
        }
    }
}
```

## ğŸ¯ å¹¶å­˜æ¨¡å¼çš„ä¼˜åŠ¿

### **é£é™©ç®¡ç†ä¼˜åŠ¿**

1. **åŒé‡ä¿æŠ¤**ï¼š
   ```
   å›ºå®šæ­¢æŸå•ï¼šåº•çº¿ä¿æŠ¤ï¼Œé˜²æ­¢é‡å¤§æŸå¤±
   ç§»åŠ¨æ­¢æŸå•ï¼šåˆ©æ¶¦é”å®šï¼Œä»·æ ¼å›è°ƒæ—¶ä¿æŠ¤åˆ©æ¶¦
   ```

2. **é€‚åº”ä¸åŒå¸‚åœºçŠ¶å†µ**ï¼š
   ```
   éœ‡è¡å¸‚åœºï¼šå›ºå®šæ­¢æŸé˜²æ­¢é¢‘ç¹è§¦å‘
   è¶‹åŠ¿å¸‚åœºï¼šç§»åŠ¨æ­¢æŸé”å®šè¶‹åŠ¿åˆ©æ¶¦
   ```

3. **é™ä½å¿ƒç†å‹åŠ›**ï¼š
   ```
   ç”¨æˆ·çŸ¥é“æœ‰åº•çº¿ä¿æŠ¤ï¼Œæ›´å®¹æ˜“åšæŒæŒä»“
   ç§»åŠ¨æ­¢æŸè‡ªåŠ¨è°ƒæ•´ï¼Œå‡å°‘äººä¸ºå¹²é¢„
   ```

### **å®é™…æ¡ˆä¾‹åˆ†æ**

**BTCå¤šå¤´æŒä»“ç¤ºä¾‹**ï¼š
```
å¼€ä»“ä»·ï¼š50000 USDT
å½“å‰ä»·ï¼š52000 USDTï¼ˆç›ˆåˆ©4%ï¼‰

å¹¶å­˜æ¨¡å¼è®¾ç½®ï¼š
â”œâ”€ å›ºå®šæ­¢æŸå•ï¼š48000 USDTï¼ˆ-4%åº•çº¿ä¿æŠ¤ï¼‰
â””â”€ ç§»åŠ¨æ­¢æŸå•ï¼š2%å›è°ƒç‡ï¼ˆå½“å‰æ¿€æ´»ä»·çº¦50960ï¼‰

ä»·æ ¼èµ°åŠ¿åˆ†æï¼š
- å¦‚æœè·Œç ´48000ï¼šå›ºå®šæ­¢æŸå•è§¦å‘ï¼Œé¿å…æ›´å¤§æŸå¤±
- å¦‚æœç»§ç»­ä¸Šæ¶¨åˆ°54000å†å›è°ƒ2%ï¼šç§»åŠ¨æ­¢æŸå•åœ¨52920è§¦å‘ï¼Œé”å®šåˆ©æ¶¦
- å¦‚æœç›´æ¥å›è°ƒä½†ä¸è·Œç ´48000ï¼šä¸¤ä¸ªæ­¢æŸå•éƒ½ä¿æŒæ´»è·ƒçŠ¶æ€
```

## ğŸ› ï¸ ç•Œé¢æ”¹è¿›å»ºè®®

### **ç§»åŠ¨æ­¢æŸæ§åˆ¶é¢æ¿**

```xml
<!-- ç§»åŠ¨æ­¢æŸæ¨¡å¼é€‰æ‹© -->
<StackPanel Orientation="Horizontal" Margin="0,0,0,10">
    <TextBlock Text="ç§»åŠ¨æ­¢æŸæ¨¡å¼:" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,10,0"/>
    
    <RadioButton Content="æ›¿æ¢æ¨¡å¼" IsChecked="{Binding IsReplaceMode}" 
                GroupName="TrailingStopMode" Margin="0,0,15,0"
                ToolTip="å–æ¶ˆç°æœ‰æ­¢æŸå•ï¼Œæ›¿æ¢ä¸ºç§»åŠ¨æ­¢æŸå•"/>
                
    <RadioButton Content="å¹¶å­˜æ¨¡å¼" IsChecked="{Binding IsCoexistMode}" 
                GroupName="TrailingStopMode" Margin="0,0,15,0"
                ToolTip="ä¿ç•™ç°æœ‰æ­¢æŸå•ï¼Œé¢å¤–æ·»åŠ ç§»åŠ¨æ­¢æŸå•"/>
                
    <RadioButton Content="åˆ†å±‚æ¨¡å¼" IsChecked="{Binding IsLayeredMode}" 
                GroupName="TrailingStopMode" Margin="0,0,15,0"
                ToolTip="æ™ºèƒ½åˆ†é…ä»“ä½ï¼Œåˆ›å»ºåˆ†å±‚æ­¢æŸä¿æŠ¤"/>
</StackPanel>

<Button Command="{Binding ToggleTrailingStopCommand}" Margin="6,0,0,0">
    <Button.Content>
        <StackPanel Orientation="Horizontal">
            <TextBlock Text="{Binding TrailingStopButtonText}"/>
            <TextBlock Text="{Binding TrailingStopModeText}" FontSize="10" Foreground="Gray" Margin="5,0,0,0"/>
        </StackPanel>
    </Button.Content>
</Button>
```

### **çŠ¶æ€æ˜¾ç¤ºæ”¹è¿›**

```csharp
// æ˜¾ç¤ºå½“å‰ä¿æŠ¤çŠ¶æ€
public string ProtectionStatus
{
    get
    {
        var fixedStopCount = Orders.Count(o => o.Type == "STOP_MARKET" && o.ReduceOnly);
        var trailingStopCount = Orders.Count(o => o.Type == "TRAILING_STOP_MARKET" && o.ReduceOnly);
        
        return $"ä¿æŠ¤çŠ¶æ€: å›ºå®šæ­¢æŸÃ—{fixedStopCount} + ç§»åŠ¨æ­¢æŸÃ—{trailingStopCount}";
    }
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### **APIæµ‹è¯•å»ºè®®**

åœ¨å®æ–½å‰å»ºè®®å…ˆæµ‹è¯•å¸å®‰APIæ˜¯å¦çœŸçš„æ”¯æŒå¤šä¸ªæ­¢æŸå•ï¼š

```csharp
/// <summary>
/// æµ‹è¯•å¸å®‰APIæ˜¯å¦æ”¯æŒå¤šä¸ªæ­¢æŸå•
/// </summary>
public async Task<bool> TestMultipleStopOrdersAsync(string symbol)
{
    try
    {
        // å°è¯•ä¸ºåŒä¸€ä¸ªæŒä»“åˆ›å»ºä¸¤ä¸ªæ­¢æŸå•
        var request1 = new OrderRequest { /* ç¬¬ä¸€ä¸ªæ­¢æŸå•å‚æ•° */ };
        var request2 = new OrderRequest { /* ç¬¬äºŒä¸ªæ­¢æŸå•å‚æ•° */ };
        
        var success1 = await _binanceService.PlaceOrderAsync(request1);
        await Task.Delay(500);
        var success2 = await _binanceService.PlaceOrderAsync(request2);
        
        _logger.LogInformation($"å¤šæ­¢æŸå•æµ‹è¯•ç»“æœ: ç¬¬ä¸€ä¸ª={success1}, ç¬¬äºŒä¸ª={success2}");
        return success1 && success2;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "å¤šæ­¢æŸå•æµ‹è¯•å¤±è´¥");
        return false;
    }
}
```

### **é£é™©æ§åˆ¶**

1. **ä»“ä½åˆ†é…éªŒè¯**ï¼šç¡®ä¿åˆ†å±‚æ¨¡å¼ä¸‹çš„ä»“ä½åˆ†é…ä¸è¶…è¿‡æ€»æŒä»“
2. **ä»·æ ¼åˆç†æ€§æ£€æŸ¥**ï¼šç¡®ä¿å¤šä¸ªæ­¢æŸä»·æ ¼è®¾ç½®åˆç†
3. **APIé™åˆ¶ç›‘æ§**ï¼šç›‘æ§æ˜¯å¦è§¦å‘å¸å®‰çš„APIé™åˆ¶

## ğŸš€ æ€»ç»“

**æ”¯æŒç§»åŠ¨æ­¢æŸä¸å›ºå®šæ­¢æŸå¹¶å­˜æ˜¯ä¸€ä¸ªä¼˜ç§€çš„æ”¹è¿›æ–¹å‘**ï¼š

1. **æŠ€æœ¯å¯è¡Œæ€§**ï¼šå¦‚æœå¸å®‰APIæ”¯æŒï¼Œä»£ç ä¿®æ”¹ç›¸å¯¹ç®€å•
2. **ç”¨æˆ·ä»·å€¼**ï¼šæä¾›æ›´çµæ´»å’Œå¼ºå¤§çš„é£é™©ç®¡ç†å·¥å…·
3. **å‘åå…¼å®¹**ï¼šå¯ä»¥ä¿ç•™ç°æœ‰çš„æ›¿æ¢æ¨¡å¼ä½œä¸ºé€‰é¡¹

**å»ºè®®å®æ–½æ­¥éª¤**ï¼š
1. å…ˆæµ‹è¯•APIæ˜¯å¦çœŸçš„æ”¯æŒå¤šä¸ªæ­¢æŸå•
2. å®ç°åŸºç¡€çš„å¹¶å­˜æ¨¡å¼
3. æ ¹æ®ç”¨æˆ·åé¦ˆè€ƒè™‘æ˜¯å¦å¢åŠ åˆ†å±‚æ¨¡å¼
4. å®Œå–„ç•Œé¢å’Œç”¨æˆ·ä½“éªŒ

è¿™å°†ä½¿æ‚¨çš„äº¤æ˜“å·¥å…·åœ¨é£é™©ç®¡ç†æ–¹é¢æ›´åŠ å¼ºå¤§å’Œçµæ´»ï¼ 