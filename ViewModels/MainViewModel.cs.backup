using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Linq;
using System.Runtime.CompilerServices;
using System.Threading.Tasks;
using System.Windows.Input;
using System.Windows.Threading;
using BinanceFuturesTrader.Models;
using BinanceFuturesTrader.Services;
using BinanceFuturesTrader.Converters;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;

namespace BinanceFuturesTrader.ViewModels
{
    public partial class MainViewModel : ObservableObject
    {
        private readonly AccountConfigService _accountService;
        private readonly BinanceService _binanceService;
        private readonly TradingSettingsService _tradingSettingsService;
        private readonly DispatcherTimer _priceTimer;
        private readonly DispatcherTimer _accountTimer;
        private bool _isInitializing = true; // é¿å…åˆå§‹åŒ–æ—¶ä¿å­˜è®¾ç½®

        [ObservableProperty]
        private ObservableCollection<AccountConfig> _accounts = new();

        [ObservableProperty]
        private AccountConfig? _selectedAccount;

        [ObservableProperty]
        [NotifyPropertyChangedFor(nameof(TotalWalletBalance))]
        [NotifyPropertyChangedFor(nameof(TotalMarginBalance))] 
        [NotifyPropertyChangedFor(nameof(TotalUnrealizedProfit))]
        [NotifyPropertyChangedFor(nameof(AvailableBalance))]
        [NotifyPropertyChangedFor(nameof(UnrealizedProfitColor))]
        private AccountInfo? _accountInfo;

        [ObservableProperty]
        private ObservableCollection<PositionInfo> _positions = new();

        [ObservableProperty]
        private ObservableCollection<OrderInfo> _orders = new();

        [ObservableProperty]
        private ObservableCollection<OrderInfo> _filteredOrders = new();

        [ObservableProperty]
        private PositionInfo? _selectedPosition;

        [ObservableProperty]
        private string _symbol = "BTCUSDT";

        [ObservableProperty]
        private string _side = "BUY";

        [ObservableProperty]
        private string _positionSide = "BOTH";

        [ObservableProperty]
        private int _leverage = 3;

        [ObservableProperty]
        private decimal _quantity = 0;

        [ObservableProperty]
        private decimal _latestPrice = 0;

        [ObservableProperty]
        [NotifyPropertyChangedFor(nameof(IsLimitConditionalOrder))]
        [NotifyPropertyChangedFor(nameof(IsConditionalOrderVisible))]
        private string _orderType = "MARKET";

        [ObservableProperty]
        private string _marginType = "ISOLATED";

        [ObservableProperty]
        private decimal _stopLossRatio = 5;

        [ObservableProperty]
        private decimal _stopLossPrice = 0;

        [ObservableProperty]
        private decimal _stopLossAmount = 0;

        [ObservableProperty]
        private bool _isLoading = false;

        [ObservableProperty]
        private string _statusMessage = "å°±ç»ª";

        [ObservableProperty]
        private bool _autoRefreshEnabled = true;

        // ï¿½ï¿½Ó¯Ö¹ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        [ObservableProperty]
        private LockProfitStopLossRequest _lockProfitRequest = new();

        // æ¡ä»¶å•ç›¸å…³å±ï¿½?        private ObservableCollection<ConditionalOrderInfo> _conditionalOrders = new();
        public ObservableCollection<ConditionalOrderInfo> ConditionalOrders
        {
            get => _conditionalOrders;
            set => SetProperty(ref _conditionalOrders, value);
        }

        public bool HasNoConditionalOrders => !ConditionalOrders.Any();

        private string _workingType = "CONTRACT_PRICE";
        public string WorkingType
        {
            get => _workingType;
            set => SetProperty(ref _workingType, value);
        }

        // æ–°å¢çš„æ¡ä»¶å•å±ï¿½?        private string _conditionalType = "STOP";
        public string ConditionalType
        {
            get => _conditionalType;
            set => SetProperty(ref _conditionalType, value);
        }
        
        private string _timeInForce = "GTC";
        public string TimeInForce
        {
            get => _timeInForce;
            set => SetProperty(ref _timeInForce, value);
        }
        
        private decimal _stopPrice = 0;
        public decimal StopPrice
        {
            get => _stopPrice;
            set => SetProperty(ref _stopPrice, value);
        }
        
        private decimal _price = 0;
        public decimal Price
        {
            get => _price;
            set => SetProperty(ref _price, value);
        }
        
        private bool _reduceOnly = false;
        public bool ReduceOnly
        {
            get => _reduceOnly;
            set => SetProperty(ref _reduceOnly, value);
        }

        public bool IsLimitConditionalOrder
        {
            get
            {
                return OrderType == "STOP" || OrderType == "TAKE_PROFIT";
            }
        }

        // æ¡ä»¶å•è®¾ç½®ç•Œé¢å¯è§ï¿½?        public bool IsConditionalOrderVisible
        {
            get
            {
                return OrderType == "æ¡ä»¶ï¿½?;
            }
        }

        // è®¡ç®—å±æ€§ï¼šæ˜¯å¦å¯ä»¥ä¸‹å•
        public bool CanPlaceOrder
        {
            get
            {
                // æ£€æŸ¥å¿…è¦çš„æ•°æ®æ˜¯å¦å·²å¡«ï¿½?                var canPlace = SelectedAccount != null &&
                              !string.IsNullOrWhiteSpace(Symbol) &&
                              LatestPrice > 0 &&
                              Quantity > 0 &&
                              !IsLoading;
                
                // åªåœ¨ç‰¹å®šæƒ…å†µä¸‹æ›´æ–°çŠ¶æ€æç¤ºï¼Œé¿å…å¹²æ‰°å…¶ä»–åŠŸèƒ½
                if (!canPlace && StatusMessage == "å°±ç»ª")
                {
                    if (SelectedAccount == null)
                    {
                        StatusMessage = "è¯·é€‰æ‹©äº¤æ˜“è´¦æˆ·";
                    }
                    else if (string.IsNullOrWhiteSpace(Symbol))
                    {
                        StatusMessage = "è¯·è¾“å…¥åˆçº¦åç§°ï¼ˆå¦‚ï¼šBTCUSDTï¿½?;
                    }
                    else if (LatestPrice <= 0)
                    {
                        StatusMessage = "æ­£åœ¨è·å–æœ€æ–°ä»·ï¿½?..";
                    }
                    else if (Quantity <= 0)
                    {
                        StatusMessage = "è¯·è¾“å…¥äº¤æ˜“æ•°é‡æˆ–ä½¿ç”¨'ä»¥æŸå®šé‡'è®¡ç®—";
                    }
                }
                
                return canPlace;
            }
        }

        // é€‰ä¸­è®¢å•ç›¸å…³å±ï¿½?        public ObservableCollection<OrderInfo> SelectedOrders
        {
            get
            {
                var selected = new ObservableCollection<OrderInfo>();
                foreach (var order in FilteredOrders.Where(o => o.IsSelected))
                {
                    selected.Add(order);
                }
                return selected;
            }
        }

        public bool HasSelectedOrders => FilteredOrders.Any(o => o.IsSelected);
        
        public int SelectedOrderCount => FilteredOrders.Count(o => o.IsSelected);

        // é€‰ä¸­çš„æ­¢æŸå•ç›¸å…³å±ï¿½?        public bool HasSelectedStopOrders => FilteredOrders.Any(o => o.IsSelected && o.Type == "STOP_MARKET");
        
        public int SelectedStopOrderCount => FilteredOrders.Count(o => o.IsSelected && o.Type == "STOP_MARKET");

        // é€‰ä¸­æŒä»“ç›¸å…³å±ï¿½?        public ObservableCollection<PositionInfo> SelectedPositions
        {
            get
            {
                var selected = new ObservableCollection<PositionInfo>();
                foreach (var position in Positions.Where(p => p.IsSelected))
                {
                    selected.Add(position);
                }
                return selected;
            }
        }

        public bool HasSelectedPositions => Positions.Any(p => p.IsSelected);
        
        public int SelectedPositionCount => Positions.Count(p => p.IsSelected);

        // è´¦æˆ·ä¿¡æ¯è®¡ç®—å±æ€§ï¼Œç”¨äºUIç»‘å®š
        // ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨å¸å®‰APIè¿”å›çš„è´¦æˆ·æƒç›Šï¿½?        public decimal TotalWalletBalance => AccountInfo?.TotalWalletBalance ?? 0;
        
        // ä¿®å¤ï¼šæ˜¾ç¤ºè®¡ç®—å‡ºçš„å®é™…å·²ç”¨ä¿è¯é‡‘ï¼Œè€Œä¸æ˜¯APIè¿”å›çš„ä¿è¯é‡‘ä½™é¢
        public decimal TotalMarginBalance => AccountInfo?.ActualMarginUsed ?? 0;
        public decimal TotalUnrealizedProfit => AccountInfo?.TotalUnrealizedProfit ?? 0;
        public decimal AvailableBalance => AccountInfo?.AvailableBalance ?? 0;
        
        // æµ®åŠ¨ç›ˆäºé¢œè‰²
        public string UnrealizedProfitColor => TotalUnrealizedProfit >= 0 ? "Green" : "Red";

        // === å•é€‰æŒ‰é’®ç»‘å®šå±ï¿½?===
        
        // äº¤æ˜“æ–¹å‘å•é€‰æŒ‰ï¿½?        public bool IsBuySelected
        {
            get => Side == "BUY";
            set
            {
                if (value)
                {
                    Side = "BUY";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsSellSelected));
                }
            }
        }

        public bool IsSellSelected
        {
            get => Side == "SELL";
            set
            {
                if (value)
                {
                    Side = "SELL";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsBuySelected));
                }
            }
        }

        // è®¢å•ç±»å‹å•é€‰æŒ‰ï¿½?        public bool IsMarketOrderSelected
        {
            get => OrderType == "MARKET";
            set
            {
                if (value)
                {
                    OrderType = "MARKET";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsLimitOrderSelected));
                }
            }
        }

        public bool IsLimitOrderSelected
        {
            get => OrderType == "LIMIT";
            set
            {
                if (value)
                {
                    OrderType = "LIMIT";
                    // é€‰æ‹©é™ä»·å•æ—¶è‡ªåŠ¨å¡«å…¥æœ€æ–°ä»·ï¿½?                    if (LatestPrice > 0)
                    {
                        Price = LatestPrice;
                        Console.WriteLine($"ğŸ’° é€‰æ‹©é™ä»·å•ï¼Œè‡ªåŠ¨å¡«å…¥ä»·æ ¼: {PriceFormatConverter.FormatPrice(Price)}");
                    }
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsMarketOrderSelected));
                }
            }
        }

        // åˆ¤æ–­æ˜¯å¦æ˜¯é™ä»·å•ï¼ˆç”¨äºUIç»‘å®šï¿½?        public bool IsLimitOrder => OrderType == "LIMIT";

        // ä¿è¯é‡‘æ¨¡å¼å•é€‰æŒ‰ï¿½?        public bool IsIsolatedMarginSelected
        {
            get => MarginType == "ISOLATED";
            set
            {
                if (value)
                {
                    MarginType = "ISOLATED";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsCrossedMarginSelected));
                }
            }
        }

        public bool IsCrossedMarginSelected
        {
            get => MarginType == "CROSSED";
            set
            {
                if (value)
                {
                    MarginType = "CROSSED";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsIsolatedMarginSelected));
                }
            }
        }

        // æ¡ä»¶å•ç±»å‹å•é€‰æŒ‰ï¿½?        public bool IsStopSelected
        {
            get => ConditionalType == "STOP";
            set
            {
                if (value)
                {
                    ConditionalType = "STOP";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsTakeProfitSelected));
                    OnPropertyChanged(nameof(IsStopMarketSelected));
                    OnPropertyChanged(nameof(IsTakeProfitMarketSelected));
                }
            }
        }

        public bool IsTakeProfitSelected
        {
            get => ConditionalType == "TAKE_PROFIT";
            set
            {
                if (value)
                {
                    ConditionalType = "TAKE_PROFIT";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsStopSelected));
                    OnPropertyChanged(nameof(IsStopMarketSelected));
                    OnPropertyChanged(nameof(IsTakeProfitMarketSelected));
                }
            }
        }

        public bool IsStopMarketSelected
        {
            get => ConditionalType == "STOP_MARKET";
            set
            {
                if (value)
                {
                    ConditionalType = "STOP_MARKET";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsStopSelected));
                    OnPropertyChanged(nameof(IsTakeProfitSelected));
                    OnPropertyChanged(nameof(IsTakeProfitMarketSelected));
                }
            }
        }

        public bool IsTakeProfitMarketSelected
        {
            get => ConditionalType == "TAKE_PROFIT_MARKET";
            set
            {
                if (value)
                {
                    ConditionalType = "TAKE_PROFIT_MARKET";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsStopSelected));
                    OnPropertyChanged(nameof(IsTakeProfitSelected));
                    OnPropertyChanged(nameof(IsStopMarketSelected));
                }
            }
        }

        // è§¦å‘æ–¹å¼å•é€‰æŒ‰ï¿½?        public bool IsContractPriceSelected
        {
            get => WorkingType == "CONTRACT_PRICE";
            set
            {
                if (value)
                {
                    WorkingType = "CONTRACT_PRICE";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsMarkPriceSelected));
                }
            }
        }

        public bool IsMarkPriceSelected
        {
            get => WorkingType == "MARK_PRICE";
            set
            {
                if (value)
                {
                    WorkingType = "MARK_PRICE";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsContractPriceSelected));
                }
            }
        }

        // æœ‰æ•ˆæœŸå•é€‰æŒ‰ï¿½?        public bool IsGTCSelected
        {
            get => TimeInForce == "GTC";
            set
            {
                if (value)
                {
                    TimeInForce = "GTC";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsIOCSelected));
                    OnPropertyChanged(nameof(IsFOKSelected));
                }
            }
        }

        public bool IsIOCSelected
        {
            get => TimeInForce == "IOC";
            set
            {
                if (value)
                {
                    TimeInForce = "IOC";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsGTCSelected));
                    OnPropertyChanged(nameof(IsFOKSelected));
                }
            }
        }

        public bool IsFOKSelected
        {
            get => TimeInForce == "FOK";
            set
            {
                if (value)
                {
                    TimeInForce = "FOK";
                    OnPropertyChanged();
                    OnPropertyChanged(nameof(IsGTCSelected));
                    OnPropertyChanged(nameof(IsIOCSelected));
                }
            }
        }

        // æœ€è¿‘åˆçº¦åˆ—ï¿½?- æœ€å¤šä¿ï¿½?0ï¿½?        [ObservableProperty]
        private ObservableCollection<string> _recentContracts = new();

        public MainViewModel()
        {
            _accountService = new AccountConfigService();
            _binanceService = new BinanceService();
            _tradingSettingsService = new TradingSettingsService();
            
            // åˆå§‹åŒ–å®šæ—¶å™¨
            _priceTimer = new DispatcherTimer();
            _priceTimer.Interval = TimeSpan.FromSeconds(2);
            _priceTimer.Tick += PriceTimer_Tick;

            _accountTimer = new DispatcherTimer();
            _accountTimer.Interval = TimeSpan.FromSeconds(5);
            _accountTimer.Tick += AccountTimer_Tick;

            LoadAccounts();
            LoadTradingSettings();
            
            // åˆå§‹åŒ–æ—¶æ˜¾ç¤ºæ‰€æœ‰å§”æ‰˜å•
            FilterOrdersForPosition(); // ä¸ä¼ å‚æ•°ï¼Œæ˜¾ç¤ºæ‰€æœ‰å§”æ‰˜å•
        }

        private async void PriceTimer_Tick(object? sender, EventArgs e)
        {
            if (SelectedAccount == null || string.IsNullOrEmpty(Symbol))
                return;

            try
            {
                // é™é»˜è·å–æœ€æ–°ä»·æ ¼ï¼Œä¸è¾“å‡ºè°ƒè¯•ä¿¡ï¿½?                var newPrice = await _binanceService.GetLatestPriceAsync(Symbol);
                if (newPrice > 0)
                {
                    var oldPrice = LatestPrice;
                    LatestPrice = newPrice;
                    
                    // åªåœ¨ä»·æ ¼æœ‰æ˜¾è‘—å˜åŒ–æ—¶ï¼ˆè¶…ï¿½?%ï¼‰æ‰è¾“å‡ºæ—¥å¿—
                    if (Math.Abs(newPrice - oldPrice) > oldPrice * 0.01m) // 1% å˜åŒ–
                    {
                        var formattedOldPrice = PriceFormatConverter.FormatPrice(oldPrice);
                        var formattedNewPrice = PriceFormatConverter.FormatPrice(newPrice);
                        Console.WriteLine($"ğŸ“Š {Symbol} ä»·æ ¼å¤§å¹…å˜åŒ–: {formattedOldPrice} ï¿½?{formattedNewPrice}");
                    }
                }
            }
            catch (Exception ex)
            {
                // ç½‘ç»œå¼‚å¸¸æ—¶ä¸è¾“å‡ºï¼Œé¿å…åˆ·ï¿½?                // Console.WriteLine($"ï¿½?å®šæ—¶ä»·æ ¼æ›´æ–°å¤±è´¥: {ex.Message}");
                // ä¸æ›´æ–°StatusMessageï¼Œé¿å…å¹²æ‰°ç”¨æˆ·æ“ï¿½?            }
        }

        private async void AccountTimer_Tick(object? sender, EventArgs e)
        {
            if (SelectedAccount == null || !AutoRefreshEnabled)
                return;

            try
            {
                // é™é»˜è‡ªåŠ¨åˆ·æ–°ï¼Œå‡å°‘æ—¥å¿—å™ªï¿½?                
                // ä¿å­˜å½“å‰é€‰æ‹©çŠ¶ï¿½?                var selectedOrderIds = new HashSet<long>();
                var selectedPositionSymbols = new HashSet<string>();
                
                foreach (var order in FilteredOrders.Where(o => o.IsSelected))
                {
                    selectedOrderIds.Add(order.OrderId);
                }
                
                foreach (var position in Positions.Where(p => p.IsSelected))
                {
                    var positionKey = $"{position.Symbol}_{position.PositionSideString}";
                    selectedPositionSymbols.Add(positionKey);
                }

                // æ›´æ–°è´¦æˆ·ä¿¡æ¯
                var accountInfo = await _binanceService.GetAccountInfoAsync();
                if (accountInfo != null)
                {
                    AccountInfo = accountInfo;
                }

                // æ›´æ–°æŒä»“ä¿¡æ¯
                var positions = await _binanceService.GetPositionsAsync();
                
                Positions.Clear();
                int restoredPositionCount = 0;
                foreach (var position in positions)
                {
                    // æ¢å¤æŒä»“é€‰æ‹©çŠ¶ï¿½?                    var positionKey = $"{position.Symbol}_{position.PositionSideString}";
                    if (selectedPositionSymbols.Contains(positionKey))
                    {
                        position.IsSelected = true;
                        restoredPositionCount++;
                    }
                    Positions.Add(position);
                }

                // è®¡ç®—ä¿è¯é‡‘å ï¿½?                if (AccountInfo != null)
                {
                    AccountInfo.CalculateMarginUsed(Positions);
                    OnPropertyChanged(nameof(AccountInfo.ActualMarginUsed));
                    // å¼ºåˆ¶é€šçŸ¥å·²ç”¨ä¿è¯é‡‘å±æ€§æ›´ï¿½?                    OnPropertyChanged(nameof(TotalMarginBalance));
                    // é€šçŸ¥è´¦æˆ·æƒç›Šå±æ€§æ›´ï¿½?                    OnPropertyChanged(nameof(TotalWalletBalance));
                }

                // æ›´æ–°è®¢å•ä¿¡æ¯
                var orders = await _binanceService.GetOpenOrdersAsync();
                
                Orders.Clear();
                int restoredOrderCount = 0;
                foreach (var order in orders)
                {
                    // æ¢å¤è®¢å•é€‰æ‹©çŠ¶ï¿½?                    if (selectedOrderIds.Contains(order.OrderId))
                    {
                        order.IsSelected = true;
                        restoredOrderCount++;
                    }
                    Orders.Add(order);
                }

                // å¦‚æœæœ‰é€‰ä¸­çš„æŒä»“ï¼Œæ›´æ–°è¿‡æ»¤çš„è®¢ï¿½?                if (SelectedPosition != null)
                {
                    FilterOrdersForPosition(SelectedPosition.Symbol);
                    
                    // æ¢å¤è¿‡æ»¤è®¢å•çš„é€‰æ‹©çŠ¶ï¿½?                    int restoredFilteredOrderCount = 0;
                    foreach (var order in FilteredOrders)
                    {
                        if (selectedOrderIds.Contains(order.OrderId))
                        {
                            order.IsSelected = true;
                            restoredFilteredOrderCount++;
                        }
                    }
                }
                else
                {
                    // æ²¡æœ‰é€‰ä¸­æŒä»“ï¼Œæ˜¾ç¤ºæ‰€æœ‰å§”æ‰˜å•
                    FilterOrdersForPosition(); // ä¸ä¼ å‚æ•°ï¼Œæ˜¾ç¤ºæ‰€æœ‰å§”æ‰˜å•
                    
                    // æ¢å¤æ‰€æœ‰è®¢å•çš„é€‰æ‹©çŠ¶ï¿½?                    int restoredFilteredOrderCount = 0;
                    foreach (var order in FilteredOrders)
                    {
                        if (selectedOrderIds.Contains(order.OrderId))
                        {
                            order.IsSelected = true;
                            restoredFilteredOrderCount++;
                        }
                    }
                }

                // å¼ºåˆ¶é€šçŸ¥é€‰æ‹©çŠ¶æ€å±æ€§æ›´ï¿½?                OnPropertyChanged(nameof(SelectedOrders));
                OnPropertyChanged(nameof(HasSelectedOrders));
                OnPropertyChanged(nameof(SelectedOrderCount));
                OnPropertyChanged(nameof(SelectedPositions));
                OnPropertyChanged(nameof(HasSelectedPositions));
                OnPropertyChanged(nameof(SelectedPositionCount));
                OnPropertyChanged(nameof(HasSelectedStopOrders));
                OnPropertyChanged(nameof(SelectedStopOrderCount));

                StatusMessage = $"æ•°æ®å·²æ›´ï¿½?- {DateTime.Now:HH:mm:ss}";
                // åªåœ¨æ§åˆ¶å°è¾“å‡ºç®€å•çš„æˆåŠŸä¿¡æ¯ï¼Œä¸ä½¿ç”¨LogService
                // Console.WriteLine($"ğŸ”„ è‡ªåŠ¨åˆ·æ–°å®Œæˆ - {DateTime.Now:HH:mm:ss}");
            }
            catch (Exception ex)
            {
                StatusMessage = $"æ•°æ®æ›´æ–°å¤±è´¥: {ex.Message}";
                LogService.LogError("ï¿½?è‡ªåŠ¨åˆ·æ–°å¼‚å¸¸", ex);
            }
        }

        private void LoadAccounts()
        {
            var accounts = _accountService.GetAllAccounts();
            Accounts.Clear();
            foreach (var account in accounts)
            {
                Accounts.Add(account);
            }
        }

        private void LoadTradingSettings()
        {
            try
            {
                var settings = _tradingSettingsService.LoadSettings();
                
                // åº”ç”¨è®¾ç½®åˆ°å½“å‰å±ï¿½?                Symbol = settings.Symbol;
                Side = settings.Side;
                Leverage = settings.Leverage;
                MarginType = settings.MarginType;
                OrderType = settings.OrderType;
                StopLossRatio = settings.StopLossRatio;
                PositionSide = settings.PositionSide;
                
                StatusMessage = $"äº¤æ˜“è®¾ç½®å·²åŠ ï¿½?- {settings.LastSaved:yyyy-MM-dd HH:mm:ss}";
                Console.WriteLine("ğŸ”§ äº¤æ˜“è®¾ç½®å·²åº”ç”¨åˆ°ç•Œé¢");
            }
            catch (Exception ex)
            {
                StatusMessage = $"åŠ è½½è®¾ç½®å¤±è´¥: {ex.Message}";
                Console.WriteLine($"ï¿½?åŠ è½½äº¤æ˜“è®¾ç½®å¼‚å¸¸: {ex.Message}");
            }
            finally
            {
                // åˆå§‹åŒ–å®Œæˆï¼Œå…è®¸ä¿å­˜è®¾ç½®
                _isInitializing = false;
            }
        }
        
        public void SaveTradingSettings()
        {
            try
            {
                var settings = new TradingSettings
                {
                    Symbol = Symbol,
                    Side = Side,
                    Leverage = Leverage,
                    MarginType = MarginType,
                    OrderType = OrderType,
                    StopLossRatio = StopLossRatio,
                    PositionSide = PositionSide,
                    LastSaved = DateTime.Now
                };
                
                _tradingSettingsService.SaveSettings(settings);
                Console.WriteLine("ğŸ’¾ äº¤æ˜“è®¾ç½®å·²ä¿ï¿½?);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ï¿½?ä¿å­˜äº¤æ˜“è®¾ç½®å¼‚å¸¸: {ex.Message}");
            }
        }

        partial void OnSelectedAccountChanged(AccountConfig? value)
        {
            if (value != null)
            {
                _binanceService.SetAccount(value);
                
                // å¯åŠ¨å®šæ—¶ï¿½?                StartTimers();
                
                // ç«‹å³åˆ·æ–°ä¸€æ¬¡æ•°ï¿½?                _ = RefreshDataAsync();
            }
            else
            {
                // åœæ­¢å®šæ—¶ï¿½?                StopTimers();
                
                // æ¸…ç©ºå§”æ‰˜å•æ˜¾ï¿½?                FilteredOrders.Clear();
            }
            
            // é€šçŸ¥ä¸‹å•æŒ‰é’®çŠ¶æ€æ›´ï¿½?            OnPropertyChanged(nameof(CanPlaceOrder));
        }

        partial void OnSelectedPositionChanged(PositionInfo? value)
        {
            if (value != null)
            {
                // é€‰æ‹©äº†æŒä»“ï¼Œæ˜¾ç¤ºè¯¥åˆçº¦çš„å§”æ‰˜ï¿½?                FilterOrdersForPosition(value.Symbol);
                Symbol = value.Symbol;
                
                // ç«‹å³æ›´æ–°è¯¥åˆçº¦çš„ä»·æ ¼
                _ = UpdateLatestPriceAsync();
            }
            else
            {
                // å–æ¶ˆé€‰æ‹©æŒä»“ï¼Œæ˜¾ç¤ºæ‰€æœ‰åˆçº¦çš„å§”æ‰˜ï¿½?                Console.WriteLine("ğŸ” å–æ¶ˆé€‰æ‹©æŒä»“ï¼Œæ˜¾ç¤ºæ‰€æœ‰å§”æ‰˜å•");
                FilterOrdersForPosition(); // ä¸ä¼ å‚æ•°ï¼Œæ˜¾ç¤ºæ‰€æœ‰å§”æ‰˜å•
            }
        }

        partial void OnSymbolChanged(string value)
        {
            // è‡ªåŠ¨è¡¥é½USDTåç¼€
            if (!string.IsNullOrWhiteSpace(value))
            {
                var upperValue = value.ToUpper().Trim();
                
                // å¦‚æœæ²¡æœ‰USDTåç¼€ï¼Œè‡ªåŠ¨æ·»ï¿½?                if (!upperValue.EndsWith("USDT") && !upperValue.Contains("USDT"))
                {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å¸¸è§çš„å¸ç§ç¬¦ï¿½?                    if (IsValidCoinSymbol(upperValue))
                    {
                        var newSymbol = upperValue + "USDT";
                        if (Symbol != newSymbol)
                        {
                            Symbol = newSymbol;
                            StatusMessage = $"å·²è‡ªåŠ¨è¡¥é½ä¸º {newSymbol}";
                            Console.WriteLine($"ğŸ”§ è‡ªåŠ¨è¡¥é½åˆçº¦ï¿½? {value} ï¿½?{newSymbol}");
                            return; // é¿å…é‡å¤è§¦å‘
                        }
                    }
                }
                else if (upperValue != value)
                {
                    // ç»Ÿä¸€è½¬æ¢ä¸ºå¤§ï¿½?                    Symbol = upperValue;
                    return; // é¿å…é‡å¤è§¦å‘
                }
            }
            
            // åˆ‡æ¢åˆçº¦æ—¶ï¼Œæ¸…ç©ºç›¸å…³æ•°é‡å’Œæ­¢æŸè®¾ç½®ï¼Œé¿å…è‡ªåŠ¨è®¡ç®—å¹²æ‰°ç”¨æˆ·æ“ä½œ
            if (!string.IsNullOrEmpty(value))
            {
                Console.WriteLine($"ğŸ”„ åˆ‡æ¢åˆçº¦ï¿½?{value}ï¼Œæ¸…ç©ºæ•°é‡å’Œæ­¢æŸè®¾ç½®");
                
                // æ¸…ç©ºæ•°é‡
                Quantity = 0;
                
                // æ¸…ç©ºæ­¢æŸç›¸å…³è®¾ç½®
                StopLossRatio = 0;
                StopLossPrice = 0;
                StopLossAmount = 0;
                
                Console.WriteLine("ï¿½?å·²æ¸…ç©ºæ•°é‡å’Œæ­¢æŸè®¾ç½®ï¼Œç”¨æˆ·å¯é‡æ–°è¾“å…¥");
            }
            
            // å½“åˆçº¦åç§°æ”¹å˜æ—¶ï¼Œç«‹å³æ›´æ–°ä»·ï¿½?            if (SelectedAccount != null && !string.IsNullOrEmpty(value))
            {
                _ = UpdateLatestPriceAsync();
            }
            
            // æ·»åŠ åˆ°æœ€è¿‘åˆçº¦åˆ—ï¿½?            if (!string.IsNullOrEmpty(value) && value.Contains("USDT"))
            {
                AddToRecentContracts(value);
            }
            
            // é€šçŸ¥ä¸‹å•æŒ‰é’®çŠ¶æ€æ›´ï¿½?            OnPropertyChanged(nameof(CanPlaceOrder));
        }

        private bool IsValidCoinSymbol(string symbol)
        {
            // å¸¸è§çš„å¸ç§ç¬¦å·åˆ—ï¿½?            var validSymbols = new[]
            {
                "BTC", "ETH", "BNB", "ADA", "DOT", "XRP", "LTC", "BCH", "LINK", "SOL",
                "DOGE", "MATIC", "AVAX", "UNI", "ATOM", "FIL", "TRX", "ETC", "THETA", "VET",
                "ICP", "FTT", "LUNA", "CRO", "NEAR", "ALGO", "MANA", "SAND", "AXS", "SHIB",
                "HBAR", "EGLD", "FLOW", "CAKE", "RUNE", "KSM", "XTZ", "WAVES", "COMP", "ZEC",
                "1INCH", "SUSHI", "SNX", "MKR", "AAVE", "GRT", "YFI", "CRV", "BAT", "ENJ"
            };
            
            return validSymbols.Contains(symbol) || symbol.Length >= 2;
        }

        partial void OnLatestPriceChanged(decimal value)
        {
            // å¦‚æœå½“å‰æ˜¯é™ä»·å•ä¸”æœ‰æœ€æ–°ä»·æ ¼ï¼Œè‡ªåŠ¨æ›´æ–°ä»·æ ¼è¾“å…¥ï¿½?            if (value > 0 && OrderType == "LIMIT")
            {
                Price = value;
                Console.WriteLine($"ğŸ“Š æœ€æ–°ä»·æ ¼æ›´æ–°ï¼Œé™ä»·å•ä»·æ ¼è‡ªåŠ¨æ›´æ–°ä¸º: {PriceFormatConverter.FormatPrice(Price)}");
            }
            
            // å½“æœ€æ–°ä»·æ ¼å˜åŒ–æ—¶ï¼Œå¦‚æœè®¾ç½®äº†æ­¢æŸæ¯”ä¾‹ï¼Œè‡ªåŠ¨é‡æ–°è®¡ç®—æ­¢æŸä»·
            if (value > 0 && StopLossRatio > 0)
            {
                CalculateStopLossPrice();
            }
            
            // é€šçŸ¥ä¸‹å•æŒ‰é’®çŠ¶æ€æ›´ï¿½?            OnPropertyChanged(nameof(CanPlaceOrder));
        }

        partial void OnQuantityChanged(decimal value)
        {
            // æ•°é‡å˜åŒ–æ—¶é€šçŸ¥ä¸‹å•æŒ‰é’®çŠ¶æ€æ›´ï¿½?            OnPropertyChanged(nameof(CanPlaceOrder));
        }

        partial void OnIsLoadingChanged(bool value)
        {
            // åŠ è½½çŠ¶æ€å˜åŒ–æ—¶é€šçŸ¥ä¸‹å•æŒ‰é’®çŠ¶æ€æ›´ï¿½?            OnPropertyChanged(nameof(CanPlaceOrder));
        }

        private void StartTimers()
        {
            _priceTimer.Start();
            _accountTimer.Start();
            StatusMessage = "å®šæ—¶å™¨å·²å¯åŠ¨ï¼Œå¼€å§‹è‡ªåŠ¨æ›´æ–°æ•°ï¿½?..";
        }

        private void StopTimers()
        {
            _priceTimer.Stop();
            _accountTimer.Stop();
            StatusMessage = "å®šæ—¶å™¨å·²åœæ­¢";
        }

        private void FilterOrdersForPosition(string? symbol = null)
        {
            try
            {
                // æ”¹è¿›åçš„å§”æ‰˜å•è¿‡æ»¤é€»è¾‘ï¿½?                // 1. å¦‚æœæ²¡æœ‰ä¼ å…¥symbolå‚æ•°ï¼ˆæˆ–ä¸ºç©ºï¼‰ï¼Œæ˜¾ç¤ºæ‰€æœ‰åˆçº¦çš„å§”æ‰˜ï¿½?                // 2. å¦‚æœä¼ å…¥äº†symbolï¼Œåˆ™åªæ˜¾ç¤ºè¯¥åˆçº¦çš„å§”æ‰˜å•
                
                if (string.IsNullOrEmpty(symbol))
                {
                    Console.WriteLine("ğŸ” æ˜¾ç¤ºæ‰€æœ‰åˆçº¦çš„å§”æ‰˜ï¿½?);
                    
                    App.Current.Dispatcher.Invoke(() =>
                    {
                        try
                        {
                            FilteredOrders.Clear();
                            
                            // æ˜¾ç¤ºæ‰€æœ‰è®¢ï¿½?                            foreach (var order in Orders)
                            {
                                if (order != null)
                                {
                                    FilteredOrders.Add(order);
                                }
                            }
                            
                            Console.WriteLine($"ï¿½?æ˜¾ç¤ºæ‰€æœ‰å§”æ‰˜å•: {FilteredOrders.Count} ï¿½?);
                        }
                        catch (Exception uiEx)
                        {
                            Console.WriteLine($"ï¿½?UIé›†åˆæ“ä½œå¼‚å¸¸: {uiEx.Message}");
                            try
                            {
                                FilteredOrders.Clear();
                            }
                            catch (Exception clearEx)
                            {
                                Console.WriteLine($"ï¿½?æ¸…ç©ºé›†åˆä¹Ÿå¤±ï¿½? {clearEx.Message}");
                            }
                        }
                    });
                    return;
                }
                
                Console.WriteLine($"ğŸ” è¿‡æ»¤æ˜¾ç¤ºåˆçº¦ {symbol} çš„å§”æ‰˜å•");

                if (Orders == null)
                {
                    Console.WriteLine($"ï¿½?è®¢å•åˆ—è¡¨ä¸ºç©º");
                    return;
                }

                // å®‰å…¨åœ°åˆ›å»ºè¿‡æ»¤åˆ—ï¿½?                List<OrderInfo> filtered;
                try
                {
                    filtered = Orders.Where(o => o != null && o.Symbol == symbol).ToList();
                    Console.WriteLine($"ğŸ“Š è¿‡æ»¤ç»“æœ: æ‰¾åˆ° {filtered.Count} ï¿½?{symbol} çš„è®¢ï¿½?);
                }
                catch (Exception filterEx)
                {
                    Console.WriteLine($"ï¿½?è®¢å•è¿‡æ»¤é€»è¾‘å¼‚å¸¸: {filterEx.Message}");
                    filtered = new List<OrderInfo>();
                }
                
                // ç¡®ä¿åœ¨UIçº¿ç¨‹ä¸Šå®‰å…¨æ“ä½œé›†ï¿½?                App.Current.Dispatcher.Invoke(() =>
                {
                    try
                    {
                        FilteredOrders.Clear();
                        
                        foreach (var order in filtered)
                        {
                            if (order != null)
                            {
                                FilteredOrders.Add(order);
                            }
                        }
                        
                        Console.WriteLine($"ï¿½?UIæ›´æ–°å®Œæˆ: FilteredOrdersç°æœ‰ {FilteredOrders.Count} ä¸ªè®¢ï¿½?);
                    }
                    catch (Exception uiEx)
                    {
                        Console.WriteLine($"ï¿½?UIé›†åˆæ“ä½œå¼‚å¸¸: {uiEx.Message}");
                        // å°è¯•å®‰å…¨é‡ç½®é›†åˆ
                        try
                        {
                            FilteredOrders.Clear();
                        }
                        catch (Exception clearEx)
                        {
                            Console.WriteLine($"ï¿½?æ¸…ç©ºé›†åˆä¹Ÿå¤±ï¿½? {clearEx.Message}");
                        }
                    }
                });
                
                Console.WriteLine($"ğŸ” è®¢å•è¿‡æ»¤å®Œæˆ: {symbol}, æœ€ç»ˆç»“ï¿½?{FilteredOrders.Count} ä¸ªè®¢ï¿½?);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ï¿½?è®¢å•è¿‡æ»¤é¡¶å±‚å¼‚å¸¸: {ex.Message}");
                Console.WriteLine($"ï¿½?å¼‚å¸¸ç±»å‹: {ex.GetType().Name}");
                Console.WriteLine($"ï¿½?å¼‚å¸¸å †æ ˆ: {ex.StackTrace}");
                
                // æ›´æ–°çŠ¶æ€æ¶ˆæ¯ï¼ˆå®‰å…¨æ–¹å¼ï¿½?                try
                {
                    StatusMessage = $"è®¢å•è¿‡æ»¤å¤±è´¥: {ex.Message}";
                }
                catch (Exception statusEx)
                {
                    Console.WriteLine($"ï¿½?æ›´æ–°çŠ¶æ€æ¶ˆæ¯å¼‚ï¿½? {statusEx.Message}");
                }
                
                // å°è¯•å®‰å…¨æ¸…ç©ºè¿‡æ»¤ç»“æœ
                try
                {
                    App.Current.Dispatcher.Invoke(() =>
                    {
                        try
                        {
                            FilteredOrders.Clear();
                        }
                        catch (Exception clearEx)
                        {
                            Console.WriteLine($"ï¿½?å¼‚å¸¸æ¢å¤æ—¶æ¸…ç©ºé›†åˆå¤±ï¿½? {clearEx.Message}");
                        }
                    });
                }
                catch (Exception dispatcherEx)
                {
                    Console.WriteLine($"ï¿½?Dispatcherè°ƒç”¨å¼‚å¸¸: {dispatcherEx.Message}");
                }
            }
        }

        [RelayCommand]
        private async Task RefreshDataAsync()
        {
            if (SelectedAccount == null)
                return;

            IsLoading = true;
            StatusMessage = "æ‰‹åŠ¨åˆ·æ–°æ•°æ®ï¿½?..";
            try
            {
                LogService.LogDebug("ğŸ”„ å¼€å§‹æ‰‹åŠ¨åˆ·æ–°æ•°ï¿½?..");
                
                // ä¿å­˜å½“å‰é€‰æ‹©çŠ¶ï¿½?                var selectedOrderIds = new HashSet<long>();
                var selectedPositionSymbols = new HashSet<string>();
                
                LogService.LogDebug($"ğŸ“Š å½“å‰FilteredOrdersæ•°é‡: {FilteredOrders.Count}, Positionsæ•°é‡: {Positions.Count}");
                
                foreach (var order in FilteredOrders.Where(o => o.IsSelected))
                {
                    selectedOrderIds.Add(order.OrderId);
                    LogService.LogDebug($"ğŸ’¾ ä¿å­˜è®¢å•é€‰æ‹©: OrderId={order.OrderId}, Symbol={order.Symbol}");
                }
                
                foreach (var position in Positions.Where(p => p.IsSelected))
                {
                    var positionKey = $"{position.Symbol}_{position.PositionSideString}";
                    selectedPositionSymbols.Add(positionKey);
                    LogService.LogDebug($"ğŸ’¾ ä¿å­˜æŒä»“é€‰æ‹©: Key={positionKey}, Amount={position.PositionAmt}");
                }
                
                LogService.LogInfo($"é€‰æ‹©çŠ¶æ€ä¿å­˜å®Œï¿½? è®¢å•{selectedOrderIds.Count}ï¿½? æŒä»“{selectedPositionSymbols.Count}ï¿½?);

                // è·å–è´¦æˆ·ä¿¡æ¯
                AccountInfo = await _binanceService.GetAccountInfoAsync();
                LogService.LogDebug("ï¿½?è´¦æˆ·ä¿¡æ¯æ›´æ–°å®Œæˆ");

                // è·å–æŒä»“ä¿¡æ¯
                var positions = await _binanceService.GetPositionsAsync();
                LogService.LogDebug($"ğŸ“ˆ è·å–åˆ°{positions.Count}ä¸ªæŒä»“æ•°ï¿½?);
                
                Positions.Clear();
                int restoredPositionCount = 0;
                foreach (var position in positions)
                {
                    // æ¢å¤æŒä»“é€‰æ‹©çŠ¶ï¿½?                    var positionKey = $"{position.Symbol}_{position.PositionSideString}";
                    if (selectedPositionSymbols.Contains(positionKey))
                    {
                        position.IsSelected = true;
                        restoredPositionCount++;
                        LogService.LogDebug($"ğŸ”„ æ¢å¤æŒä»“é€‰æ‹©: Key={positionKey}, IsSelected=true");
                    }
                    Positions.Add(position);
                }
                LogService.LogInfo($"æŒä»“é€‰æ‹©çŠ¶æ€æ¢ï¿½? {restoredPositionCount}/{selectedPositionSymbols.Count}ï¿½?);

                // è®¡ç®—ä¿è¯é‡‘å ï¿½?                if (AccountInfo != null)
                {
                    AccountInfo.CalculateMarginUsed(Positions);
                    OnPropertyChanged(nameof(AccountInfo.ActualMarginUsed));
                    // å¼ºåˆ¶é€šçŸ¥å·²ç”¨ä¿è¯é‡‘å±æ€§æ›´ï¿½?                    OnPropertyChanged(nameof(TotalMarginBalance));
                    // é€šçŸ¥è´¦æˆ·æƒç›Šå±æ€§æ›´ï¿½?                    OnPropertyChanged(nameof(TotalWalletBalance));
                }

                // è·å–è®¢å•ä¿¡æ¯
                var orders = await _binanceService.GetOpenOrdersAsync();
                LogService.LogDebug($"ğŸ“‹ è·å–åˆ°{orders.Count}ä¸ªè®¢å•æ•°ï¿½?);
                
                Orders.Clear();
                int restoredOrderCount = 0;
                foreach (var order in orders)
                {
                    // æ¢å¤è®¢å•é€‰æ‹©çŠ¶ï¿½?                    if (selectedOrderIds.Contains(order.OrderId))
                    {
                        order.IsSelected = true;
                        restoredOrderCount++;
                        LogService.LogDebug($"ğŸ”„ æ¢å¤è®¢å•é€‰æ‹©: OrderId={order.OrderId}, IsSelected=true");
                    }
                    Orders.Add(order);
                }
                LogService.LogInfo($"è®¢å•é€‰æ‹©çŠ¶æ€æ¢ï¿½? {restoredOrderCount}/{selectedOrderIds.Count}ï¿½?);

                // æ›´æ–°æœ€æ–°ä»·ï¿½?                if (!string.IsNullOrEmpty(Symbol))
                {
                    LatestPrice = await _binanceService.GetLatestPriceAsync(Symbol);
                }

                // å¦‚æœæœ‰é€‰ä¸­çš„æŒä»“ï¼Œæ›´æ–°è¿‡æ»¤çš„è®¢ï¿½?                if (SelectedPosition != null)
                {
                    LogService.LogDebug($"ğŸ” å½“å‰é€‰ä¸­æŒä»“: {SelectedPosition.Symbol}, å¼€å§‹è¿‡æ»¤è®¢ï¿½?);
                    FilterOrdersForPosition(SelectedPosition.Symbol);
                    
                    // æ¢å¤è¿‡æ»¤è®¢å•çš„é€‰æ‹©çŠ¶ï¿½?                    int restoredFilteredOrderCount = 0;
                    foreach (var order in FilteredOrders)
                    {
                        if (selectedOrderIds.Contains(order.OrderId))
                        {
                            order.IsSelected = true;
                            restoredFilteredOrderCount++;
                            LogService.LogDebug($"ğŸ”„ æ¢å¤è¿‡æ»¤è®¢å•é€‰æ‹©: OrderId={order.OrderId}, IsSelected=true");
                        }
                    }
                    LogService.LogInfo($"è¿‡æ»¤è®¢å•é€‰æ‹©çŠ¶æ€æ¢ï¿½? {restoredFilteredOrderCount}ï¿½?);
                }
                else
                {
                    // æ²¡æœ‰é€‰ä¸­æŒä»“ï¼Œæ˜¾ç¤ºæ‰€æœ‰å§”æ‰˜å•
                    FilterOrdersForPosition(); // ä¸ä¼ å‚æ•°ï¼Œæ˜¾ç¤ºæ‰€æœ‰å§”æ‰˜å•
                    
                    // æ¢å¤æ‰€æœ‰è®¢å•çš„é€‰æ‹©çŠ¶ï¿½?                    int restoredFilteredOrderCount = 0;
                    foreach (var order in FilteredOrders)
                    {
                        if (selectedOrderIds.Contains(order.OrderId))
                        {
                            order.IsSelected = true;
                            restoredFilteredOrderCount++;
                        }
                    }
                }

                // å¼ºåˆ¶é€šçŸ¥é€‰æ‹©çŠ¶æ€å±æ€§æ›´ï¿½?                OnPropertyChanged(nameof(SelectedOrders));
                OnPropertyChanged(nameof(HasSelectedOrders));
                OnPropertyChanged(nameof(SelectedOrderCount));
                OnPropertyChanged(nameof(SelectedPositions));
                OnPropertyChanged(nameof(HasSelectedPositions));
                OnPropertyChanged(nameof(SelectedPositionCount));
                OnPropertyChanged(nameof(HasSelectedStopOrders));
                OnPropertyChanged(nameof(SelectedStopOrderCount));
                
                LogService.LogDebug("ğŸ“¢ é€‰æ‹©çŠ¶æ€å±æ€§é€šçŸ¥å·²å‘ï¿½?);

                // éªŒè¯æœ€ç»ˆçŠ¶ï¿½?                var finalSelectedPositions = Positions.Count(p => p.IsSelected);
                var finalSelectedOrders = FilteredOrders.Count(o => o.IsSelected);
                LogService.LogInfo($"ğŸ¯ æœ€ç»ˆé€‰æ‹©çŠ¶ï¿½? æŒä»“{finalSelectedPositions}ï¿½? è®¢å•{finalSelectedOrders}ï¿½?);

                StatusMessage = $"æ•°æ®åˆ·æ–°å®Œæˆ - {DateTime.Now:HH:mm:ss}";
                LogService.LogSuccess("ğŸ”„ æ‰‹åŠ¨åˆ·æ–°å®Œæˆ");
            }
            catch (Exception ex)
            {
                StatusMessage = $"åˆ·æ–°å¤±è´¥: {ex.Message}";
                LogService.LogError("ï¿½?æ‰‹åŠ¨åˆ·æ–°å¼‚å¸¸", ex);
            }
            finally
            {
                IsLoading = false;
            }
        }

        [RelayCommand]
        private void ConfigureAccount()
        {
            var viewModel = new AccountConfigViewModel(_accountService);
            var window = new BinanceFuturesTrader.Views.AccountConfigWindow(viewModel);
            
            window.ShowDialog();
            LoadAccounts();
        }

        [RelayCommand]
        private void EditCurrentAccount()
        {
            if (SelectedAccount == null)
                return;

            var currentAccountName = SelectedAccount.Name;
            var viewModel = new AccountConfigViewModel(_accountService, SelectedAccount);
            var window = new BinanceFuturesTrader.Views.AccountConfigWindow(viewModel);
            
            var result = window.ShowDialog();
            if (result == true)
            {
                LoadAccounts();
                // é‡æ–°é€‰æ‹©ç›¸åŒçš„è´¦æˆ·ï¼ˆå¯èƒ½å·²æ›´æ–°ï¼‰
                var updatedAccount = Accounts.FirstOrDefault(a => a.Name == currentAccountName);
                if (updatedAccount != null)
                {
                    SelectedAccount = updatedAccount;
                    StatusMessage = "è´¦æˆ·ä¿¡æ¯å·²æ›´ï¿½?;
                }
            }
        }

        [RelayCommand]
        private async Task ClosePositionAsync()
        {
            if (SelectedAccount == null || SelectedPosition == null)
                return;

            IsLoading = true;
            StatusMessage = $"å¹³ä»“ {SelectedPosition.Symbol}...";
            try
            {
                var success = await _binanceService.ClosePositionAsync(SelectedPosition.Symbol, SelectedPosition.PositionSideString);
                StatusMessage = success ? $"{SelectedPosition.Symbol} å¹³ä»“å®Œæˆ" : $"{SelectedPosition.Symbol} å¹³ä»“å¤±è´¥";
                
                if (success)
                {
                    await RefreshDataAsync();
                }
            }
            catch (Exception ex)
            {
                StatusMessage = $"å¹³ä»“å¤±è´¥: {ex.Message}";
            }
            finally
            {
                IsLoading = false;
            }
        }

        [RelayCommand]
        private async Task AddBreakEvenStopLossAsync()
        {
            Console.WriteLine($"ğŸ›¡ï¿½?å¼€å§‹æ·»åŠ ä¿æœ¬æ­¢ï¿½?..");
            
            try
            {
                // ç¬¬ä¸€æ­¥ï¼šåŸºæœ¬å‚æ•°æ£€ï¿½?                if (SelectedAccount == null)
                {
                    Console.WriteLine($"ï¿½?æœªé€‰æ‹©è´¦æˆ·");
                    StatusMessage = "è¯·é€‰æ‹©è´¦æˆ·";
                    
                    try
                    {
                        App.Current.Dispatcher.Invoke(() =>
                        {
                            System.Windows.MessageBox.Show(
                                "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäº¤æ˜“è´¦ï¿½?,
                                "æœªé€‰æ‹©è´¦æˆ·",
                                System.Windows.MessageBoxButton.OK,
                                System.Windows.MessageBoxImage.Warning);
                        });
                    }
                    catch (Exception uiEx)
                    {
                        Console.WriteLine($"ï¿½?UIæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å¼‚å¸¸: {uiEx.Message}");
                        StatusMessage = "æœªé€‰æ‹©è´¦æˆ·ï¼Œè¯·é€‰æ‹©äº¤æ˜“è´¦æˆ·";
                    }
                    return;
                }

                if (SelectedPosition == null)
                {
                    Console.WriteLine($"ï¿½?æœªé€‰æ‹©æŒä»“");
                    StatusMessage = "è¯·é€‰æ‹©æŒä»“";
                    
                    try
                    {
                        App.Current.Dispatcher.Invoke(() =>
                        {
                            System.Windows.MessageBox.Show(
                                "è¯·å…ˆåœ¨æŒä»“åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæŒï¿½?,
                                "æœªé€‰æ‹©æŒä»“",
                                System.Windows.MessageBoxButton.OK,
                                System.Windows.MessageBoxImage.Warning);
                        });
                    }
                    catch (Exception uiEx)
                    {
                        Console.WriteLine($"ï¿½?UIæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å¼‚å¸¸: {uiEx.Message}");
                        StatusMessage = "æœªé€‰æ‹©æŒä»“ï¼Œè¯·åœ¨æŒä»“åˆ—è¡¨ä¸­é€‰æ‹©æŒä»“";
                    }
                    return;
                }

                Console.WriteLine($"ğŸ“Š æ£€æŸ¥æŒä»“ä¿¡ï¿½? {SelectedPosition.Symbol}, æ•°é‡: {SelectedPosition.PositionAmt}, å¼€ä»“ä»·: {SelectedPosition.EntryPrice}");

                // ç¬¬äºŒæ­¥ï¼šæŒä»“æ•°æ®æœ‰æ•ˆæ€§æ£€ï¿½?                if (Math.Abs(SelectedPosition.PositionAmt) <= 0)
                {
                    Console.WriteLine($"ï¿½?æŒä»“æ•°é‡ï¿½?");
                    StatusMessage = "é€‰ä¸­çš„æŒä»“æ•°é‡ä¸º0ï¼Œæ— æ³•è®¾ç½®æ­¢ï¿½?;
                    
                    try
                    {
                        App.Current.Dispatcher.Invoke(() =>
                        {
                            System.Windows.MessageBox.Show(
                                $"é€‰ä¸­çš„æŒï¿½?{SelectedPosition.Symbol} æ•°é‡ï¿½?ï¼Œæ— æ³•è®¾ç½®ä¿æœ¬æ­¢ï¿½?,
                                "æŒä»“æ•°é‡æ— æ•ˆ",
                                System.Windows.MessageBoxButton.OK,
                                System.Windows.MessageBoxImage.Warning);
                        });
                    }
                    catch (Exception uiEx)
                    {
                        Console.WriteLine($"ï¿½?UIæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å¼‚å¸¸: {uiEx.Message}");
                    }
                    return;
                }

                if (SelectedPosition.EntryPrice <= 0)
                {
                    Console.WriteLine($"ï¿½?å¼€ä»“ä»·æ— æ•ˆ: {SelectedPosition.EntryPrice}");
                    StatusMessage = "æŒä»“å¼€ä»“ä»·æ— æ•ˆï¼Œæ— æ³•è®¾ç½®ä¿æœ¬æ­¢ï¿½?;
                    
                    try
                    {
                        App.Current.Dispatcher.Invoke(() =>
                        {
                            System.Windows.MessageBox.Show(
                                $"æŒä»“ {SelectedPosition.Symbol} çš„å¼€ä»“ä»·æ— æ•ˆï¼ˆ{SelectedPosition.EntryPrice}ï¼‰ï¼Œæ— æ³•è®¾ç½®ä¿æœ¬æ­¢æŸ",
                                "å¼€ä»“ä»·æ— æ•ˆ",
                                System.Windows.MessageBoxButton.OK,
                                System.Windows.MessageBoxImage.Warning);
                        });
                    }
                    catch (Exception uiEx)
                    {
                        Console.WriteLine($"ï¿½?UIæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å¼‚å¸¸: {uiEx.Message}");
                    }
                    return;
                }

                // ç¬¬ä¸‰æ­¥ï¼šè®¡ç®—æ­¢æŸå‚æ•°
                string formattedEntryPrice;
                string positionDirection;
                string stopDirection;
                
                try
                {
                    formattedEntryPrice = PriceFormatConverter.FormatPrice(SelectedPosition.EntryPrice);
                    positionDirection = SelectedPosition.PositionAmt > 0 ? "åšå¤š" : "åšç©º";
                    stopDirection = SelectedPosition.PositionAmt > 0 ? "å–å‡º" : "ä¹°å…¥";
                    
                    Console.WriteLine($"ğŸ“ æ­¢æŸå‚æ•°: å¼€ä»“ä»·={formattedEntryPrice}, æŒä»“æ–¹å‘={positionDirection}, æ­¢æŸæ–¹å‘={stopDirection}");
                }
                catch (Exception calcEx)
                {
                    Console.WriteLine($"ï¿½?è®¡ç®—æ­¢æŸå‚æ•°å¼‚å¸¸: {calcEx.Message}");
                    StatusMessage = "è®¡ç®—æ­¢æŸå‚æ•°å¤±è´¥";
                    
                    try
                    {
                        App.Current.Dispatcher.Invoke(() =>
                        {
                            System.Windows.MessageBox.Show(
                                $"è®¡ç®—æ­¢æŸå‚æ•°æ—¶å‘ç”Ÿå¼‚å¸¸ï¼š{calcEx.Message}",
                                "è®¡ç®—å¼‚å¸¸",
                                System.Windows.MessageBoxButton.OK,
                                System.Windows.MessageBoxImage.Error);
                        });
                    }
                    catch (Exception uiEx)
                    {
                        Console.WriteLine($"ï¿½?UIæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å¼‚å¸¸: {uiEx.Message}");
                        StatusMessage = $"è®¡ç®—å¼‚å¸¸: {calcEx.Message}";
                    }
                    return;
                }

                // ç¬¬å››æ­¥ï¼šæ˜¾ç¤ºç¡®è®¤å¯¹è¯ï¿½?                System.Windows.MessageBoxResult result;
                try
                {
                    Console.WriteLine($"ğŸ”” æ˜¾ç¤ºç¡®è®¤å¯¹è¯ï¿½?..");
                    
                    result = await App.Current.Dispatcher.InvokeAsync(() =>
                    {
                        return System.Windows.MessageBox.Show(
                            $"ç¡®å®šè¦ä¸ºä»¥ä¸‹æŒä»“æ·»åŠ ä¿æœ¬æ­¢æŸå•å—ï¼Ÿ\n\n" +
                            $"åˆçº¦ï¼š{SelectedPosition.Symbol}\n" +
                            $"æŒä»“æ–¹å‘ï¼š{positionDirection}\n" +
                            $"æŒä»“æ•°é‡ï¼š{Math.Abs(SelectedPosition.PositionAmt):F6}\n" +
                            $"å¼€ä»“ä»·ï¼š{formattedEntryPrice}\n\n" +
                            $"å°†ä¸‹{stopDirection}å¸‚ä»·æ­¢æŸå•ï¼š\n" +
                            $"è§¦å‘ä»·ï¼š{formattedEntryPrice}ï¼ˆä¿æœ¬ä»·ï¼‰\n" +
                            $"æ•°é‡ï¼š{Math.Abs(SelectedPosition.PositionAmt):F6}",
                            "ä¿æœ¬æ­¢æŸç¡®è®¤",
                            System.Windows.MessageBoxButton.YesNo,
                            System.Windows.MessageBoxImage.Question);
                    });
                    
                    Console.WriteLine($"ï¿½?ç”¨æˆ·é€‰æ‹©: {result}");
                }
                catch (Exception dialogEx)
                {
                    Console.WriteLine($"ï¿½?æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†å¼‚ï¿½? {dialogEx.Message}");
                    StatusMessage = "æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†å¤±ï¿½?;
                    
                    try
                    {
                        App.Current.Dispatcher.Invoke(() =>
                        {
                            System.Windows.MessageBox.Show(
                                $"æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†æ—¶å‘ç”Ÿå¼‚å¸¸ï¼š{dialogEx.Message}",
                                "ç•Œé¢å¼‚å¸¸",
                                System.Windows.MessageBoxButton.OK,
                                System.Windows.MessageBoxImage.Error);
                        });
                    }
                    catch (Exception uiEx)
                    {
                        Console.WriteLine($"ï¿½?UIæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å¼‚å¸¸: {uiEx.Message}");
                        StatusMessage = $"ç•Œé¢å¼‚å¸¸: {dialogEx.Message}";
                    }
                    return;
                }

                if (result != System.Windows.MessageBoxResult.Yes)
                {
                    Console.WriteLine($"ğŸš« ç”¨æˆ·å–æ¶ˆæ“ä½œ");
                    StatusMessage = "ç”¨æˆ·å–æ¶ˆäº†ä¿æœ¬æ­¢æŸæ“ï¿½?;
                    return;
                }

                // ç¬¬äº”æ­¥ï¼šæ‰§è¡Œä¸‹å•æ“ä½œ
                IsLoading = true;
                StatusMessage = $"ï¿½?{SelectedPosition.Symbol} æ·»åŠ ä¿æœ¬æ­¢æŸï¿½?..";
                Console.WriteLine($"ğŸš€ å¼€å§‹æ‰§è¡Œä¿æœ¬æ­¢æŸä¸‹ï¿½?..");
                
                try
                {
                    // æ„å»ºä¿æœ¬æ­¢æŸï¿½?                    var stopLossOrder = new OrderRequest
                    {
                        Symbol = SelectedPosition.Symbol,
                        Side = SelectedPosition.PositionAmt > 0 ? "SELL" : "BUY", // åå‘æ“ä½œ
                        PositionSide = SelectedPosition.PositionSideString,
                        Type = "STOP_MARKET", // å¸‚ä»·æ­¢æŸï¿½?                        Quantity = Math.Abs(SelectedPosition.PositionAmt), // ç›¸åŒæ•°é‡
                        StopPrice = SelectedPosition.EntryPrice, // è§¦å‘ï¿½?å¼€ä»“ä»·
                        ReduceOnly = true, // åªå‡ï¿½?                        Leverage = SelectedPosition.Leverage,
                        MarginType = SelectedPosition.MarginType,
                        WorkingType = "CONTRACT_PRICE" // ä½¿ç”¨åˆçº¦ä»·æ ¼è§¦å‘
                    };

                    Console.WriteLine($"ğŸ“‹ æ­¢æŸå•è¯¦ï¿½? {stopLossOrder.Side} {stopLossOrder.Quantity:F6} {stopLossOrder.Symbol} @ {formattedEntryPrice}");

                    var success = await _binanceService.PlaceOrderAsync(stopLossOrder);

                    if (success)
                    {
                        StatusMessage = $"ä¿æœ¬æ­¢æŸå•ä¸‹å•æˆåŠŸï¼š{SelectedPosition.Symbol} @ {formattedEntryPrice}";
                        Console.WriteLine($"ï¿½?ä¿æœ¬æ­¢æŸå•ä¸‹å•æˆï¿½?);
                        
                        try
                        {
                            App.Current.Dispatcher.Invoke(() =>
                            {
                                System.Windows.MessageBox.Show(
                                    $"ä¿æœ¬æ­¢æŸå•ä¸‹å•æˆåŠŸï¼\n\n" +
                                    $"ï¿½?{stopDirection}æ­¢æŸå•ï¼š{stopLossOrder.Quantity:F6} {SelectedPosition.Symbol}\n" +
                                    $"ğŸ“Š è§¦å‘ä»·ï¼š{formattedEntryPrice}ï¼ˆä¿æœ¬ä»·ï¼‰\n" +
                                    $"ğŸ¯ å½“ä»·æ ¼{(SelectedPosition.PositionAmt > 0 ? "è·Œè‡³" : "æ¶¨è‡³")}å¼€ä»“ä»·æ—¶è‡ªåŠ¨å¹³ï¿½?,
                                    "ä¿æœ¬æ­¢æŸæˆåŠŸ",
                                    System.Windows.MessageBoxButton.OK,
                                    System.Windows.MessageBoxImage.Information);
                            });
                        }
                        catch (Exception uiEx)
                        {
                            Console.WriteLine($"ï¿½?æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¼‚å¸¸: {uiEx.Message}");
                        }

                        // åˆ·æ–°æ•°æ®ä»¥æ˜¾ç¤ºæ–°çš„å§”æ‰˜å•
                        try
                        {
                            Console.WriteLine("ğŸ”„ ä¿æœ¬æ­¢æŸæˆåŠŸï¼Œå¼€å§‹åˆ·æ–°æ•°æ®ä»¥æ˜¾ç¤ºæ–°è®¢ï¿½?..");
                            await RefreshDataAsync();
                            
                            // éªŒè¯æ­¢æŸå•æ˜¯å¦æ­£ç¡®æ˜¾ï¿½?                            Console.WriteLine("ğŸ” éªŒè¯æ­¢æŸå•æ˜¯å¦å·²æ˜¾ç¤ºåœ¨å§”æ‰˜åˆ—è¡¨ä¸­...");
                            var stopMarketOrders = Orders.Where(o => o.Type == "STOP_MARKET").ToList();
                            Console.WriteLine($"ğŸ“Š å½“å‰STOP_MARKETè®¢å•æ€»æ•°: {stopMarketOrders.Count}");
                            
                            var currentSymbolStopOrders = Orders.Where(o => 
                                o.Type == "STOP_MARKET" && 
                                o.Symbol == SelectedPosition.Symbol &&
                                Math.Abs(o.StopPrice - SelectedPosition.EntryPrice) < 0.01m
                            ).ToList();
                            
                            Console.WriteLine($"ğŸ¯ å½“å‰åˆçº¦ {SelectedPosition.Symbol} çš„ä¿æœ¬æ­¢æŸå•æ•°é‡: {currentSymbolStopOrders.Count}");
                            
                            if (currentSymbolStopOrders.Any())
                            {
                                Console.WriteLine("ï¿½?æ­¢æŸå•å·²æ­£ç¡®æ˜¾ç¤ºåœ¨å§”æ‰˜åˆ—è¡¨ä¸­");
                                foreach (var stopOrder in currentSymbolStopOrders)
                                {
                                    Console.WriteLine($"ğŸ“‹ æ­¢æŸå•è¯¦ï¿½? OrderId={stopOrder.OrderId}, StopPrice={stopOrder.StopPrice}, Status={stopOrder.Status}");
                                }
                            }
                            else
                            {
                                Console.WriteLine("ï¿½?è­¦å‘Š: æ­¢æŸå•æœªåœ¨å§”æ‰˜åˆ—è¡¨ä¸­æ‰¾åˆ°ï¼Œå¯èƒ½å­˜åœ¨ä»¥ä¸‹åŸï¿½?");
                                Console.WriteLine("   1. APIå»¶è¿Ÿï¼Œè®¢å•è¿˜æœªåœ¨openOrdersæ¥å£è¿”å›");
                                Console.WriteLine("   2. è®¢å•å¯èƒ½å·²è§¦å‘æˆ–çŠ¶æ€å˜ï¿½?);
                                Console.WriteLine("   3. è®¢å•åœ¨å…¶ä»–ç±»å‹åˆ—è¡¨ä¸­");
                                
                                // ç­‰å¾…2ç§’åå†æ¬¡å°è¯•
                                Console.WriteLine("ï¿½?ç­‰å¾…2ç§’åå†æ¬¡æŸ¥è¯¢...");
                                await Task.Delay(2000);
                                await RefreshDataAsync();
                                
                                var stopMarketOrders2 = Orders.Where(o => o.Type == "STOP_MARKET").ToList();
                                Console.WriteLine($"ğŸ“Š äºŒæ¬¡æŸ¥è¯¢STOP_MARKETè®¢å•æ€»æ•°: {stopMarketOrders2.Count}");
                            }
                        }
                        catch (Exception refreshEx)
                        {
                            Console.WriteLine($"ï¿½?åˆ·æ–°æ•°æ®å¼‚å¸¸: {refreshEx.Message}");
                            StatusMessage = "ä¿æœ¬æ­¢æŸæˆåŠŸï¼Œä½†åˆ·æ–°æ•°æ®å¤±è´¥";
                        }
                    }
                    else
                    {
                        StatusMessage = $"ä¿æœ¬æ­¢æŸå•ä¸‹å•å¤±è´¥ï¼š{SelectedPosition.Symbol}";
                        Console.WriteLine($"ï¿½?ä¿æœ¬æ­¢æŸå•ä¸‹å•å¤±ï¿½?);
                        
                        try
                        {
                            App.Current.Dispatcher.Invoke(() =>
                            {
                                System.Windows.MessageBox.Show(
                                    $"ä¿æœ¬æ­¢æŸå•ä¸‹å•å¤±è´¥ï¼\n\nï¿½?{SelectedPosition.Symbol}\n\nè¯·æ£€æŸ¥è´¦æˆ·çŠ¶æ€å’Œç½‘ç»œè¿æ¥",
                                    "ä¸‹å•å¤±è´¥",
                                    System.Windows.MessageBoxButton.OK,
                                    System.Windows.MessageBoxImage.Error);
                            });
                        }
                        catch (Exception uiEx)
                        {
                            Console.WriteLine($"ï¿½?æ˜¾ç¤ºå¤±è´¥æ¶ˆæ¯å¼‚å¸¸: {uiEx.Message}");
                        }
                    }
                }
                catch (Exception orderEx)
                {
                    StatusMessage = $"ä¿æœ¬æ­¢æŸå•ä¸‹å•å¼‚ï¿½? {orderEx.Message}";
                    Console.WriteLine($"ï¿½?ä¿æœ¬æ­¢æŸå•ä¸‹å•å¼‚ï¿½? {orderEx.Message}");
                    Console.WriteLine($"ï¿½?å¼‚å¸¸å †æ ˆ: {orderEx.StackTrace}");
                    
                    try
                    {
                        App.Current.Dispatcher.Invoke(() =>
                        {
                            System.Windows.MessageBox.Show(
                                $"ä¿æœ¬æ­¢æŸå•ä¸‹å•å¼‚å¸¸ï¼š\n\n{orderEx.Message}\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯",
                                "ä¸‹å•å¼‚å¸¸",
                                System.Windows.MessageBoxButton.OK,
                                System.Windows.MessageBoxImage.Error);
                        });
                    }
                    catch (Exception uiEx)
                    {
                        Console.WriteLine($"ï¿½?æ˜¾ç¤ºå¼‚å¸¸æ¶ˆæ¯å¼‚å¸¸: {uiEx.Message}");
                        StatusMessage = $"ä¸‹å•å¼‚å¸¸: {orderEx.Message}";
                    }
                }
            }
            catch (Exception ex)
            {
                StatusMessage = $"ä¿æœ¬æ­¢æŸåŠŸèƒ½å¼‚å¸¸: {ex.Message}";
                Console.WriteLine($"ï¿½?ä¿æœ¬æ­¢æŸåŠŸèƒ½é¡¶å±‚å¼‚å¸¸: {ex.Message}");
                Console.WriteLine($"ï¿½?å¼‚å¸¸ç±»å‹: {ex.GetType().Name}");
                Console.WriteLine($"ï¿½?å¼‚å¸¸å †æ ˆ: {ex.StackTrace}");
                
                try
                {
                    App.Current.Dispatcher.Invoke(() =>
                    {
                        System.Windows.MessageBox.Show(
                            $"ä¿æœ¬æ­¢æŸåŠŸèƒ½å‘ç”Ÿæœªé¢„æœŸçš„å¼‚å¸¸ï¼š\n\n" +
                            $"ç±»å‹ï¼š{ex.GetType().Name}\n" +
                            $"æ¶ˆæ¯ï¼š{ex.Message}\n\n" +
                            $"è¯·è”ç³»æŠ€æœ¯æ”¯æŒå¹¶æä¾›æ§åˆ¶å°æ—¥ï¿½?,
                            "ç³»ç»Ÿå¼‚å¸¸",
                            System.Windows.MessageBoxButton.OK,
                            System.Windows.MessageBoxImage.Error);
                    });
                }
                catch (Exception uiEx)
                {
                    Console.WriteLine($"ï¿½?æ˜¾ç¤ºç³»ç»Ÿå¼‚å¸¸æ¶ˆæ¯å¼‚å¸¸: {uiEx.Message}");
                    StatusMessage = $"ç³»ç»Ÿå¼‚å¸¸: {ex.Message}";
                }
            }
            finally
            {
                IsLoading = false;
                Console.WriteLine($"ğŸ ä¿æœ¬æ­¢æŸæ“ä½œå®Œæˆ");
            }
        }

        [RelayCommand]
        private async Task CancelAllOrdersAsync()
        {
            if (SelectedAccount == null)
                return;

            IsLoading = true;
            StatusMessage = "æ¸…ç†å§”æ‰˜ï¿½?..";
            try
            {
                var success = await _binanceService.CancelAllOrdersAsync();
                StatusMessage = success ? "å§”æ‰˜å•æ¸…ç†å®Œï¿½? : "å§”æ‰˜å•æ¸…ç†å¤±ï¿½?;
                
                if (success)
                {
                    await RefreshDataAsync();
                }
            }
            catch (Exception ex)
            {
                StatusMessage = $"æ¸…ç†å§”æ‰˜å•å¤±ï¿½? {ex.Message}";
            }
            finally
            {
                IsLoading = false;
            }
        }

        [RelayCommand]
        private void CalculateMaxRiskCapital()
        {
            if (AccountInfo == null || SelectedAccount == null)
                return;

            var availableRiskCapital = AccountInfo.AvailableRiskCapital(SelectedAccount.RiskCapitalTimes);
            
            // å‘ä¸Šå–æ•´ï¼Œä¿ç•™æ•´æ•°ï¼Œåªå¡«å†™æ­¢æŸé‡‘ï¿½?            StopLossAmount = Math.Ceiling(availableRiskCapital);
            
            StatusMessage = $"å·²è®¾ç½®æœ€å¤§é£é™©é‡‘: {StopLossAmount:F0} USDT (å‘ä¸Šå–æ•´)";
            Console.WriteLine($"ğŸ’° æœ€å¤§é£é™©é‡‘è®¾ç½®: {StopLossAmount:F0} USDT");
        }

        [RelayCommand]
        private async Task CalculateQuantityFromLossAsync()
        {
            if (LatestPrice <= 0)
            {
                StatusMessage = "è¯·å…ˆè·å–æœ€æ–°ä»·ï¿½?;
                return;
            }

            if (StopLossRatio <= 0)
            {
                StatusMessage = "è¯·è®¾ç½®æ­¢æŸæ¯”ï¿½?;
                return;
            }

            if (StopLossAmount <= 0)
            {
                StatusMessage = "è¯·è®¾ç½®æ­¢æŸé‡‘ï¿½?;
                return;
            }

            try
            {
                // æ­£ç¡®çš„æœŸï¿½?ä»¥æŸå®šé‡"è®¡ç®—å…¬å¼ï¿½?                // æ–¹æ³•1ï¼šæ•°ï¿½?= æ­¢æŸé‡‘é¢ / (å½“å‰ä»·æ ¼ Ã— æ­¢æŸæ¯”ä¾‹)
                // æ–¹æ³•2ï¼šè´§ï¿½?= æ­¢æŸé‡‘é¢ / æ­¢æŸæ¯”ä¾‹ï¼Œæ•°ï¿½?= è´§ï¿½?/ å½“å‰ä»·æ ¼
                
                Console.WriteLine($"ğŸ§® ä»¥æŸå®šé‡è®¡ç®—å¼€ï¿½?");
                Console.WriteLine($"ğŸ“Š è¾“å…¥å‚æ•°: ä»·æ ¼={LatestPrice:F8}, æ­¢æŸé‡‘é¢={StopLossAmount:F2}, æ­¢æŸæ¯”ä¾‹={StopLossRatio:F2}%");
                
                var stopLossDecimal = StopLossRatio / 100; // å°†ç™¾åˆ†æ¯”è½¬ä¸ºå°æ•°
                Console.WriteLine($"ğŸ’± æ­¢æŸæ¯”ä¾‹(å°æ•°): {stopLossDecimal:F6}");
                
                // ä½¿ç”¨ç”¨æˆ·æœŸæœ›çš„è®¡ç®—æ–¹å¼ï¼šè´§ï¿½?= æ­¢æŸé‡‘é¢ / æ­¢æŸæ¯”ä¾‹
                var notionalValue = StopLossAmount / stopLossDecimal;
                Console.WriteLine($"ğŸ’° è®¡ç®—è´§ï¿½? {StopLossAmount:F2} Ã· {stopLossDecimal:F6} = {notionalValue:F2}");
                
                // æ•°é‡ = è´§ï¿½?/ ä»·æ ¼
                var calculatedQuantity = notionalValue / LatestPrice;
                Console.WriteLine($"ğŸ“¦ è®¡ç®—æ•°é‡: {notionalValue:F2} Ã· {LatestPrice:F8} = {calculatedQuantity:F8}");
                
                // éªŒè¯è®¡ç®—ï¼ˆæ–¹ï¿½?ï¿½?                var priceChange = LatestPrice * stopLossDecimal;
                var verifyQuantity = StopLossAmount / priceChange;
                Console.WriteLine($"ï¿½?éªŒè¯è®¡ç®—: {StopLossAmount:F2} Ã· ({LatestPrice:F8} Ã— {stopLossDecimal:F6}) = {StopLossAmount:F2} Ã· {priceChange:F8} = {verifyQuantity:F8}");
                
                if (Math.Abs(calculatedQuantity - verifyQuantity) > 0.000001m)
                {
                    Console.WriteLine($"âš ï¸ è­¦å‘Šï¼šä¸¤ç§è®¡ç®—æ–¹æ³•ç»“æœä¸ä¸€è‡´ï¼");
                }
                
                // è·å–è¯¥åˆçº¦çš„äº¤æ˜“é™åˆ¶
                var (minQuantity, maxQuantity, maxLeverage, maxNotional, estimatedPrice) = await GetSymbolLimitsAsync(Symbol);
                Console.WriteLine($"ğŸ“ {Symbol} é™åˆ¶: æœ€ï¿½?{minQuantity}, æœ€ï¿½?{maxQuantity}");
                
                // æ ¹æ®åˆçº¦ç²¾åº¦è°ƒæ•´æ•°é‡
                Console.WriteLine($"ğŸ”§ ç²¾åº¦è°ƒæ•´ï¿½? {calculatedQuantity:F8}");
                var adjustedQuantity = await AdjustQuantityPrecisionAsync(calculatedQuantity, Symbol, minQuantity, maxQuantity);
                Console.WriteLine($"ğŸ”§ ç²¾åº¦è°ƒæ•´ï¿½? {adjustedQuantity:F8}");
                
                Quantity = adjustedQuantity;
                
                // éªŒç®—ï¼šè®¡ç®—å®é™…æ­¢æŸé‡‘ï¿½?                var actualLoss = adjustedQuantity * LatestPrice * stopLossDecimal;
                Console.WriteLine($"ğŸ§¾ éªŒç®—å®é™…æ­¢æŸ: {adjustedQuantity:F8} Ã— {LatestPrice:F8} Ã— {stopLossDecimal:F6} = {actualLoss:F2} USDT");
                
                StatusMessage = $"å·²è®¡ç®—æ•°ï¿½? {Quantity:F8} (ç›®æ ‡æ­¢æŸ{StopLossAmount:F2}U, å®é™…{actualLoss:F2}U, æ¯”ä¾‹{StopLossRatio}%)";
                Console.WriteLine($"ğŸ”§ ä»¥æŸå®šé‡å®Œæˆ: æ•°é‡={Quantity:F8}");
            }
            catch (Exception ex)
            {
                StatusMessage = $"è®¡ç®—æ•°é‡å¤±è´¥: {ex.Message}";
                Console.WriteLine($"ğŸ”§ ä»¥æŸå®šé‡è®¡ç®—å¼‚å¸¸: {ex.Message}");
            }
        }
        
        private async Task<decimal> AdjustQuantityPrecisionAsync(decimal quantity, string symbol, decimal minQuantity, decimal maxQuantity)
        {
            Console.WriteLine($"ğŸ”§ å¼€å§‹ç²¾åº¦è°ƒï¿½? åŸå§‹æ•°é‡={quantity:F8}");
            
            try
            {
                // è·å–çœŸå®çš„äº¤æ˜“è§„åˆ™ï¼Œç‰¹åˆ«æ˜¯stepSize
                var realExchangeInfo = await _binanceService.GetRealExchangeInfoAsync(symbol);
                var stepSize = realExchangeInfo.stepSize;
                
                Console.WriteLine($"ğŸ“ {symbol} çš„stepSize: {stepSize}");
                
                // 1. é¦–å…ˆæ£€æŸ¥æœ€å°æ•°é‡é™ï¿½?                if (quantity < minQuantity)
                {
                    Console.WriteLine($"âš ï¸ æ•°é‡ {quantity:F8} å°äºæœ€å°é™ï¿½?{minQuantity}ï¼Œè°ƒæ•´ä¸ºæœ€å°ï¿½?);
                    quantity = minQuantity;
                }
                
                // 2. æ ¹æ®stepSizeè°ƒæ•´ç²¾åº¦
                if (stepSize > 0)
                {
                    // ç¡®ä¿æ•°é‡æ˜¯stepSizeçš„æ•´æ•°ï¿½?                    var steps = Math.Floor(quantity / stepSize);
                    var adjustedQuantity = steps * stepSize;
                    
                    Console.WriteLine($"ğŸ“Š stepSizeè°ƒæ•´: {quantity:F8} ï¿½?{steps} Ã— {stepSize} = {adjustedQuantity:F8}");
                    
                    // å¦‚æœè°ƒæ•´åçš„æ•°é‡å¤ªå°ï¼Œå¢åŠ ä¸€ä¸ªstepSize
                    if (adjustedQuantity < minQuantity && (adjustedQuantity + stepSize) <= maxQuantity)
                    {
                        adjustedQuantity += stepSize;
                        Console.WriteLine($"ğŸ’¡ å¢åŠ ä¸€ä¸ªstepSize: {adjustedQuantity:F8}");
                    }
                    
                    quantity = adjustedQuantity;
                }
                else
                {
                    Console.WriteLine($"âš ï¸ stepSizeæ— æ•ˆï¼Œä½¿ç”¨ä¼ ç»Ÿç²¾åº¦è°ƒï¿½?);
                    // å¦‚æœAPIæ²¡æœ‰è¿”å›æœ‰æ•ˆstepSizeï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹ï¿½?                    quantity = AdjustQuantityPrecisionTraditional(quantity, symbol);
                }
                
                // 3. å†æ¬¡æ£€æŸ¥æœ€å¤§æ•°é‡é™ï¿½?                if (quantity > maxQuantity)
                {
                    Console.WriteLine($"âš ï¸ æ•°é‡ {quantity:F8} è¶…è¿‡æœ€å¤§é™ï¿½?{maxQuantity}ï¼Œè°ƒæ•´ä¸ºæœ€å¤§ï¿½?);
                    quantity = maxQuantity;
                    
                    // ç¡®ä¿æœ€å¤§å€¼ä¹Ÿç¬¦åˆstepSize
                    if (stepSize > 0)
                    {
                        var steps = Math.Floor(quantity / stepSize);
                        quantity = steps * stepSize;
                        Console.WriteLine($"ğŸ“Š æœ€å¤§å€¼stepSizeè°ƒæ•´: {quantity:F8}");
                    }
                }
                
                // 4. æœ€åæ£€æŸ¥è°ƒæ•´åæ˜¯å¦æ»¡è¶³æœ€å°æ•°é‡è¦ï¿½?                if (quantity < minQuantity)
                {
                    Console.WriteLine($"ğŸ”§ æœ€ç»ˆæ•°?{quantity:F8} ä»å°äºæœ€å°é™åˆ¶ï¼Œæ— æ³•æ»¡è¶³äº¤æ˜“è¦æ±‚");
                    quantity = minQuantity;
                }
                
                Console.WriteLine($"ğŸ”§ æ•°é‡ç²¾åº¦è°ƒæ•´å®Œæˆ: {quantity:F8}");
                return quantity;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ğŸ”§ APIç²¾åº¦è°ƒæ•´å¤±è´¥: {ex.Message}ï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹?);
                // APIå¤±è´¥æ—¶ä½¿ç”¨ä¼ ç»Ÿæ–¹?                return AdjustQuantityPrecisionTraditional(quantity, symbol);
            }
        }
        
        private decimal AdjustQuantityPrecisionTraditional(decimal quantity, string symbol)
        {
            // ä¼ ç»Ÿçš„åŸºäºåˆçº¦ç±»å‹çš„ç²¾åº¦è°ƒæ•´
            var adjustedQuantity = symbol.ToUpper() switch
            {
                "BTCUSDT" => Math.Round(quantity, 3), // BTC: 3ä½å°ï¿½?                "ETHUSDT" => Math.Round(quantity, 3), // ETH: 3ä½å°ï¿½?                "BNBUSDT" => Math.Round(quantity, 2), // BNB: 2ä½å°ï¿½?                "ADAUSDT" => Math.Round(quantity, 0), // ADA: æ•´æ•°
                "DOGEUSDT" => Math.Round(quantity, 0), // DOGE: æ•´æ•°
                "SOLUSDT" => Math.Round(quantity, 1), // SOL: 1ä½å°ï¿½?                "DOTUSDT" => Math.Round(quantity, 1), // DOT: 1ä½å°ï¿½?                "LINKUSDT" => Math.Round(quantity, 1), // LINK: 1ä½å°ï¿½?                "LTCUSDT" => Math.Round(quantity, 2), // LTC: 2ä½å°ï¿½?                "BCHUSDT" => Math.Round(quantity, 3), // BCH: 3ä½å°ï¿½?                "XRPUSDT" => Math.Round(quantity, 0), // XRP: æ•´æ•°
                "MATICUSDT" => Math.Round(quantity, 0), // MATIC: æ•´æ•°
                "AVAXUSDT" => Math.Round(quantity, 1), // AVAX: 1ä½å°ï¿½?                "UNIUSDT" => Math.Round(quantity, 1), // UNI: 1ä½å°ï¿½?                "ATOMUSDT" => Math.Round(quantity, 1), // ATOM: 1ä½å°ï¿½?                _ => Math.Round(quantity, 3) // é»˜è®¤: 3ä½å°ï¿½?            };
            
            Console.WriteLine($"ğŸ”§ ä¼ ç»Ÿç²¾åº¦è°ƒæ•´: {quantity:F8} ğŸ”§ {adjustedQuantity:F8}");
            return adjustedQuantity;
        }
        
        private async Task<(decimal minQuantity, decimal maxQuantity, int maxLeverage, decimal maxNotional, decimal estimatedPrice)> GetSymbolLimitsAsync(string symbol)
        {
            try
            {
                // è·å–çœŸå®çš„äº¤æ˜“è§„åˆ™ä¿¡ï¿½?                var (minQuantity, maxQuantity, maxLeverage, maxNotional, estimatedPrice) = await GetExchangeInfoAsync(symbol);
                return (minQuantity, maxQuantity, maxLeverage, maxNotional, estimatedPrice);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ğŸ”§ è·å– {symbol} äº¤æ˜“è§„åˆ™å¼‚å¸¸: {ex.Message}");
                // å¼‚å¸¸æ—¶ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„å¤‡é€‰æ–¹?                return GetDynamicLimits(LatestPrice);
            }
        }
        
        private (decimal minQuantity, decimal maxQuantity, int maxLeverage, decimal maxNotional, decimal estimatedPrice) GetDynamicLimits(decimal currentPrice)
        {
            // æ ¹æ®ä»·æ ¼åŠ¨æ€è®¡ç®—åˆç†çš„æ•°é‡é™åˆ¶
            decimal minQuantity, maxQuantity;
            int maxLeverage;
            decimal maxNotional;
            
            if (currentPrice >= 1000m) // é«˜ä»·å¸ï¼ˆå¦‚BTCï¿½?            {
                minQuantity = 0.001m;
                maxQuantity = 1000m;
                maxLeverage = 125;
                maxNotional = 2000000m;
            }
            else if (currentPrice >= 100m) // ä¸­é«˜ä»·å¸ï¼ˆå¦‚ETHï¿½?            {
                minQuantity = 0.001m;
                maxQuantity = 10000m;
                maxLeverage = 100;
                maxNotional = 1000000m;
            }
            else if (currentPrice >= 10m) // ä¸­ä»·å¸ï¼ˆå¦‚BNBï¿½?            {
                minQuantity = 0.01m;
                maxQuantity = 100000m;
                maxLeverage = 75;
                maxNotional = 500000m;
            }
            else if (currentPrice >= 1m) // ä¸€èˆ¬ä»·å¸ï¼ˆå¦‚DOTï¿½?            {
                minQuantity = 0.1m;
                maxQuantity = 1000000m;
                maxLeverage = 75;
                maxNotional = 200000m;
            }
            else if (currentPrice >= 0.1m) // ä½ä»·å¸ï¼ˆå¦‚ADAï¿½?            {
                minQuantity = 1m;
                maxQuantity = 10000000m;  // ä½¿ç”¨æ›´å¤§çš„æœ€å¤§å€¼ä»¥é€‚åº”çœŸå®äº¤æ˜“éœ€?                maxLeverage = 75;
                maxNotional = 100000m;
            }
            else if (currentPrice >= 0.01m) // å¾ˆä½ä»·å¸ï¼ˆå¦‚DOGE?            {
                minQuantity = 10m;
                maxQuantity = 100000000m;
                maxLeverage = 50;
                maxNotional = 100000m;
            }
            else // è¶…ä½ä»·å¸ï¼ˆå¦‚PEPEã€SHIBç­‰ï¼‰
            {
                minQuantity = 1000m;
                maxQuantity = 10000000000m;  // è¶…ä½ä»·å¸éœ€è¦æå¤§çš„æ•°é‡
                maxLeverage = 25;
                maxNotional = 25000m;
            }
            
            Console.WriteLine($"ğŸ¯ åŠ¨æ€é™ï¿½? ä»·æ ¼={currentPrice:F8}, æœ€å°æ•°ï¿½?{minQuantity}, æœ€å¤§æ•°ï¿½?{maxQuantity}");
            
            return (minQuantity, maxQuantity, maxLeverage, maxNotional, currentPrice);
        }

        // æ™ºèƒ½è®¡ç®—æ­¢æŸä»·æ ¼
        [RelayCommand]
        private void CalculateStopLossPrice()
        {
            Console.WriteLine($"ğŸ¯ å¼€å§‹è®¡ç®—æ­¢æŸä»·...");
            Console.WriteLine($"ğŸ“Š å½“å‰å‚æ•°: æœ€æ–°ä»·={PriceFormatConverter.FormatPrice(LatestPrice)}, æ­¢æŸæ¯”ä¾‹={StopLossRatio:F2}%, äº¤æ˜“æ–¹å‘={Side}");
            
            // è¯¦ç»†è°ƒè¯•Sideå±ï¿½?            Console.WriteLine($"ğŸ” Sideå±æ€§è°ƒè¯•ä¿¡ï¿½?");
            Console.WriteLine($"   Sideï¿½? '{Side}'");
            Console.WriteLine($"   Sideç±»å‹: {Side?.GetType()?.Name ?? "null"}");
            Console.WriteLine($"   Sideé•¿åº¦: {Side?.Length ?? 0}");
            Console.WriteLine($"   Sideæ˜¯å¦ä¸ºnull: {Side == null}");
            Console.WriteLine($"   Sideæ˜¯å¦ä¸ºç©º: {string.IsNullOrEmpty(Side)}");
            Console.WriteLine($"   Side == 'BUY': {Side == "BUY"}");
            Console.WriteLine($"   Side == 'SELL': {Side == "SELL"}");
            
            if (LatestPrice <= 0)
            {
                StatusMessage = "è¯·å…ˆè·å–æœ€æ–°ä»·ï¿½?;
                Console.WriteLine($"ğŸ”§ æœ€æ–°ä»·æ ¼æ— ? {LatestPrice}");
                return;
            }

            if (StopLossRatio <= 0)
            {
                StatusMessage = "è¯·è®¾ç½®æ­¢æŸæ¯”ä¾‹ï¼ˆ0.1%-100%ï¿½?;
                Console.WriteLine($"ğŸ”§ æ­¢æŸæ¯”ä¾‹æ— æ•ˆ: {StopLossRatio}");
                return;
            }

            if (StopLossRatio < 0.1m || StopLossRatio > 100m)
            {
                StatusMessage = "æ­¢æŸæ¯”ä¾‹è¶…å‡ºèŒƒå›´ï¼Œè¯·è¾“å…¥0.1-100ä¹‹é—´çš„æ•°ï¿½?;
                Console.WriteLine($"ğŸ”§ æ­¢æŸæ¯”ä¾‹è¶…å‡ºèŒƒå›´: {StopLossRatio:F2}%ï¼ˆæœ‰æ•ˆèŒƒå›´ï¼š0.1%-100%?);
                return;
            }

            if (string.IsNullOrEmpty(Side) || (Side != "BUY" && Side != "SELL"))
            {
                StatusMessage = "è¯·é€‰æ‹©æ­£ç¡®çš„äº¤æ˜“æ–¹ï¿½?BUY/SELL)";
                Console.WriteLine($"ğŸ”§ äº¤æ˜“æ–¹å‘æ— æ•ˆ: '{Side}'");
                return;
            }

            try
            {
                decimal calculatedStopLossPrice = 0;
                
                // æ ¹æ®äº¤æ˜“æ–¹å‘è®¡ç®—æ­¢æŸï¿½?                if (Side == "BUY")
                {
                    // ä¹°å…¥æ—¶ï¼Œæ­¢æŸï¿½?= å½“å‰ï¿½?Ã— (1 - æ­¢æŸæ¯”ä¾‹%)
                    calculatedStopLossPrice = LatestPrice * (1 - StopLossRatio / 100);
                    Console.WriteLine($"ğŸ’° åšå¤šè®¡ç®—: {PriceFormatConverter.FormatPrice(LatestPrice)} Ã— (1 - {StopLossRatio:F2}% / 100) = {PriceFormatConverter.FormatPrice(calculatedStopLossPrice)}");
                }
                else if (Side == "SELL")
                {
                    // å–å‡ºæ—¶ï¼Œæ­¢æŸï¿½?= å½“å‰ï¿½?Ã— (1 + æ­¢æŸæ¯”ä¾‹%)
                    calculatedStopLossPrice = LatestPrice * (1 + StopLossRatio / 100);
                    Console.WriteLine($"ğŸ’° åšç©ºè®¡ç®—: {PriceFormatConverter.FormatPrice(LatestPrice)} Ã— (1 + {StopLossRatio:F2}% / 100) = {PriceFormatConverter.FormatPrice(calculatedStopLossPrice)}");
                }

                // ç¡®ä¿è®¡ç®—ç»“æœæœ‰æ•ˆ
                if (calculatedStopLossPrice <= 0)
                {
                    StatusMessage = "æ­¢æŸä»·è®¡ç®—ç»“æœæ— æ•ˆï¼Œè¯·æ£€æŸ¥å‚ï¿½?;
                    Console.WriteLine($"ğŸ”§ è®¡ç®—ç»“æœæ— æ•ˆ: {calculatedStopLossPrice}");
                    return;
                }

                // è®¾ç½®æ­¢æŸ?                StopLossPrice = calculatedStopLossPrice;
                Console.WriteLine($"ğŸ”§ æ­¢æŸä»·å·²è®¾ç½®: {PriceFormatConverter.FormatPrice(StopLossPrice)}");

                // è®¡ç®—é¢„æœŸäºæŸé‡‘é¢
                if (Quantity > 0)
                {
                    var priceChange = Math.Abs(LatestPrice - StopLossPrice);
                    StopLossAmount = priceChange * Quantity;
                    
                    // æ‰‹åŠ¨è®¡ç®—æ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡ï¿½?                    var formattedStopLossPrice = PriceFormatConverter.FormatPrice(StopLossPrice);
                    StatusMessage = $"æ­¢æŸä»·å·²è®¡ç®—: {formattedStopLossPrice}, é¢„æœŸäºæŸ: {StopLossAmount:F2} USDT";
                    var formattedLatestPrice = PriceFormatConverter.FormatPrice(LatestPrice);
                    Console.WriteLine($"ğŸ¯ æ™ºèƒ½è®¡ç®—å®Œæˆ: {Side} æ–¹å‘, å½“å‰ï¿½?{formattedLatestPrice}, æ­¢æŸæ¯”ä¾‹ {StopLossRatio:F2}%, æ­¢æŸï¿½?{formattedStopLossPrice}");
                    Console.WriteLine($"ğŸ’¸ é¢„æœŸäºæŸ: ä»·å·®={PriceFormatConverter.FormatPrice(priceChange)}, æ•°é‡={Quantity}, äºæŸé‡‘é¢={StopLossAmount:F2} USDT");
                }
                else
                {
                    // æ•°é‡?æ—¶åªæ˜¾ç¤ºä»·æ ¼
                    var formattedLatestPrice = PriceFormatConverter.FormatPrice(LatestPrice);
                    var formattedStopLossPrice = PriceFormatConverter.FormatPrice(StopLossPrice);
                    StatusMessage = $"æ­¢æŸä»·å·²è®¡ç®—: {formattedStopLossPrice} (è¯·è®¾ç½®äº¤æ˜“æ•°é‡ä»¥è®¡ç®—äºæŸé‡‘é¢)";
                    Console.WriteLine($"ğŸ¤– æ­¢æŸä»·è®¡ç®—å®Œï¿½? {Side} æ–¹å‘, å½“å‰ï¿½?{formattedLatestPrice}, æ­¢æŸæ¯”ä¾‹ {StopLossRatio:F2}%, æ­¢æŸï¿½?{formattedStopLossPrice}");
                }
                
                // è§¦å‘å±æ€§å˜åŒ–é€šçŸ¥
                OnPropertyChanged(nameof(StopLossPrice));
                OnPropertyChanged(nameof(StopLossAmount));
            }
            catch (Exception ex)
            {
                StatusMessage = $"è®¡ç®—æ­¢æŸä»·å¤±ï¿½? {ex.Message}";
                Console.WriteLine($"ğŸ”§ è®¡ç®—æ­¢æŸä»·å¼‚? {ex.Message}");
                Console.WriteLine($"ğŸ“ å¼‚å¸¸å †æ ˆ: {ex.StackTrace}");
            }
        }

        [RelayCommand]
        private async Task PlaceOrderAsync()
        {
            if (SelectedAccount == null || string.IsNullOrEmpty(Symbol) || Quantity <= 0)
            {
                StatusMessage = "è¯·ç¡®ä¿é€‰æ‹©äº†è´¦æˆ·ã€è¾“å…¥äº†åˆçº¦åç§°å’Œæ•°ï¿½?;
                return;
            }

            // ğŸ¯ ç¡®ä¿æœ‰æœ€æ–°ä»·æ ¼ï¼Œç‰¹åˆ«æ˜¯å¸‚ä»·å•éœ€è¦å‡†ç¡®çš„ä»·æ ¼è¿›è¡Œé£é™©è®¡ç®—
            if (LatestPrice <= 0)
            {
                StatusMessage = "è¯·å…ˆè·å–æœ€æ–°ä»·ï¿½?;
                return;
            }

            // è°ƒè¯•è¾“å‡ºï¼šæ˜¾ç¤ºå½“å‰çš„äº¤æ˜“å‚æ•°
            Console.WriteLine("\nğŸ” ä¸‹å•å‰å‚æ•°æ£€ï¿½?");
            Console.WriteLine($"   å½“å‰Sideï¿½? '{Side}' (ç±»å‹: {Side?.GetType()?.Name ?? "null"})");
            Console.WriteLine($"   IsBuySelected: {IsBuySelected}");
            Console.WriteLine($"   IsSellSelected: {IsSellSelected}");
            Console.WriteLine($"   å°†è®¾ç½®PositionSideï¿½? {(Side == "BUY" ? "LONG" : "SHORT")}");

            // æ„å»ºè®¢å•è¯·æ±‚å¯¹è±¡
            var orderRequest = new OrderRequest
            {
                Symbol = Symbol,
                Side = Side,
                // ğŸ¯ PositionSideè®¾ç½®é€»è¾‘ï¿½?                // å•å‘æŒä»“æ¨¡å¼(é»˜è®¤)ï¼šä½¿ç”¨BOTH
                // åŒå‘æŒä»“æ¨¡å¼ï¼šBUYâ†’LONGï¼ŒSELLâ†’SHORT
                // ä¼˜å…ˆä½¿ç”¨BOTHä¿è¯å…¼å®¹ï¿½?                PositionSide = "BOTH", // é»˜è®¤ä½¿ç”¨BOTHï¼Œå…¼å®¹å¤§å¤šæ•°è´¦æˆ·çš„å•å‘æŒä»“æ¨¡?                Type = OrderType,
                Quantity = Quantity,
                // ğŸ¯ é™ä»·å•ä½¿ç”¨è®¾ç½®çš„Priceï¼Œå¸‚ä»·å•è®¾Price=0
                Price = OrderType == "LIMIT" ? Price : 0,
                StopPrice = OrderType.Contains("STOP") || OrderType.Contains("TAKE_PROFIT") ? StopLossPrice : 0,
                WorkingType = WorkingType,
                Leverage = Leverage,
                MarginType = MarginType,
                StopLossRatio = StopLossRatio,
                StopLossPrice = StopLossPrice,
                StopLossAmount = StopLossAmount
            };

            // æ‰§è¡Œä¸‹å•æ ¡éªŒ
            IsLoading = true;
            StatusMessage = "æ­£åœ¨æ ¡éªŒä¸‹å•å‚æ•°...";
            
            try
            {
                Console.WriteLine($"ğŸ” ä¸‹å•æ ¡éªŒå¼€ï¿½? {Side} {Quantity} {Symbol}");
                Console.WriteLine($"ğŸ“Š è®¢å•ç±»å‹: {OrderType}, ä»·æ ¼: {(OrderType == "LIMIT" ? LatestPrice.ToString() : "å¸‚ä»·")}");
                Console.WriteLine($"ğŸ›¡ï¿½?æ­¢æŸè®¾ç½®: ä»·æ ¼={StopLossPrice}, é‡‘é¢={StopLossAmount}, æ¯”ä¾‹={StopLossRatio}%");
                
                var (isValid, errorMessage) = await _binanceService.ValidateOrderAsync(orderRequest);
                
                if (!isValid)
                {
                    StatusMessage = $"ä¸‹å•æ ¡éªŒå¤±è´¥: {errorMessage}";
                    System.Windows.MessageBox.Show(
                        $"ä¸‹å•æ ¡éªŒå¤±è´¥ï¼š\n\n{errorMessage}\n\nè¯·è°ƒæ•´å‚æ•°åé‡è¯•",
                        "å‚æ•°é”™è¯¯",
                        System.Windows.MessageBoxButton.OK,
                        System.Windows.MessageBoxImage.Warning);
                    return;
                }

                // æ›´æ–°UIæ˜¾ç¤ºæ ¡éªŒåçš„å‚æ•°
                Leverage = orderRequest.Leverage;
                MarginType = orderRequest.MarginType;
                StopLossAmount = orderRequest.StopLossAmount;

                // æ„å»ºä¸‹å•ç¡®è®¤ä¿¡æ¯
                var priceDisplay = OrderType == "MARKET" ? "å¸‚ä»·" : PriceFormatConverter.FormatPrice(LatestPrice);
                var orderInfo = $"åˆçº¦ï¼š{Symbol}\n" +
                               $"æ–¹å‘ï¼š{(Side == "BUY" ? "ä¹°å…¥å¼€ï¿½? : "å–å‡ºå¼€ï¿½?)}\n" +
                               $"æ•°é‡ï¼š{Quantity}\n" +
                               $"ç±»å‹ï¼š{OrderType}\n" +
                               $"ä»·æ ¼ï¼š{priceDisplay}\n" +
                               $"æ æ†ï¼š{Leverage}x\n" +
                               $"ä¿è¯é‡‘æ¨¡å¼ï¼š{MarginType}";

                if (StopLossPrice > 0)
                {
                    var formattedStopLossPrice = PriceFormatConverter.FormatPrice(StopLossPrice);
                    orderInfo += $"\næ­¢æŸä»·ï¼š{formattedStopLossPrice}";
                    orderInfo += $"\né£é™©é‡‘é¢ï¼š{StopLossAmount:F2} USDT";
                }

                // ğŸ¯ å¼ºè°ƒé£é™©æ§åˆ¶ä¿¡æ¯
                if (StopLossAmount > 0)
                {
                    orderInfo += $"\n\nâš ï¸ æœ€å¤§é£é™©ï¼š{StopLossAmount:F2} USDT";
                    Console.WriteLine($"ğŸ¯ é£é™©æ§åˆ¶ç¡®è®¤: æœ€å¤§äºï¿½?{StopLossAmount:F2} USDT");
                }

                // æ˜¾ç¤ºç¡®è®¤å¯¹è¯ï¿½?                var result = System.Windows.MessageBox.Show(
                    $"ç¡®è®¤ä¸‹å•ä¿¡æ¯ï¼š\n\n{orderInfo}\n\nğŸ¯ å‚æ•°æ ¡éªŒå·²é€šè¿‡\n\nç¡®å®šè¦ä¸‹å•å—?,
                    "ä¸‹å•ç¡®è®¤",
                    System.Windows.MessageBoxButton.YesNo,
                    System.Windows.MessageBoxImage.Question);

                if (result != System.Windows.MessageBoxResult.Yes)
                    return;

                if (orderRequest.IsConditionalOrder)
                {
                    StatusMessage = $"æ¡ä»¶å•ä¸‹å•ä¸­: {OrderType} {Symbol} {Side} {Quantity}...";
                }
                else
                {
                    StatusMessage = $"ä¸‹å•ï¿½? {Side} {Quantity} {Symbol}...";
                }
                
                // ä¸‹å•
                var success = await _binanceService.PlaceOrderAsync(orderRequest);
                
                if (success)
                {
                    if (orderRequest.IsConditionalOrder)
                    {
                        StatusMessage = "æ¡ä»¶å•ä¸‹å•æˆï¿½?;
                        var formattedStopLossPrice = PriceFormatConverter.FormatPrice(StopLossPrice);
                        System.Windows.MessageBox.Show(
                            $"æ¡ä»¶å•ä¸‹å•æˆåŠŸï¼\n\nğŸ¯ {OrderType}: {Side} {Quantity} {Symbol}\nğŸ“Š è§¦å‘ä»·ï¼š{formattedStopLossPrice}",
                            "æ¡ä»¶å•æˆ?,
                            System.Windows.MessageBoxButton.OK,
                            System.Windows.MessageBoxImage.Information);
                            
                        // æ·»åŠ åˆ°æ¡ä»¶å•ç›‘æ§åˆ—è¡¨
                        ConditionalOrders.Add(new ConditionalOrderInfo
                        {
                            Symbol = Symbol,
                            Type = OrderType,
                            Side = Side,
                            StopPrice = StopLossPrice,
                            Price = orderRequest.IsLimitConditionalOrder ? LatestPrice : null,
                            Quantity = Quantity,
                            Status = "å¾…è§¦ï¿½?,
                            WorkingType = WorkingType
                        });
                        OnPropertyChanged(nameof(HasNoConditionalOrders));
                    }
                    else
                    {
                        StatusMessage = "ä¸‹å•æˆåŠŸ";
                        
                        Console.WriteLine("\nğŸ” æ£€æŸ¥æ­¢æŸå•ä¸‹å•æ¡ä»¶:");
                        Console.WriteLine($"   StopLossPrice: {StopLossPrice}");
                        Console.WriteLine($"   StopLossPrice > 0: {StopLossPrice > 0}");
                        Console.WriteLine($"   IsConditionalOrder: {orderRequest.IsConditionalOrder}");
                        
                        // å¦‚æœè®¾ç½®äº†æ­¢æŸä»·æ ¼ï¼Œè‡ªåŠ¨ä¸‹æ­¢æŸå•
                        if (StopLossPrice > 0)
                        {
                            Console.WriteLine("ğŸ”§ æ»¡è¶³æ­¢æŸå•ä¸‹å•æ¡ä»¶ï¼Œå¼€å§‹ä¸‹æ­¢æŸå•...");
                            StatusMessage = "æ­£åœ¨ä¸‹æ­¢æŸå•...";
                            await Task.Delay(500); // çŸ­æš‚å»¶è¿Ÿï¼Œç¡®ä¿ä¸»å•å¤„ç†å®Œï¿½?
                            var stopLossSuccess = await PlaceStopLossOrderAsync(orderRequest);
                            
                            if (stopLossSuccess)
                            {
                                StatusMessage = "ä¸‹å•å®Œæˆï¼šä¸»å•å’Œæ­¢æŸå•éƒ½å·²æˆåŠŸä¸‹ï¿½?;
                                var formattedStopLossPrice = PriceFormatConverter.FormatPrice(StopLossPrice);
                                System.Windows.MessageBox.Show(
                                    $"ä¸‹å•æˆåŠŸï¼\n\nğŸ¯ ä¸»å•ï¼š{Side} {Quantity} {Symbol}\nğŸ”§ æ­¢æŸå•ï¼š{formattedStopLossPrice}\nğŸ’° é¢„æœŸæœ€å¤§äºæŸï¼š{StopLossAmount:F2} USDT",
                                    "ä¸‹å•æˆåŠŸ",
                                    System.Windows.MessageBoxButton.OK,
                                    System.Windows.MessageBoxImage.Information);
                            }
                            else
                            {
                                StatusMessage = "ä¸»å•æˆåŠŸï¼Œæ­¢æŸå•å¤±è´¥";
                                System.Windows.MessageBox.Show(
                                    $"ä¸»å•ä¸‹å•æˆåŠŸï¼Œä½†æ­¢æŸå•ä¸‹å•å¤±è´¥ï¼\n\nğŸ¯ ä¸»å•ï¼š{Side} {Quantity} {Symbol}\nğŸ”§ æ­¢æŸå•å¤±è´¥\n\nè¯·æ‰‹åŠ¨è®¾ç½®æ­¢æŸï¼",
                                    "éƒ¨åˆ†æˆåŠŸ",
                                    System.Windows.MessageBoxButton.OK,
                                    System.Windows.MessageBoxImage.Warning);
                            }
                        }
                        else
                        {
                            Console.WriteLine("âš ï¸ æœªè®¾ç½®æ­¢æŸä»·æ ¼ï¼Œè·³è¿‡æ­¢æŸå•ä¸‹ï¿½?);
                            System.Windows.MessageBox.Show(
                                $"ä¸‹å•æˆåŠŸï¼\n\nğŸ¯ {Side} {Quantity} {Symbol}",
                                "ä¸‹å•æˆåŠŸ",
                                System.Windows.MessageBoxButton.OK,
                                System.Windows.MessageBoxImage.Information);
                        }
                    }

                    // åˆ·æ–°æ•°æ®
                    await RefreshDataAsync();
                }
                else
                {
                    StatusMessage = "ä¸‹å•å¤±è´¥";
                    System.Windows.MessageBox.Show(
                        "ä¸‹å•å¤±è´¥ï¼\n\nè¯·æ£€æŸ¥è´¦æˆ·ä½™é¢ã€åˆçº¦å‚æ•°ç­‰",
                        "ä¸‹å•å¤±è´¥",
                        System.Windows.MessageBoxButton.OK,
                        System.Windows.MessageBoxImage.Error);
                }
            }
            catch (Exception ex)
            {
                StatusMessage = $"ä¸‹å•å¤±è´¥: {ex.Message}";
                System.Windows.MessageBox.Show(
                    $"ä¸‹å•å¤±è´¥ï¼š\n\n{ex.Message}",
                    "ä¸‹å•å¤±è´¥",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
            finally
            {
                IsLoading = false;
            }
        }

        private async Task<bool> PlaceStopLossOrderAsync(OrderRequest originalOrder)
        {
            try
            {
                Console.WriteLine("\n" + "=".PadLeft(60, '='));
                Console.WriteLine("ğŸ›¡ï¿½?å¼€å§‹ä¸‹æ­¢æŸå•æµï¿½?);
                Console.WriteLine("=".PadLeft(60, '='));
                
                Console.WriteLine("ğŸ“‹ åŸå§‹è®¢å•ä¿¡æ¯:");
                Console.WriteLine($"   Symbol: {originalOrder.Symbol}");
                Console.WriteLine($"   Side: {originalOrder.Side}");
                Console.WriteLine($"   Type: {originalOrder.Type}");
                Console.WriteLine($"   Quantity: {originalOrder.Quantity}");
                Console.WriteLine($"   PositionSide: {originalOrder.PositionSide}");
                Console.WriteLine($"   Leverage: {originalOrder.Leverage}");
                Console.WriteLine($"   MarginType: {originalOrder.MarginType}");
                
                Console.WriteLine("\nğŸ¯ æ­¢æŸå•å‚æ•°è®¾ï¿½?");
                Console.WriteLine($"   å½“å‰StopLossPrice: {StopLossPrice}");
                Console.WriteLine($"   å½“å‰StopLossRatio: {StopLossRatio}%");
                Console.WriteLine($"   å½“å‰StopLossAmount: {StopLossAmount} USDT");
                
                // éªŒè¯æ­¢æŸä»·æ ¼æ˜¯å¦æœ‰æ•ˆ
                if (StopLossPrice <= 0)
                {
                    Console.WriteLine("ğŸ”§ æ­¢æŸä»·æ ¼æ— æ•ˆï¼Œæ— æ³•ä¸‹æ­¢æŸå•");
                    return false;
                }
                
                // æ„å»ºæ­¢æŸ?                var stopLossOrder = new OrderRequest
                {
                    Symbol = originalOrder.Symbol,
                    Side = originalOrder.Side == "BUY" ? "SELL" : "BUY", // åå‘æ“ä½œ
                    PositionSide = originalOrder.PositionSide,
                    Type = "STOP_MARKET", // æ­¢æŸå¸‚ä»·ï¿½?                    Quantity = originalOrder.Quantity, // å¿…é¡»è®¾ç½®æ•°é‡
                    StopPrice = StopLossPrice,
                    ReduceOnly = true, // åªå‡ï¿½?                    Leverage = originalOrder.Leverage,
                    MarginType = originalOrder.MarginType,
                    WorkingType = "CONTRACT_PRICE" // ä½¿ç”¨åˆçº¦ä»·æ ¼è§¦å‘
                };

                Console.WriteLine("\nğŸ”§ æ„å»ºçš„æ­¢æŸå•å‚æ•°:");
                Console.WriteLine($"   Symbol: {stopLossOrder.Symbol}");
                Console.WriteLine($"   Side: {stopLossOrder.Side} (åŸå•{originalOrder.Side}çš„åï¿½?");
                Console.WriteLine($"   Type: {stopLossOrder.Type}");
                Console.WriteLine($"   Quantity: {stopLossOrder.Quantity} (å¿…é¡»è®¾ç½®)");
                Console.WriteLine($"   StopPrice: {stopLossOrder.StopPrice}");
                Console.WriteLine($"   PositionSide: {stopLossOrder.PositionSide}");
                Console.WriteLine($"   ReduceOnly: {stopLossOrder.ReduceOnly}");
                Console.WriteLine($"   WorkingType: {stopLossOrder.WorkingType}");
                Console.WriteLine($"   Leverage: {stopLossOrder.Leverage}");
                Console.WriteLine($"   MarginType: {stopLossOrder.MarginType}");

                Console.WriteLine($"\nğŸ›¡ï¿½?ä¸‹æ­¢æŸå•: {stopLossOrder.Side} {stopLossOrder.Quantity} {stopLossOrder.Symbol} @ {PriceFormatConverter.FormatPrice(StopLossPrice)}");
                
                // éªŒè¯æ­¢æŸä»·æ ¼æ˜¯å¦åˆç†
                if (originalOrder.Side == "BUY" && StopLossPrice >= LatestPrice)
                {
                    Console.WriteLine($"âš ï¸ è­¦å‘Š: åšå¤šæ­¢æŸï¿½?{StopLossPrice})åº”è¯¥ä½äºå½“å‰ï¿½?{LatestPrice})");
                }
                else if (originalOrder.Side == "SELL" && StopLossPrice <= LatestPrice)
                {
                    Console.WriteLine($"âš ï¸ è­¦å‘Š: åšç©ºæ­¢æŸï¿½?{StopLossPrice})åº”è¯¥é«˜äºå½“å‰ï¿½?{LatestPrice})");
                }
                
                // éªŒè¯æ•°é‡æ˜¯å¦åŒ¹é…
                if (stopLossOrder.Quantity != originalOrder.Quantity)
                {
                    Console.WriteLine($"âš ï¸ è­¦å‘Š: æ­¢æŸå•æ•°ï¿½?{stopLossOrder.Quantity})ä¸åŸå•æ•°ï¿½?{originalOrder.Quantity})ä¸åŒ¹ï¿½?);
                }
                else
                {
                    Console.WriteLine($"ğŸ”§ æ­¢æŸå•æ•°é‡éªŒè¯é€šè¿‡: {stopLossOrder.Quantity}");
                }
                
                Console.WriteLine("\nğŸš€ å¼€å§‹è°ƒç”¨BinanceServiceä¸‹å•API...");
                var success = await _binanceService.PlaceOrderAsync(stopLossOrder);
                
                Console.WriteLine($"\nğŸ“Š æ­¢æŸå•ä¸‹å•ç»“ï¿½? {(success ? "æˆåŠŸ" : "å¤±è´¥")}");
                
                if (success)
                {
                    Console.WriteLine("ğŸ”§ æ­¢æŸå•ä¸‹å•æˆ?");
                    Console.WriteLine("ğŸ”„ å»ºè®®ç­‰å¾…2-3ç§’ååˆ·æ–°å§”æ‰˜åˆ—è¡¨æŸ¥çœ‹æ­¢æŸå•");
                }
                else
                {
                    Console.WriteLine("ğŸ’¡ æ­¢æŸå•ä¸‹å•å¤±? å¯èƒ½åŸå› :");
                    Console.WriteLine("   ğŸ”§ æ­¢æŸä»·æ ¼ä¸ç¬¦åˆäº¤æ˜“è§„åˆ™");
                    Console.WriteLine("   ğŸ”§ æ•°é‡æˆ–ä»·æ ¼ç²¾åº¦ä¸æ­£ç¡®");
                    Console.WriteLine("   ğŸ”§ è´¦æˆ·æƒé™æˆ–ä½™é¢é—®é¢˜");
                    Console.WriteLine("   ğŸ”§ ç½‘ç»œæˆ–APIé—®é¢˜");
                }

                return success;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"\nğŸ”§ æ­¢æŸå•ä¸‹å•å¼‚?");
                Console.WriteLine($"   å¼‚å¸¸ç±»å‹: {ex.GetType().Name}");
                Console.WriteLine($"   å¼‚å¸¸æ¶ˆæ¯: {ex.Message}");
                Console.WriteLine($"   å¼‚å¸¸å †æ ˆ: {ex.StackTrace}");
                return false;
            }
            finally
            {
                Console.WriteLine("\n" + "=".PadLeft(60, '='));
                Console.WriteLine("ğŸ æ­¢æŸå•æµç¨‹ç»“ï¿½?);
                Console.WriteLine("=".PadLeft(60, '=') + "\n");
            }
        }

        [RelayCommand]
        private async Task UpdateLatestPriceAsync()
        {
            if (string.IsNullOrEmpty(Symbol) || SelectedAccount == null)
                return;

            try
            {
                var price = await _binanceService.GetLatestPriceAsync(Symbol);
                if (price > 0)
                {
                    LatestPrice = price;
                    var formattedPrice = PriceFormatConverter.FormatPrice(price);
                    StatusMessage = $"{Symbol} ä»·æ ¼: {formattedPrice}";
                }
            }
            catch (Exception ex)
            {
                StatusMessage = $"è·å–ä»·æ ¼å¤±è´¥: {ex.Message}";
            }
        }

        [RelayCommand]
        private void ToggleTimers()
        {
            if (_priceTimer.IsEnabled)
            {
                StopTimers();
            }
            else if (SelectedAccount != null)
            {
                StartTimers();
            }
        }
        
        [RelayCommand]
        private void ToggleAutoRefresh()
        {
            AutoRefreshEnabled = !AutoRefreshEnabled;
            if (AutoRefreshEnabled)
            {
                StatusMessage = "è‡ªåŠ¨åˆ·æ–°å·²å¯ï¿½?;
            }
            else
            {
                StatusMessage = "è‡ªåŠ¨åˆ·æ–°å·²æš‚ï¿½?- é€‰æ‹©çŠ¶æ€å°†ä¿æŒä¸å˜";
            }
        }

        [RelayCommand]
        private void SetLeverage(object parameter)
        {
            if (parameter is string leverageStr && int.TryParse(leverageStr, out int leverage))
            {
                Leverage = leverage;
                StatusMessage = $"æ æ†å·²è®¾ç½®ä¸º {leverage}x";
            }
        }

        // åœ¨çª—å£å…³é—­æ—¶è°ƒç”¨ï¼Œæ¸…ç†èµ„ï¿½?        public void Cleanup()
        {
            // ä¿å­˜å½“å‰äº¤æ˜“è®¾ç½®
            SaveTradingSettings();
            
            StopTimers();
        }

        // å½“å…³é”®å‚æ•°å˜åŒ–æ—¶è‡ªåŠ¨ä¿å­˜è®¾ç½®
        partial void OnSideChanged(string value)
        {
            if (!_isInitializing)
            {
                SaveTradingSettings();
            }
        }
        
        partial void OnLeverageChanged(int value)
        {
            if (!_isInitializing)
            {
                SaveTradingSettings();
            }
        }
        
        partial void OnMarginTypeChanged(string value)
        {
            if (!_isInitializing)
            {
                SaveTradingSettings();
            }
        }
        
        partial void OnOrderTypeChanged(string value)
        {
            // é€šçŸ¥IsLimitOrderå±æ€§æ›´ï¿½?            OnPropertyChanged(nameof(IsLimitOrder));
            
            if (!_isInitializing)
            {
                SaveTradingSettings();
            }
        }
        
        partial void OnStopLossRatioChanged(decimal value)
        {
            // éªŒè¯æ­¢æŸæ¯”ä¾‹çš„åˆç†ï¿½?(èŒƒå›´ï¿½?.1% - 100%)
            if (value < 0.1m)
            {
                Console.WriteLine($"âš ï¸ æ­¢æŸæ¯”ä¾‹è¿‡å°({value:F2}%)ï¼Œæœ€å°å€¼ä¸º0.1%ï¼Œé‡ç½®ä¸º5%");
                StopLossRatio = 5.0m;
                return;
            }
            
            if (value > 100m)
            {
                Console.WriteLine($"âš ï¸ æ­¢æŸæ¯”ä¾‹è¿‡å¤§({value:F2}%)ï¼Œæœ€å¤§å€¼ä¸º100%ï¼Œé‡ç½®ä¸º5%");
                StopLossRatio = 5.0m;
                return;
            }
            
            // æ•°å€¼è§„èŒƒåŒ–ï¼šä¿ç•™æœ€ï¿½?ä½å°ï¿½?            var normalizedValue = Math.Round(value, 2);
            if (normalizedValue != value)
            {
                Console.WriteLine($"ğŸ”§ æ­¢æŸæ¯”ä¾‹ç²¾åº¦è°ƒæ•´: {value:F4}% ğŸ”§ {normalizedValue:F2}%");
                StopLossRatio = normalizedValue;
                return;
            }
            
            Console.WriteLine($"ğŸ”§ æ­¢æŸæ¯”ä¾‹è®¾ç½®: {value:F2}%");
            
            if (!_isInitializing)
            {
                SaveTradingSettings();
            }
        }

        [RelayCommand]
        private async Task ClearAllPositionsAndOrdersAsync()
        {
            if (SelectedAccount == null)
                return;

            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯ï¿½?            var result = System.Windows.MessageBox.Show(
                "ç¡®å®šè¦æ‰§è¡Œä¸€é”®æ¸…ä»“å—ï¼Ÿ\n\næ­¤æ“ä½œå°†ï¼š\nğŸ”§ å–æ¶ˆæ‰€æœ‰å§”æ‰˜å•\nğŸ”§ å¹³æ‰æ‰€æœ‰æŒä»“ï¼ˆå¸‚ä»·å•ï¼‰\n\næ­¤æ“ä½œä¸å¯æ’¤é”€?,
                "ä¸€é”®æ¸…ä»“ç¡®?,
                System.Windows.MessageBoxButton.YesNo,
                System.Windows.MessageBoxImage.Warning);

            if (result != System.Windows.MessageBoxResult.Yes)
                return;

            IsLoading = true;
            StatusMessage = "æ‰§è¡Œä¸€é”®æ¸…ï¿½?..";
            try
            {
                // ç¬¬ä¸€æ­¥ï¼šå–æ¶ˆæ‰€æœ‰å§”æ‰˜å•
                StatusMessage = "æ­£åœ¨å–æ¶ˆæ‰€æœ‰å§”æ‰˜å•...";
                var cancelSuccess = await _binanceService.CancelAllOrdersAsync();
                
                if (cancelSuccess)
                {
                    Console.WriteLine("ğŸ”§ æ‰€æœ‰å§”æ‰˜å•å·²å–æ¶ˆ");
                }
                else
                {
                    Console.WriteLine("ğŸ”§ å–æ¶ˆå§”æ‰˜å•å¤±?");
                }

                // ç¬¬äºŒæ­¥ï¼šå¹³æ‰æ‰€æœ‰æŒ?                StatusMessage = "æ­£åœ¨å¹³æ‰æ‰€æœ‰æŒ?..";
                var closeSuccess = await _binanceService.CloseAllPositionsAsync();
                
                if (closeSuccess)
                {
                    Console.WriteLine("ğŸ”§ æ‰€æœ‰æŒä»“å·²å¹³ä»“");
                }
                else
                {
                    Console.WriteLine("ğŸ”§ å¹³ä»“å¤±è´¥");
                }

                // åˆ·æ–°æ•°æ®éªŒè¯ç»“æœ
                await RefreshDataAsync();

                if (cancelSuccess && closeSuccess)
                {
                    StatusMessage = "ä¸€é”®æ¸…ä»“å®Œæˆï¼šæ‰€æœ‰å§”æ‰˜å•å·²å–æ¶ˆï¼Œæ‰€æœ‰æŒä»“å·²å¹³æ‰";
                    System.Windows.MessageBox.Show(
                        "ä¸€é”®æ¸…ä»“æ“ä½œå®Œæˆï¼\n\næ‰€æœ‰å§”æ‰˜å•å·²å–æ¶ˆ\næ‰€æœ‰æŒä»“å·²å¹³æ‰",
                        "æ“ä½œå®Œæˆ",
                        System.Windows.MessageBoxButton.OK,
                        System.Windows.MessageBoxImage.Information);
                }
                else
                {
                    StatusMessage = "ä¸€é”®æ¸…ä»“éƒ¨åˆ†å®Œæˆï¼Œè¯·æ£€æŸ¥å‰©ä½™æŒä»“å’Œå§”æ‰˜å•";
                    System.Windows.MessageBox.Show(
                        "ä¸€é”®æ¸…ä»“æ“ä½œéƒ¨åˆ†å®Œæˆï¼Œå¯èƒ½å­˜åœ¨ä»¥ä¸‹æƒ…å†µï¼š\n\nğŸ”§ éƒ¨åˆ†å§”æ‰˜å•å–æ¶ˆå¤±è´¥\nğŸ”§ éƒ¨åˆ†æŒä»“å¹³ä»“å¤±è´¥\n\nè¯·æ‰‹åŠ¨æ£€æŸ¥å¹¶å¤„ç†å‰©ä½™ä»“ä½",
                        "æ“ä½œè­¦å‘Š",
                        System.Windows.MessageBoxButton.OK,
                        System.Windows.MessageBoxImage.Warning);
                }
            }
            catch (Exception ex)
            {
                StatusMessage = $"ä¸€é”®æ¸…ä»“å¤±ï¿½? {ex.Message}";
                System.Windows.MessageBox.Show(
                    $"ä¸€é”®æ¸…ä»“æ“ä½œå¤±è´¥ï¼š\n\n{ex.Message}",
                    "æ“ä½œå¤±è´¥",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
            finally
            {
                IsLoading = false;
            }
        }

        // === è®¢å•é€‰æ‹©ç›¸å…³å‘½ä»¤ ===
        
        [RelayCommand]
        private void SelectAllOrders()
        {
            try
            {
                Console.WriteLine($"ğŸ”² å…¨é€‰è®¢å•æ“ä½œ...");
                foreach (var order in FilteredOrders)
                {
                    order.IsSelected = true;
                }
                
                OnPropertyChanged(nameof(SelectedOrders));
                OnPropertyChanged(nameof(HasSelectedOrders));
                OnPropertyChanged(nameof(SelectedOrderCount));
                OnPropertyChanged(nameof(HasSelectedStopOrders));
                OnPropertyChanged(nameof(SelectedStopOrderCount));
                
                StatusMessage = $"å·²å…¨é€‰{FilteredOrders.Count} ä¸ªè®¢å•";
                Console.WriteLine($"ğŸ”§ å…¨é€‰å®Œæˆ {FilteredOrders.Count} ä¸ªè®¢å•");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ğŸ”§ å…¨é€‰è®¢å•å¼‚å¸¸: {ex.Message}");
                StatusMessage = $"å…¨é€‰è®¢å•å¤±? {ex.Message}";
            }
        }
        
        [RelayCommand]
        private void UnselectAllOrders()
        {
            try
            {
                Console.WriteLine($"ğŸ”§ å–æ¶ˆå…¨é€‰è®¢å•æ“ä½œ...");
                foreach (var order in FilteredOrders)
                {
                    order.IsSelected = false;
                }
                
                OnPropertyChanged(nameof(SelectedOrders));
                OnPropertyChanged(nameof(HasSelectedOrders));
                OnPropertyChanged(nameof(SelectedOrderCount));
                OnPropertyChanged(nameof(HasSelectedStopOrders));
                OnPropertyChanged(nameof(SelectedStopOrderCount));
                
                StatusMessage = $"å·²å–æ¶ˆé€‰æ‹©æ‰€æœ‰è®¢å•";
                Console.WriteLine($"ğŸ”§ å–æ¶ˆå…¨é€‰å®Œæˆ");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ğŸ”§ å–æ¶ˆå…¨é€‰è®¢å•å¼‚å¸¸: {ex.Message}");
                StatusMessage = $"å–æ¶ˆå…¨é€‰è®¢å•å¤±? {ex.Message}";
            }
        }
        
        [RelayCommand]
        private void InvertOrderSelection()
        {
            try
            {
                Console.WriteLine($"ğŸ”„ åé€‰è®¢å•æ“ä½œ...");
                foreach (var order in FilteredOrders)
                {
                    order.IsSelected = !order.IsSelected;
                }
                
                OnPropertyChanged(nameof(SelectedOrders));
                OnPropertyChanged(nameof(HasSelectedOrders));
                OnPropertyChanged(nameof(SelectedOrderCount));
                OnPropertyChanged(nameof(HasSelectedStopOrders));
                OnPropertyChanged(nameof(SelectedStopOrderCount));
                
                var selectedCount = FilteredOrders.Count(o => o.IsSelected);
                StatusMessage = $"åé€‰å®Œæˆï¼Œå½“å‰é€‰ä¸­ {selectedCount} ä¸ªè®¢å•";
                Console.WriteLine($"ğŸ”„ åé€‰å®Œæˆ å½“å‰é€‰ä¸­ {selectedCount} ä¸ªè®¢å•");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ğŸ”„ åé€‰è®¢å•å¼‚å¸¸: {ex.Message}");
                StatusMessage = $"åé€‰è®¢å•å¤±? {ex.Message}";
            }
        }
        
        [RelayCommand]
        private async Task CancelSelectedOrdersAsync()
        {
            try
            {
                var selectedOrders = FilteredOrders.Where(o => o.IsSelected).ToList();
                
                if (!selectedOrders.Any())
                {
                    StatusMessage = "è¯·å…ˆé€‰æ‹©è¦å–æ¶ˆçš„è®¢å•";
                    System.Windows.MessageBox.Show(
                        "è¯·å…ˆå‹¾é€‰è¦å–æ¶ˆçš„è®¢å•",
                        "æœªé€‰æ‹©è®¢å•",
                        System.Windows.MessageBoxButton.OK,
                        System.Windows.MessageBoxImage.Warning);
                    return;
                }
                
                var result = System.Windows.MessageBox.Show(
                    $"ç¡®å®šè¦å–æ¶ˆé€‰ä¸­è®¢å•{selectedOrders.Count} ä¸ªå—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€?,
                    "å–æ¶ˆè®¢å•ç¡®è®¤",
                    System.Windows.MessageBoxButton.YesNo,
                    System.Windows.MessageBoxImage.Question);

                if (result != System.Windows.MessageBoxResult.Yes)
                    return;

                IsLoading = true;
                StatusMessage = $"æ­£åœ¨å–æ¶ˆ {selectedOrders.Count} ä¸ªé€‰ä¸­çš„è®¢å•...";
                
                int successCount = 0;
                int failedCount = 0;
                
                foreach (var order in selectedOrders)
                {
                    try
                    {
                        Console.WriteLine($"ğŸ—‘?å–æ¶ˆè®¢å•: {order.OrderId} {order.Symbol}");
                        var success = await _binanceService.CancelOrderAsync(order.Symbol, order.OrderId);
                        
                        if (success)
                        {
                            successCount++;
                            Console.WriteLine($"ğŸ”§ è®¢å•å–æ¶ˆæˆåŠŸ: {order.OrderId}");
                        }
                        else
                        {
                            failedCount++;
                            Console.WriteLine($"ğŸ”§ è®¢å•å–æ¶ˆå¤±è´¥: {order.OrderId}");
                        }
                    }
                    catch (Exception ex)
                    {
                        failedCount++;
                        Console.WriteLine($"ğŸ”§ å–æ¶ˆè®¢å•å¼‚å¸¸: {order.OrderId}, {ex.Message}");
                    }
                }
                
                StatusMessage = $"è®¢å•å–æ¶ˆå®Œæˆ: æˆåŠŸ {successCount} ä¸ªï¼Œå¤±è´¥ {failedCount} ä¸ª";
                
                System.Windows.MessageBox.Show(
                    $"è®¢å•å–æ¶ˆæ“ä½œå®Œæˆï¼\n\nğŸ¯ æˆåŠŸå–æ¶ˆ: {successCount} ä¸ª\nğŸ”§ å–æ¶ˆå¤±è´¥: {failedCount} ä¸ª",
                    "å–æ¶ˆç»“æœ",
                    System.Windows.MessageBoxButton.OK,
                    failedCount > 0 ? System.Windows.MessageBoxImage.Warning : System.Windows.MessageBoxImage.Information);
                
                // åˆ·æ–°æ•°æ®
                await RefreshDataAsync();
            }
            catch (Exception ex)
            {
                StatusMessage = $"å–æ¶ˆè®¢å•å¼‚å¸¸: {ex.Message}";
                Console.WriteLine($"ğŸ”§ å–æ¶ˆé€‰ä¸­è®¢å•å¼‚å¸¸: {ex.Message}");
                
                System.Windows.MessageBox.Show(
                    $"å–æ¶ˆè®¢å•æ—¶å‘ç”Ÿå¼‚å¸¸ï¼š\n\n{ex.Message}",
                    "æ“ä½œå¼‚å¸¸",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
            finally
            {
                IsLoading = false;
            }
        }
        
        [RelayCommand]
        private async Task AddBreakEvenStopLossForSelectedOrdersAsync()
        {
            Console.WriteLine("ğŸ›¡ï¿½?å¼€å§‹ä¸ºé€‰ä¸­è®¢å•æ·»åŠ ä¿æœ¬æ­¢æŸ...");
            try
            {
                var selectedOrders = FilteredOrders.Where(o => o.IsSelected).ToList();
                Console.WriteLine($"é€‰ä¸­è®¢å•æ•°é‡: {selectedOrders.Count}");
                
                if (!selectedOrders.Any())
                {
                    Console.WriteLine("ğŸ”§ æœªé€‰æ‹©ä»»ä½•è®¢å•");
                    StatusMessage = "è¯·å…ˆé€‰æ‹©è¦æ·»åŠ ä¿æœ¬æ­¢æŸçš„è®¢å•";
                    System.Windows.MessageBox.Show(
                        "è¯·å…ˆå‹¾é€‰è¦æ·»åŠ ä¿æœ¬æ­¢æŸçš„è®¢å•",
                        "æœªé€‰æ‹©è®¢å•",
                        System.Windows.MessageBoxButton.OK,
                        System.Windows.MessageBoxImage.Warning);
                    return;
                }
                
                // åªå¤„ç†é™ä»·ä¹°ï¿½?å–å‡ºï¿½?                var validOrders = selectedOrders.Where(o => 
                    o.Type == "LIMIT" && 
                    (o.Side == "BUY" || o.Side == "SELL") && 
                    o.Price > 0).ToList();
                
                Console.WriteLine($"æœ‰æ•ˆé™ä»·å•æ•°: {validOrders.Count}");
                foreach (var order in validOrders)
                {
                    Console.WriteLine($"ğŸ“‹ æœ‰æ•ˆè®¢å•: OrderId={order.OrderId}, Symbol={order.Symbol}, Side={order.Side}, Quantity={order.OrigQty}, Price={order.Price}");
                }
                
                if (!validOrders.Any())
                {
                    Console.WriteLine("ğŸ”§ é€‰ä¸­çš„è®¢å•ä¸­æ²¡æœ‰æœ‰æ•ˆçš„é™ä»·å•");
                    StatusMessage = "é€‰ä¸­çš„è®¢å•ä¸­æ²¡æœ‰æœ‰æ•ˆçš„é™ä»·å•";
                    System.Windows.MessageBox.Show(
                        "åªèƒ½ä¸ºé™ä»·ä¹°ï¿½?å–å‡ºå•æ·»åŠ ä¿æœ¬æ­¢æŸï¼\n\nå½“å‰é€‰ä¸­çš„è®¢å•ä¸­æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è®¢å•",
                        "è®¢å•ç±»å‹æ— æ•ˆ",
                        System.Windows.MessageBoxButton.OK,
                        System.Windows.MessageBoxImage.Warning);
                    return;
                }
                
                var result = System.Windows.MessageBox.Show(
                    $"ç¡®å®šè¦ä¸ºé€‰ä¸­è®¢å•{validOrders.Count} ä¸ªé™ä»·å•æ·»åŠ ä¿æœ¬æ­¢æŸå—ï¼Ÿ\n\n" +
                    $"å°†ä¸ºæ¯ä¸ªè®¢å•è®¾ç½®ä»¥å¼€ä»“ä»·ä¸ºè§¦å‘ä»·çš„æ­¢æŸå•ã€‚\n\næ­¤æ“ä½œä¸å¯æ’¤é”€?,
                    "æ·»åŠ ä¿æœ¬æ­¢æŸç¡®è®¤",
                    System.Windows.MessageBoxButton.YesNo,
                    System.Windows.MessageBoxImage.Question);

                if (result != System.Windows.MessageBoxResult.Yes)
                {
                    Console.WriteLine("ğŸš« ç”¨æˆ·å–æ¶ˆäº†ä¿æœ¬æ­¢æŸæ“ä½œ");
                    return;
                }

                IsLoading = true;
                StatusMessage = $"æ­£åœ¨ä¸º{validOrders.Count} ä¸ªè®¢å•æ·»åŠ ä¿æœ¬æ­¢æŸ...";
                Console.WriteLine($"ğŸš€ å¼€å§‹å¤„ç†{validOrders.Count} ä¸ªæœ‰æ•ˆè®¢å•...");
                
                int successCount = 0;
                int failedCount = 0;
                
                foreach (var order in validOrders)
                {
                    try
                    {
                        Console.WriteLine($"\nğŸ›¡ï¿½?å¤„ç†è®¢å•: OrderId={order.OrderId}");
                        Console.WriteLine($"ğŸ“‹ è®¢å•è¯¦æƒ…: Symbol={order.Symbol}, Side={order.Side}, Price={order.Price}, Quantity={order.OrigQty}");
                        Console.WriteLine($"ğŸ“ PositionSide={order.PositionSide}");
                        
                        // æ„å»ºä¿æœ¬æ­¢æŸï¿½?- æ ¹æ®å¸å®‰APIè¦æ±‚
                        var stopLossOrder = new OrderRequest
                        {
                            Symbol = order.Symbol,
                            Side = order.Side == "BUY" ? "SELL" : "BUY", // åå‘æ“ä½œ
                            PositionSide = order.PositionSide,
                            Type = "STOP_MARKET", // å¸‚ä»·æ­¢æŸï¿½?                            StopPrice = order.Price, // è§¦å‘ï¿½?è®¢å•ä»·æ ¼ï¼ˆä¿æœ¬ä»·ï¿½?                            WorkingType = "CONTRACT_PRICE", // ä½¿ç”¨åˆçº¦ä»·æ ¼è§¦å‘
                            ReduceOnly = true // åªå‡ï¿½?                        };

                        Console.WriteLine($"ğŸ”¨ æ„å»ºæ­¢æŸå•å‚æ•°:");
                        Console.WriteLine($"   Symbol: {stopLossOrder.Symbol}");
                        Console.WriteLine($"   Side: {stopLossOrder.Side} (åŸè®¢å•{order.Side}çš„åï¿½?");
                        Console.WriteLine($"   Type: {stopLossOrder.Type}");
                        Console.WriteLine($"   åŸå§‹StopPrice: {stopLossOrder.StopPrice}");
                        
                        // æ ¹æ®åˆçº¦è°ƒæ•´ä»·æ ¼ç²¾åº¦
                        var adjustedStopPrice = AdjustPricePrecision(stopLossOrder.StopPrice, order.Symbol);
                        stopLossOrder.StopPrice = adjustedStopPrice;
                        
                        Console.WriteLine($"   è°ƒæ•´åStopPrice: {stopLossOrder.StopPrice} (è§¦å‘ï¿½?ä¿æœ¬ï¿½?");
                        Console.WriteLine($"   PositionSide: {stopLossOrder.PositionSide}");
                        Console.WriteLine($"   WorkingType: {stopLossOrder.WorkingType}");
                        Console.WriteLine($"   ReduceOnly: {stopLossOrder.ReduceOnly}");
                        Console.WriteLine($"   æ³¨æ„: STOP_MARKETä¸éœ€è¦Quantityå‚æ•°");

                        Console.WriteLine($"ğŸ“¤ å¼€å§‹ä¸‹ï¿½?..");
                        var success = await _binanceService.PlaceOrderAsync(stopLossOrder);
                        
                        if (success)
                        {
                            successCount++;
                            Console.WriteLine($"ğŸ”§ ä¿æœ¬æ­¢æŸæ·»åŠ æˆåŠŸ: {order.Symbol} OrderId={order.OrderId} @ {order.Price}");
                        }
                        else
                        {
                            failedCount++;
                            Console.WriteLine($"ğŸ”§ ä¿æœ¬æ­¢æŸæ·»åŠ å¤±è´¥: {order.Symbol} OrderId={order.OrderId}");
                        }
                    }
                    catch (Exception ex)
                    {
                        failedCount++;
                        Console.WriteLine($"ğŸ”§ æ·»åŠ ä¿æœ¬æ­¢æŸå¼‚å¸¸: {order.Symbol} OrderId={order.OrderId}");
                        Console.WriteLine($"   å¼‚å¸¸ä¿¡æ¯: {ex.Message}");
                        Console.WriteLine($"   å †æ ˆè·Ÿè¸ª: {ex.StackTrace}");
                    }
                }
                
                StatusMessage = $"ä¿æœ¬æ­¢æŸæ·»åŠ å®Œæˆ: æˆåŠŸ {successCount} ä¸ªï¼Œå¤±è´¥ {failedCount} ä¸ª";
                Console.WriteLine($"\nğŸ æ‰¹é‡ä¿æœ¬æ­¢æŸå®Œæˆ: æˆåŠŸ {successCount} ä¸ªï¼Œå¤±è´¥ {failedCount} ä¸ª");
                
                System.Windows.MessageBox.Show(
                    $"ä¿æœ¬æ­¢æŸæ·»åŠ æ“ä½œå®Œæˆï¼\n\nğŸ¯ æˆåŠŸæ·»åŠ : {successCount} ä¸ª\nğŸ”§ æ·»åŠ å¤±è´¥: {failedCount} ä¸ª",
                    "æ“ä½œç»“æœ",
                    System.Windows.MessageBoxButton.OK,
                    failedCount > 0 ? System.Windows.MessageBoxImage.Warning : System.Windows.MessageBoxImage.Information);
                
                // åˆ·æ–°æ•°æ®
                await RefreshDataAsync();
            }
            catch (Exception ex)
            {
                StatusMessage = $"æ‰¹é‡æ·»åŠ ä¿æœ¬æ­¢æŸå¼‚å¸¸: {ex.Message}";
                Console.WriteLine($"ğŸ”§ æ‰¹é‡æ·»åŠ ä¿æœ¬æ­¢æŸé¡¶å±‚å¼‚å¸¸: {ex.Message}");
                Console.WriteLine($"   å¼‚å¸¸å †æ ˆ: {ex.StackTrace}");
                
                System.Windows.MessageBox.Show(
                    $"æ‰¹é‡æ·»åŠ ä¿æœ¬æ­¢æŸæ—¶å‘ç”Ÿå¼‚å¸¸ï¼š\n\n{ex.Message}",
                    "æ“ä½œå¼‚å¸¸",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
            finally
            {
                IsLoading = false;
                Console.WriteLine("ğŸ ä¿æœ¬æ­¢æŸæ“ä½œå®Œæˆ");
            }
        }
        
        // === æŒä»“é€‰æ‹©ç›¸å…³å‘½ä»¤ ===
        
        [RelayCommand]
        private void SelectAllPositions()
        {
            try
            {
                Console.WriteLine($"ğŸ”² å…¨é€‰æŒä»“æ“ä½œ...");
                foreach (var position in Positions)
                {
                    position.IsSelected = true;
                }
                
                OnPropertyChanged(nameof(SelectedPositions));
                OnPropertyChanged(nameof(HasSelectedPositions));
                OnPropertyChanged(nameof(SelectedPositionCount));
                
                StatusMessage = $"å·²å…¨é€‰{Positions.Count} ä¸ªæŒä»“";
                Console.WriteLine($"ğŸ”§ æŒä»“å…¨é€‰å®Œæˆ {Positions.Count} ä¸ªæŒä»“");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ğŸ”§ å…¨é€‰æŒä»“å¼‚å¸¸: {ex.Message}");
                StatusMessage = $"å…¨é€‰æŒä»“å¤±? {ex.Message}";
            }
        }
        
        [RelayCommand]
        private void UnselectAllPositions()
        {
            try
            {
                Console.WriteLine($"ğŸ”§ å–æ¶ˆå…¨é€‰æŒä»“æ“ä½œ...");
                foreach (var position in Positions)
                {
                    position.IsSelected = false;
                }
                
                OnPropertyChanged(nameof(SelectedPositions));
                OnPropertyChanged(nameof(HasSelectedPositions));
                OnPropertyChanged(nameof(SelectedPositionCount));
                
                StatusMessage = $"å·²å–æ¶ˆé€‰æ‹©æ‰€æœ‰æŒä»“";
                Console.WriteLine($"ğŸ”§ å–æ¶ˆæŒä»“å…¨é€‰å®Œæˆ");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ğŸ”§ å–æ¶ˆå…¨é€‰æŒä»“å¼‚å¸¸: {ex.Message}");
                StatusMessage = $"å–æ¶ˆå…¨é€‰æŒä»“å¤±? {ex.Message}";
            }
        }
        
        [RelayCommand]
        private void InvertPositionSelection()
        {
            try
            {
                Console.WriteLine($"ğŸ”„ åé€‰æŒä»“æ“ä½œ...");
                foreach (var position in Positions)
                {
                    position.IsSelected = !position.IsSelected;
                }
                
                OnPropertyChanged(nameof(SelectedPositions));
                OnPropertyChanged(nameof(HasSelectedPositions));
                OnPropertyChanged(nameof(SelectedPositionCount));
                
                var selectedCount = Positions.Count(p => p.IsSelected);
                StatusMessage = $"æŒä»“åé€‰å®Œæˆï¼Œå½“å‰é€‰ä¸­ {selectedCount} ä¸ªæŒä»“";
                Console.WriteLine($"ğŸ”„ æŒä»“åé€‰å®Œæˆ å½“å‰é€‰ä¸­ {selectedCount} ä¸ªæŒä»“");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ğŸ”„ åé€‰æŒä»“å¼‚å¸¸: {ex.Message}");
                StatusMessage = $"åé€‰æŒä»“å¤±? {ex.Message}";
            }
        }
        
        [RelayCommand]
        private async Task CloseSelectedPositionsAsync()
        {
            try
            {
                var selectedPositions = Positions.Where(p => p.IsSelected).ToList();
                
                if (!selectedPositions.Any())
                {
                    StatusMessage = "è¯·å…ˆé€‰æ‹©è¦å¹³ä»“çš„æŒä»“";
                    System.Windows.MessageBox.Show(
                        "è¯·å…ˆå‹¾é€‰è¦å¹³ä»“çš„æŒä»“",
                        "æœªé€‰æ‹©æŒä»“",
                        System.Windows.MessageBoxButton.OK,
                        System.Windows.MessageBoxImage.Warning);
                    return;
                }
                
                var result = System.Windows.MessageBox.Show(
                    $"ç¡®å®šè¦å¹³æ‰é€‰ä¸­æŒä»“{selectedPositions.Count} ä¸ªå—ï¼Ÿ\n\næ­¤æ“ä½œå°†å¸‚ä»·å¹³ä»“ï¼Œä¸å¯æ’¤é”€?,
                    "æ‰¹é‡å¹³ä»“ç¡®è®¤",
                    System.Windows.MessageBoxButton.YesNo,
                    System.Windows.MessageBoxImage.Question);

                if (result != System.Windows.MessageBoxResult.Yes)
                    return;

                IsLoading = true;
                StatusMessage = $"æ­£åœ¨å¹³ä»“ {selectedPositions.Count} ä¸ªé€‰ä¸­çš„æŒä»“...";
                
                int successCount = 0;
                int failedCount = 0;
                
                foreach (var position in selectedPositions)
                {
                    try
                    {
                        Console.WriteLine($"ğŸ“¤ å¹³ä»“æŒä»“: {position.Symbol} {position.PositionAmt}");
                        var success = await _binanceService.ClosePositionAsync(position.Symbol, position.PositionSideString);
                        
                        if (success)
                        {
                            successCount++;
                            Console.WriteLine($"ğŸ”§ æŒä»“å¹³ä»“æˆåŠŸ: {position.Symbol}");
                        }
                        else
                        {
                            failedCount++;
                            Console.WriteLine($"ğŸ”§ æŒä»“å¹³ä»“å¤±è´¥: {position.Symbol}");
                        }
                    }
                    catch (Exception ex)
                    {
                        failedCount++;
                        Console.WriteLine($"ğŸ”§ å¹³ä»“æŒä»“å¼‚å¸¸: {position.Symbol}, {ex.Message}");
                    }
                }
                
                StatusMessage = $"æ‰¹é‡å¹³ä»“å®Œæˆ: æˆåŠŸ {successCount} ä¸ªï¼Œå¤±è´¥ {failedCount} ä¸ª";
                
                System.Windows.MessageBox.Show(
                    $"æ‰¹é‡å¹³ä»“æ“ä½œå®Œæˆï¼\n\nğŸ¯ æˆåŠŸå¹³ä»“: {successCount} ä¸ª\nğŸ”§ å¹³ä»“å¤±è´¥: {failedCount} ä¸ª",
                    "å¹³ä»“ç»“æœ",
                    System.Windows.MessageBoxButton.OK,
                    failedCount > 0 ? System.Windows.MessageBoxImage.Warning : System.Windows.MessageBoxImage.Information);
                
                // åˆ·æ–°æ•°æ®
                await RefreshDataAsync();
            }
            catch (Exception ex)
            {
                StatusMessage = $"æ‰¹é‡å¹³ä»“å¼‚å¸¸: {ex.Message}";
                Console.WriteLine($"ğŸ”„ æ‰¹é‡å¹³ä»“å¼‚å¸¸: {ex.Message}");
                
                System.Windows.MessageBox.Show(
                    $"æ‰¹é‡å¹³ä»“æ—¶å‘ç”Ÿå¼‚å¸¸ï¼š\n\n{ex.Message}",
                    "æ“ä½œå¼‚å¸¸",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
            finally
            {
                IsLoading = false;
            }
        }
        
        [RelayCommand]
        private async Task AddBreakEvenStopLossForSelectedPositionsAsync()
        {
            try
            {
                var selectedPositions = Positions.Where(p => p.IsSelected && Math.Abs(p.PositionAmt) > 0).ToList();
                
                if (!selectedPositions.Any())
                {
                    StatusMessage = "è¯·å…ˆé€‰æ‹©è¦æ·»åŠ ä¿æœ¬æ­¢æŸçš„æŒä»“";
                    System.Windows.MessageBox.Show(
                        "è¯·å…ˆå‹¾é€‰è¦æ·»åŠ ä¿æœ¬æ­¢æŸçš„æŒä»“",
                        "æœªé€‰æ‹©æŒä»“",
                        System.Windows.MessageBoxButton.OK,
                        System.Windows.MessageBoxImage.Warning);
                    return;
                }
                
                var result = System.Windows.MessageBox.Show(
                    $"ç¡®å®šè¦ä¸ºé€‰ä¸­æŒä»“{selectedPositions.Count} ä¸ªæ·»åŠ ä¿æœ¬æ­¢æŸå—ï¼Ÿ\n\n" +
                    $"å°†ä¸ºæ¯ä¸ªæŒä»“è®¾ç½®ä»¥å¼€ä»“ä»·ä¸ºè§¦å‘ä»·çš„æ­¢æŸå•ã€‚\n\næ­¤æ“ä½œä¸å¯æ’¤é”€?,
                    "æ‰¹é‡ä¿æœ¬æ­¢æŸç¡®è®¤",
                    System.Windows.MessageBoxButton.YesNo,
                    System.Windows.MessageBoxImage.Question);

                if (result != System.Windows.MessageBoxResult.Yes)
                    return;

                IsLoading = true;
                StatusMessage = $"æ­£åœ¨ä¸º{selectedPositions.Count} ä¸ªæŒä»“æ·»åŠ ä¿æœ¬æ­¢æŸ...";
                
                int successCount = 0;
                int failedCount = 0;
                
                foreach (var position in selectedPositions)
                {
                    try
                    {
                        Console.WriteLine($"ğŸ›¡ï¿½?ä¸ºæŒä»“æ·»åŠ ä¿æœ¬æ­¢æŸ {position.Symbol} {position.PositionAmt}");
                        
                        // æ„å»ºä¿æœ¬æ­¢æŸ?                        var stopLossOrder = new OrderRequest
                        {
                            Symbol = position.Symbol,
                            Side = position.PositionAmt > 0 ? "SELL" : "BUY", // åå‘æ“ä½œ
                            PositionSide = position.PositionSideString,
                            Type = "STOP_MARKET", // å¸‚ä»·æ­¢æŸï¿½?                            Quantity = Math.Abs(position.PositionAmt), // ç›¸åŒæ•°é‡
                            StopPrice = position.EntryPrice, // è§¦å‘ï¿½?å¼€ä»“ä»·
                            ReduceOnly = true, // åªå‡ï¿½?                            Leverage = position.Leverage,
                            MarginType = position.MarginType,
                            WorkingType = "CONTRACT_PRICE" // ä½¿ç”¨åˆçº¦ä»·æ ¼è§¦å‘
                        };

                        Console.WriteLine($"ğŸ“‹ æ­¢æŸå•è¯¦æƒ…: {stopLossOrder.Side} {stopLossOrder.Quantity:F6} {stopLossOrder.Symbol} @ {PriceFormatConverter.FormatPrice(stopLossOrder.StopPrice)}");

                        var success = await _binanceService.PlaceOrderAsync(stopLossOrder);
                        
                        if (success)
                        {
                            successCount++;
                            Console.WriteLine($"ğŸ”§ ä¿æœ¬æ­¢æŸæ·»åŠ æˆåŠŸ: {position.Symbol} @ {position.EntryPrice}");
                        }
                        else
                        {
                            failedCount++;
                            Console.WriteLine($"ğŸ”§ ä¿æœ¬æ­¢æŸæ·»åŠ å¤±è´¥: {position.Symbol}");
                        }
                    }
                    catch (Exception ex)
                    {
                        failedCount++;
                        Console.WriteLine($"ğŸ”§ æ·»åŠ ä¿æœ¬æ­¢æŸå¼‚å¸¸: {position.Symbol}, {ex.Message}");
                    }
                }
                
                StatusMessage = $"ä¿æœ¬æ­¢æŸæ·»åŠ å®Œæˆ: æˆåŠŸ {successCount} ä¸ªï¼Œå¤±è´¥ {failedCount} ä¸ª";
                
                System.Windows.MessageBox.Show(
                    $"ä¿æœ¬æ­¢æŸæ·»åŠ æ“ä½œå®Œæˆï¼\n\nğŸ¯ æˆåŠŸæ·»åŠ : {successCount} ä¸ª\nğŸ”§ æ·»åŠ å¤±è´¥: {failedCount} ä¸ª",
                    "æ“ä½œç»“æœ",
                    System.Windows.MessageBoxButton.OK,
                    failedCount > 0 ? System.Windows.MessageBoxImage.Warning : System.Windows.MessageBoxImage.Information);
                
                // åˆ·æ–°æ•°æ®
                await RefreshDataAsync();
            }
            catch (Exception ex)
            {
                StatusMessage = $"æ‰¹é‡æ·»åŠ ä¿æœ¬æ­¢æŸå¼‚å¸¸: {ex.Message}";
                Console.WriteLine($"ğŸ”§ æ‰¹é‡æ·»åŠ ä¿æœ¬æ­¢æŸå¼‚å¸¸: {ex.Message}");
                
                System.Windows.MessageBox.Show(
                    $"æ‰¹é‡æ·»åŠ ä¿æœ¬æ­¢æŸæ—¶å‘ç”Ÿå¼‚å¸¸ï¼š\n\n{ex.Message}",
                    "æ“ä½œå¼‚å¸¸",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
            finally
            {
                IsLoading = false;
            }
        }
        
        [RelayCommand]
        private void OpenLogFile()
        {
            try
            {
                var logFilePath = LogService.GetLogFilePath();
                LogService.LogInfo($"æ‰“å¼€æ—¥å¿—æ–‡ä»¶: {logFilePath}");
                
                // ä½¿ç”¨é»˜è®¤ç¨‹åºæ‰“å¼€æ—¥å¿—æ–‡ä»¶
                System.Diagnostics.Process.Start(new System.Diagnostics.ProcessStartInfo
                {
                    FileName = logFilePath,
                    UseShellExecute = true
                });
                
                StatusMessage = "å·²æ‰“å¼€æ—¥å¿—æ–‡ä»¶";
            }
            catch (Exception ex)
            {
                LogService.LogError($"æ‰“å¼€æ—¥å¿—æ–‡ä»¶å¤±è´¥", ex);
                StatusMessage = $"æ‰“å¼€æ—¥å¿—æ–‡ä»¶å¤±è´¥: {ex.Message}";
                
                // æ˜¾ç¤ºæ—¥å¿—æ–‡ä»¶è·¯å¾„è®©ç”¨æˆ·æ‰‹åŠ¨æ‰“å¼€
                var logFilePath = LogService.GetLogFilePath();
                System.Windows.MessageBox.Show(
                    $"æ— æ³•è‡ªåŠ¨æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€ï¼š\n\n{logFilePath}",
                    "æ‰“å¼€æ—¥å¿—æ–‡ä»¶",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Information);
            }
        }
        
        [RelayCommand]
        private void ClearLogFile()
        {
            try
            {
                var result = System.Windows.MessageBox.Show(
                    "ç¡®å®šè¦æ¸…ç©ºæ—¥å¿—æ–‡ä»¶å—ï¼Ÿ\n\næ¸…ç©ºåå°†æ— æ³•æŸ¥çœ‹ä¹‹å‰çš„æ—¥å¿—è®°å½•?",
                    "æ¸…ç©ºæ—¥å¿—ç¡®è®¤",
                    System.Windows.MessageBoxButton.YesNo,
                    System.Windows.MessageBoxImage.Question);

                if (result == System.Windows.MessageBoxResult.Yes)
                {
                    LogService.ClearLogFile();
                    StatusMessage = "æ—¥å¿—æ–‡ä»¶å·²æ¸…ç©º";
                }
            }
            catch (Exception ex)
            {
                LogService.LogError($"æ¸…ç©ºæ—¥å¿—æ–‡ä»¶å¤±è´¥", ex);
                StatusMessage = $"æ¸…ç©ºæ—¥å¿—æ–‡ä»¶å¤±è´¥: {ex.Message}";
            }
        }

        private decimal AdjustPricePrecision(decimal price, string symbol)
        {
            // æ ¹æ®ä¸åŒåˆçº¦è°ƒæ•´ä»·æ ¼ç²¾åº¦
            var adjustedPrice = symbol.ToUpper() switch
            {
                "BTCUSDT" => Math.Round(price, 1),    // BTC: 1ä½å°ï¿½?(ï¿½?45000.1)
                "ETHUSDT" => Math.Round(price, 2),    // ETH: 2ä½å°ï¿½?(ï¿½?2800.25)
                "BNBUSDT" => Math.Round(price, 3),    // BNB: 3ä½å°ï¿½?(ï¿½?320.125)
                "ADAUSDT" => Math.Round(price, 4),    // ADA: 4ä½å°ï¿½?(ï¿½?0.5234)
                "DOGEUSDT" => Math.Round(price, 5),   // DOGE: 5ä½å°ï¿½?(ï¿½?0.08123)
                "SOLUSDT" => Math.Round(price, 3),    // SOL: 3ä½å°ï¿½?                "DOTUSDT" => Math.Round(price, 3),    // DOT: 3ä½å°ï¿½?                "LINKUSDT" => Math.Round(price, 3),   // LINK: 3ä½å°ï¿½?                "LTCUSDT" => Math.Round(price, 2),    // LTC: 2ä½å°ï¿½?                "BCHUSDT" => Math.Round(price, 2),    // BCH: 2ä½å°ï¿½?                "XRPUSDT" => Math.Round(price, 4),    // XRP: 4ä½å°ï¿½?                "MATICUSDT" => Math.Round(price, 4),  // MATIC: 4ä½å°ï¿½?                "AVAXUSDT" => Math.Round(price, 3),   // AVAX: 3ä½å°ï¿½?                "UNIUSDT" => Math.Round(price, 3),    // UNI: 3ä½å°ï¿½?                "ATOMUSDT" => Math.Round(price, 3),   // ATOM: 3ä½å°ï¿½?                _ => Math.Round(price, 4) // é»˜è®¤: 4ä½å°ï¿½?            };
            
            Console.WriteLine($"ğŸ¯ ä»·æ ¼ç²¾åº¦è°ƒæ•´: {symbol} {price:F8} ğŸ”§ {adjustedPrice:F8}");
            return adjustedPrice;
        }

        [RelayCommand]
        private async Task CheckOrderHistoryAsync()
        {
            if (SelectedAccount == null)
            {
                StatusMessage = "è¯·å…ˆé€‰æ‹©è´¦æˆ·";
                return;
            }

            Console.WriteLine("\nğŸ” å¼€å§‹æ£€æŸ¥è®¢å•å†å²ï¼Œå¯»æ‰¾ä¸¢å¤±çš„æ­¢æŸå•...");
            
            IsLoading = true;
            StatusMessage = "æ­£åœ¨æŸ¥è¯¢è®¢å•å†å²...";
            
            try
            {
                // è·å–æœ€ï¿½?0æ¡è®¢å•å†å²
                var allOrders = await _binanceService.GetAllOrdersAsync(limit: 50);
                
                Console.WriteLine($"ğŸ“Š è·å–åˆ°{allOrders.Count} æ¡å†å²è®¢å•");
                
                // ç­›é€‰STOP_MARKETè®¢å•
                var stopMarketOrders = allOrders.Where(o => o.Type == "STOP_MARKET").ToList();
                Console.WriteLine($"ğŸ›¡ï¿½?å†å²ä¸­çš„STOP_MARKETè®¢å•: {stopMarketOrders.Count} ä¸ª");
                
                if (stopMarketOrders.Any())
                {
                    Console.WriteLine("\nğŸ“‹ æ­¢æŸå•è¯¦ç»†ä¿¡æ¯");
                    foreach (var order in stopMarketOrders.OrderByDescending(o => o.UpdateTime))
                    {
                        var statusEmoji = order.Status switch
                        {
                            "FILLED" => "ğŸ‰",
                            "CANCELED" => "âŒ", 
                            "EXPIRED" => "â³",
                            "NEW" => "ğŸ†•",
                            _ => "â“"
                        };
                        
                        Console.WriteLine($"   {statusEmoji} OrderId: {order.OrderId}");
                        Console.WriteLine($"      åˆçº¦: {order.Symbol}");
                        Console.WriteLine($"      æ–¹å‘: {order.Side}");
                        Console.WriteLine($"      çŠ¶æ€ {order.Status}");
                        Console.WriteLine($"      è§¦å‘ä»· {PriceFormatConverter.FormatPrice(order.StopPrice)}");
                        Console.WriteLine($"      æ•°é‡: {order.OrigQty} (å·²æ‰§è¡Œ {order.ExecutedQty})");
                        Console.WriteLine($"      çŠ¶ï¿½? {order.Status}");
                        Console.WriteLine($"      è§¦å‘ï¿½? {PriceFormatConverter.FormatPrice(order.StopPrice)}");
                        Console.WriteLine($"      æ•°é‡: {order.OrigQty} (å·²æ‰§ï¿½? {order.ExecutedQty})");
                        Console.WriteLine($"      åˆ›å»ºæ—¶é—´: {order.Time:yyyy-MM-dd HH:mm:ss}");
                        Console.WriteLine($"      æ›´æ–°æ—¶é—´: {order.UpdateTime:yyyy-MM-dd HH:mm:ss}");
                        Console.WriteLine();
                    }
                    
                    // ç»Ÿè®¡å„ç§çŠ¶ï¿½?                    var statusStats = stopMarketOrders.GroupBy(o => o.Status)
                        .ToDictionary(g => g.Key, g => g.Count());
                    
                    var statsMessage = "æ­¢æŸå•çŠ¶æ€ç»Ÿï¿½?\n";
                    foreach (var stat in statusStats)
                    {
                        var emoji = stat.Key switch
                        {
                            "FILLED" => "ï¿½?å·²æ‰§ï¿½?,
                            "CANCELED" => "ï¿½?å·²å–ï¿½?,
                            "EXPIRED" => "ï¿½?å·²è¿‡ï¿½?,
                            "NEW" => "ğŸ†• æœªæˆï¿½?,
                            _ => "ï¿½?å…¶ä»–"
                        };
                        statsMessage += $"  {emoji}: {stat.Value} ä¸ª\n";
                    }
                    
                    Console.WriteLine($"ğŸ“Š {statsMessage}");
                    StatusMessage = $"æ‰¾åˆ° {stopMarketOrders.Count} ä¸ªæ­¢æŸå•å†å²è®°å½•";
                    
                    // æ˜¾ç¤ºç»“æœå¯¹è¯ï¿½?                    App.Current.Dispatcher.Invoke(() =>
                    {
                        System.Windows.MessageBox.Show(
                            $"è®¢å•å†å²æŸ¥è¯¢å®Œæˆï¼\n\næ‰¾åˆ° {stopMarketOrders.Count} ä¸ªæ­¢æŸå•å†å²è®°å½•\n\n{statsMessage}\nè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦ç»†ä¿¡æ¯ï¿½?,
                            "è®¢å•å†å²æŸ¥è¯¢ç»“æœ",
                            System.Windows.MessageBoxButton.OK,
                            System.Windows.MessageBoxImage.Information);
                    });
                }
                else
                {
                    Console.WriteLine("ğŸ¤” å†å²è®°å½•ä¸­æ²¡æœ‰æ‰¾åˆ°STOP_MARKETè®¢å•");
                    StatusMessage = "å†å²è®°å½•ä¸­æ²¡æœ‰æ‰¾åˆ°æ­¢æŸå•";
                    
                    App.Current.Dispatcher.Invoke(() =>
                    {
                        System.Windows.MessageBox.Show(
                            "å†å²è®°å½•ä¸­æ²¡æœ‰æ‰¾åˆ°æ­¢æŸå•ï¼\n\nå¯èƒ½çš„åŸï¿½?\n" +
                            "ï¿½?è®¢å•è¿˜æ²¡æœ‰è¢«åˆ›å»º\n" +
                            "ï¿½?è®¢å•åœ¨æ›´æ—©çš„å†å²ä¸­\n" +
                            "ï¿½?APIé…ç½®é—®é¢˜\n\n" +
                            "å»ºè®®:\n1. æ£€æŸ¥APIé…ç½®æ˜¯å¦æ­£ç¡®\n2. å°è¯•é‡æ–°ä¸‹å•\n3. æŸ¥çœ‹å®Œæ•´çš„äº¤æ˜“å†ï¿½?,
                            "æœªæ‰¾åˆ°æ­¢æŸå•",
                            System.Windows.MessageBoxButton.OK,
                            System.Windows.MessageBoxImage.Warning);
                    });
                }
                
                // åŒæ—¶æ˜¾ç¤ºæœ€è¿‘çš„å‡ ä¸ªè®¢å•ä½œä¸ºå‚ï¿½?                var recentOrders = allOrders.OrderByDescending(o => o.UpdateTime).Take(10).ToList();
                Console.WriteLine($"\nğŸ“‹ æœ€ï¿½?0ä¸ªè®¢å•ï¼ˆä½œä¸ºå‚è€ƒï¼‰:");
                foreach (var order in recentOrders)
                {
                    Console.WriteLine($"   OrderId: {order.OrderId}, Type: {order.Type}, Status: {order.Status}, Symbol: {order.Symbol}, Time: {order.UpdateTime:MM-dd HH:mm:ss}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ï¿½?æŸ¥è¯¢è®¢å•å†å²å¼‚å¸¸: {ex.Message}");
                StatusMessage = $"æŸ¥è¯¢è®¢å•å†å²å¤±è´¥: {ex.Message}";
                
                App.Current.Dispatcher.Invoke(() =>
                {
                    System.Windows.MessageBox.Show(
                        $"æŸ¥è¯¢è®¢å•å†å²æ—¶å‘ç”Ÿå¼‚ï¿½?\n\n{ex.Message}",
                        "æŸ¥è¯¢å¼‚å¸¸",
                        System.Windows.MessageBoxButton.OK,
                        System.Windows.MessageBoxImage.Error);
                });
            }
            finally
            {
                IsLoading = false;
            }
        }

        // è·å–äº¤æ˜“è§„åˆ™ä¿¡æ¯ï¼Œä½¿ç”¨çœŸå®API
        private async Task<(decimal minQuantity, decimal maxQuantity, int maxLeverage, decimal maxNotional, decimal estimatedPrice)> GetExchangeInfoAsync(string symbol)
        {
            Console.WriteLine($"ğŸ” å‡†å¤‡è·å– {symbol} çš„çœŸå®äº¤æ˜“è§„ï¿½?..");
            
            try
            {
                // è°ƒç”¨çœŸå®çš„å¸å®‰APIè·å–äº¤æ˜“è§„åˆ™
                var realExchangeInfo = await _binanceService.GetRealExchangeInfoAsync(symbol);
                
                Console.WriteLine($"ï¿½?æˆåŠŸè·å– {symbol} çš„çœŸå®äº¤æ˜“è§„ï¿½?);
                Console.WriteLine($"ğŸ“¦ æ•°é‡èŒƒå›´: {realExchangeInfo.minQuantity} - {realExchangeInfo.maxQuantity}");
                Console.WriteLine($"ğŸšï¿½?æœ€å¤§æ ï¿½? {realExchangeInfo.maxLeverage}x");
                Console.WriteLine($"ğŸ’µ æœ€å¤§åä¹‰ä»·ï¿½? {realExchangeInfo.maxNotional}");
                
                // è·å–å½“å‰ä»·æ ¼ä½œä¸ºä¼°ä»·
                var currentPrice = await _binanceService.GetLatestPriceAsync(symbol);
                
                // ç¼“å­˜æœ€æ–°ä»·æ ¼åˆ°æœåŠ¡ï¿½?                _binanceService.UpdateLatestPriceCache(currentPrice);
                
                return (
                    realExchangeInfo.minQuantity,
                    realExchangeInfo.maxQuantity,
                    realExchangeInfo.maxLeverage,
                    realExchangeInfo.maxNotional,
                    currentPrice
                );
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ï¿½?è·å–çœŸå®äº¤æ˜“è§„åˆ™å¤±è´¥: {ex.Message}");
                Console.WriteLine($"âš ï¸ å°†ä½¿ç”¨å¤‡é€‰æ–¹ï¿½?..");
                
                // å¦‚æœçœŸå®APIå¤±è´¥ï¼Œä½¿ç”¨å¤‡é€‰æ–¹ï¿½?                return await GetFallbackExchangeInfoAsync(symbol);
            }
        }

        // å¤‡é€‰äº¤æ˜“è§„åˆ™æ–¹æ¡ˆï¼ˆä»…åœ¨çœŸå®APIå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
        private async Task<(decimal minQuantity, decimal maxQuantity, int maxLeverage, decimal maxNotional, decimal estimatedPrice)> GetFallbackExchangeInfoAsync(string symbol)
        {
            Console.WriteLine($"âš ï¸ ä½¿ç”¨å¤‡é€‰äº¤æ˜“è§„åˆ™æ–¹ï¿½? {symbol}");
            
            // è·å–å½“å‰ä»·æ ¼
            var currentPrice = await _binanceService.GetLatestPriceAsync(symbol);
            
            decimal minQuantity, maxQuantity;
            int maxLeverage = 20;
            decimal maxNotional = 100000m;

            // æ ¹æ®ä»·æ ¼åŠ¨æ€è°ƒæ•´é™ï¿½?            if (currentPrice >= 1000m) // é«˜ä»·å¸ï¼ˆå¦‚BTCï¿½?            {
                minQuantity = 0.001m;
                maxQuantity = 1000m;  // æ›´ä¿å®ˆçš„æœ€å¤§ï¿½?                maxLeverage = 125;
                maxNotional = 2000000m;
            }
            else if (currentPrice >= 100m) // ä¸­é«˜ä»·å¸ï¼ˆå¦‚ETHï¿½?            {
                minQuantity = 0.001m;
                maxQuantity = 10000m;
                maxLeverage = 100;
                maxNotional = 1000000m;
            }
            else if (currentPrice >= 10m) // ä¸­ä»·å¸ï¼ˆå¦‚BNBï¿½?            {
                minQuantity = 0.01m;
                maxQuantity = 100000m;
                maxLeverage = 75;
                maxNotional = 500000m;
            }
            else if (currentPrice >= 1m) // ä¸€èˆ¬ä»·å¸ï¼ˆå¦‚DOTï¿½?            {
                minQuantity = 0.1m;
                maxQuantity = 1000000m;
                maxLeverage = 75;
                maxNotional = 200000m;
            }
            else if (currentPrice >= 0.1m) // ä½ä»·å¸ï¼ˆå¦‚ADAï¿½?            {
                minQuantity = 1m;
                maxQuantity = 10000000m;  // ä½¿ç”¨æ›´å¤§çš„æœ€å¤§å€¼ä»¥é€‚åº”çœŸå®äº¤æ˜“éœ€ï¿½?                maxLeverage = 75;
                maxNotional = 100000m;
            }
            else if (currentPrice >= 0.01m) // å¾ˆä½ä»·å¸ï¼ˆå¦‚DOGEï¿½?            {
                minQuantity = 10m;
                maxQuantity = 100000000m;
                maxLeverage = 50;
                maxNotional = 100000m;
            }
            else // è¶…ä½ä»·å¸ï¼ˆå¦‚PEPEã€SHIBç­‰ï¼‰
            {
                minQuantity = 1000m;
                maxQuantity = 10000000000m;  // è¶…ä½ä»·å¸éœ€è¦æå¤§çš„æ•°é‡
                maxLeverage = 25;
                maxNotional = 25000m;
            }

            Console.WriteLine($"ğŸ“‹ å¤‡é€‰è§„åˆ™ç»“ï¿½? ä»·æ ¼={currentPrice:F6}, æ•°é‡èŒƒå›´={minQuantity}-{maxQuantity}, æ æ†={maxLeverage}x");
            
            return (minQuantity, maxQuantity, maxLeverage, maxNotional, currentPrice);
        }

        [RelayCommand]
        private async Task QueryContractInfoAsync()
        {
            if (string.IsNullOrEmpty(Symbol) || SelectedAccount == null)
            {
                StatusMessage = "è¯·è¾“å…¥åˆçº¦åç§°å¹¶é€‰æ‹©è´¦æˆ·";
                return;
            }

            Console.WriteLine($"ğŸ” å¼€å§‹æŸ¥è¯¢åˆçº¦ä¿¡ï¿½? {Symbol}");
            
            IsLoading = true;
            StatusMessage = $"æ­£åœ¨æŸ¥è¯¢ {Symbol} çš„åˆçº¦ä¿¡ï¿½?..";
            
            try
            {
                // ç¬¬ä¸€æ­¥ï¼šè·å–æœ€æ–°ä»·ï¿½?                Console.WriteLine($"ğŸ“Š æ­¥éª¤1: è·å– {Symbol} çš„æœ€æ–°ä»·ï¿½?..");
                var newPrice = await _binanceService.GetLatestPriceAsync(Symbol);
                
                if (newPrice > 0)
                {
                    var oldPrice = LatestPrice;
                    LatestPrice = newPrice;
                    var formattedPrice = PriceFormatConverter.FormatPrice(newPrice);
                    Console.WriteLine($"ï¿½?ä»·æ ¼æ›´æ–°: {Symbol} = {formattedPrice}");
                    
                    // æ›´æ–°ä»·æ ¼ç¼“å­˜åˆ°æœåŠ¡ä¸­
                    _binanceService.UpdateLatestPriceCache(newPrice);
                }
                else
                {
                    Console.WriteLine($"ï¿½?è·å– {Symbol} ä»·æ ¼å¤±è´¥");
                    StatusMessage = $"è·å– {Symbol} ä»·æ ¼å¤±è´¥ï¼Œè¯·æ£€æŸ¥åˆçº¦åç§°æ˜¯å¦æ­£ï¿½?;
                    return;
                }

                // ç¬¬äºŒæ­¥ï¼šè·å–äº¤æ˜“è§„åˆ™ä¿¡æ¯
                Console.WriteLine($"ğŸ“‹ æ­¥éª¤2: è·å– {Symbol} çš„äº¤æ˜“è§„ï¿½?..");
                var (minQuantity, maxQuantity, maxLeverage, maxNotional, estimatedPrice) = await GetExchangeInfoAsync(Symbol);
                
                Console.WriteLine($"ï¿½?äº¤æ˜“è§„åˆ™è·å–æˆåŠŸ:");
                Console.WriteLine($"   ğŸ“¦ æ•°é‡èŒƒå›´: {minQuantity} - {maxQuantity}");
                Console.WriteLine($"   ğŸšï¿½?æœ€å¤§æ ï¿½? {maxLeverage}x");
                Console.WriteLine($"   ğŸ’µ æœ€å¤§åä¹‰ä»·ï¿½? {maxNotional}");

                // ç¬¬ä¸‰æ­¥ï¼šè·å–è¯¥åˆçº¦çš„æŒä»“ä¿¡æ¯
                Console.WriteLine($"ğŸ“ˆ æ­¥éª¤3: åˆ·æ–° {Symbol} ç›¸å…³çš„æŒä»“å’Œè®¢å•...");
                var positions = await _binanceService.GetPositionsAsync();
                var contractPosition = positions.FirstOrDefault(p => p.Symbol == Symbol && Math.Abs(p.PositionAmt) > 0);
                
                if (contractPosition != null)
                {
                    Console.WriteLine($"ï¿½?æ‰¾åˆ° {Symbol} çš„æŒï¿½? {contractPosition.PositionAmt}, å¼€ä»“ä»·: {contractPosition.EntryPrice}");
                    
                    // è‡ªåŠ¨é€‰æ‹©è¯¥æŒï¿½?                    SelectedPosition = contractPosition;
                    
                    // æ›´æ–°æŒä»“åˆ—è¡¨
                    Positions.Clear();
                    foreach (var position in positions)
                    {
                        if (position.Symbol == Symbol && Math.Abs(position.PositionAmt) > 0)
                        {
                            position.IsSelected = true; // è‡ªåŠ¨é€‰ä¸­è¯¥åˆçº¦çš„æŒä»“
                        }
                        Positions.Add(position);
                    }
                    
                    // è¿‡æ»¤æ˜¾ç¤ºè¯¥åˆçº¦çš„è®¢å•
                    FilterOrdersForPosition(Symbol);
                }
                else
                {
                    Console.WriteLine($"â„¹ï¸ {Symbol} å½“å‰æ— æŒï¿½?);
                }

                // ç¬¬å››æ­¥ï¼šè·å–è¯¥åˆçº¦çš„è®¢å•ä¿¡æ¯
                var orders = await _binanceService.GetOpenOrdersAsync(Symbol);
                Console.WriteLine($"ğŸ“‹ æ‰¾åˆ° {Symbol} çš„è®¢ï¿½? {orders.Count} ï¿½?);
                
                // æ›´æ–°è¿‡æ»¤çš„è®¢å•åˆ—ï¿½?                FilteredOrders.Clear();
                foreach (var order in orders)
                {
                    FilteredOrders.Add(order);
                }

                // ç¬¬äº”æ­¥ï¼šå¦‚æœæœ‰æ­¢æŸæ¯”ä¾‹ï¼Œé‡æ–°è®¡ç®—æ­¢æŸï¿½?                if (StopLossRatio > 0)
                {
                    Console.WriteLine($"ğŸ¯ æ­¥éª¤4: é‡æ–°è®¡ç®— {Symbol} çš„æ­¢æŸä»·...");
                    CalculateStopLossPrice();
                }

                // ç¬¬å…­æ­¥ï¼šæ›´æ–°å»ºè®®çš„æ æ†è®¾ï¿½?                if (maxLeverage > 0 && Leverage > maxLeverage)
                {
                    Console.WriteLine($"âš ï¸ å½“å‰æ æ† {Leverage}x è¶…è¿‡ {Symbol} æœ€å¤§æ ï¿½?{maxLeverage}xï¼Œè‡ªåŠ¨è°ƒï¿½?);
                    Leverage = Math.Min(maxLeverage, 20); // è®¾ç½®ä¸ºæœ€å¤§æ æ†æˆ–20xï¼Œå–è¾ƒå°ï¿½?                }

                // å¼ºåˆ¶åˆ·æ–°UIå±ï¿½?                OnPropertyChanged(nameof(CanPlaceOrder));
                OnPropertyChanged(nameof(SelectedPositions));
                OnPropertyChanged(nameof(HasSelectedPositions));
                OnPropertyChanged(nameof(SelectedPositionCount));
                OnPropertyChanged(nameof(SelectedOrders));
                OnPropertyChanged(nameof(HasSelectedOrders));
                OnPropertyChanged(nameof(SelectedOrderCount));

                // åœ¨çŠ¶æ€æ æ˜¾ç¤ºç®€æ´çš„åˆçº¦ä¿¡æ¯
                var positionInfo = contractPosition != null ? $"æŒä»“{contractPosition.PositionAmt}" : "æ— æŒï¿½?;
                StatusMessage = $"{Symbol}: {PriceFormatConverter.FormatPrice(LatestPrice)} | {positionInfo} | å§”æ‰˜{orders.Count}ï¿½?| æœ€å¤§æ æ†{maxLeverage}x - {DateTime.Now:HH:mm:ss}";
                
                // æ·»åŠ åˆ°æœ€è¿‘åˆçº¦åˆ—ï¿½?                AddToRecentContracts(Symbol);
                
                Console.WriteLine($"ğŸ‰ åˆçº¦ä¿¡æ¯æŸ¥è¯¢å®Œæˆ: {Symbol}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ï¿½?æŸ¥è¯¢åˆçº¦ä¿¡æ¯å¼‚å¸¸: {ex.Message}");
                StatusMessage = $"æŸ¥è¯¢ {Symbol} åˆçº¦ä¿¡æ¯å¤±è´¥: {ex.Message}";
            }
            finally
            {
                IsLoading = false;
            }
        }

        [RelayCommand]
        private async Task CancelSelectedStopOrdersAsync()
        {
            try
            {
                // ç­›é€‰å‡ºé€‰ä¸­çš„æ­¢æŸå•ï¼ˆSTOP_MARKETç±»å‹ï¿½?                var selectedStopOrders = FilteredOrders.Where(o => o.IsSelected && o.Type == "STOP_MARKET").ToList();
                
                if (!selectedStopOrders.Any())
                {
                    StatusMessage = "è¯·å…ˆé€‰æ‹©æ­¢æŸå§”æ‰˜ï¿½?;
                    System.Windows.MessageBox.Show(
                        "è¯·å…ˆå‹¾é€‰è¦å–æ¶ˆçš„æ­¢æŸå§”æ‰˜å•ï¼ˆç±»å‹ä¸ºSTOP_MARKETï¿½?,
                        "æœªé€‰æ‹©æ­¢æŸï¿½?,
                        System.Windows.MessageBoxButton.OK,
                        System.Windows.MessageBoxImage.Warning);
                    return;
                }
                
                var result = System.Windows.MessageBox.Show(
                    $"ç¡®å®šè¦å–æ¶ˆé€‰ä¸­ï¿½?{selectedStopOrders.Count} ä¸ªæ­¢æŸå§”æ‰˜å•å—ï¼Ÿ\n\n" +
                    $"è¿™äº›æ­¢æŸå•å–æ¶ˆåå°†å¤±å»é£é™©ä¿æŠ¤ï¼Œè¯·ç¡®è®¤æ“ä½œï¼",
                    "å–æ¶ˆæ­¢æŸå•ç¡®ï¿½?,
                    System.Windows.MessageBoxButton.YesNo,
                    System.Windows.MessageBoxImage.Question);

                if (result != System.Windows.MessageBoxResult.Yes)
                    return;

                IsLoading = true;
                StatusMessage = $"æ­£åœ¨å–æ¶ˆ {selectedStopOrders.Count} ä¸ªé€‰ä¸­çš„æ­¢æŸå•...";
                
                int successCount = 0;
                int failedCount = 0;
                
                Console.WriteLine($"ğŸ›¡ï¿½?å¼€å§‹å–ï¿½?{selectedStopOrders.Count} ä¸ªæ­¢æŸå§”æ‰˜å•...");
                
                foreach (var order in selectedStopOrders)
                {
                    try
                    {
                        Console.WriteLine($"ğŸ—‘ï¿½?å–æ¶ˆæ­¢æŸï¿½? OrderId={order.OrderId}, Symbol={order.Symbol}, StopPrice={order.StopPrice}");
                        var success = await _binanceService.CancelOrderAsync(order.Symbol, order.OrderId);
                        
                        if (success)
                        {
                            successCount++;
                            Console.WriteLine($"ï¿½?æ­¢æŸå•å–æ¶ˆæˆï¿½? OrderId={order.OrderId}");
                        }
                        else
                        {
                            failedCount++;
                            Console.WriteLine($"ï¿½?æ­¢æŸå•å–æ¶ˆå¤±ï¿½? OrderId={order.OrderId}");
                        }
                    }
                    catch (Exception ex)
                    {
                        failedCount++;
                        Console.WriteLine($"ï¿½?å–æ¶ˆæ­¢æŸå•å¼‚ï¿½? OrderId={order.OrderId}, é”™è¯¯={ex.Message}");
                    }
                }
                
                StatusMessage = $"æ­¢æŸå•å–æ¶ˆå®Œï¿½? æˆåŠŸ {successCount} ä¸ªï¼Œå¤±è´¥ {failedCount} ï¿½?;
                Console.WriteLine($"ğŸ æ­¢æŸå•å–æ¶ˆæ“ä½œå®Œï¿½? æˆåŠŸ {successCount} ä¸ªï¼Œå¤±è´¥ {failedCount} ï¿½?);
                
                System.Windows.MessageBox.Show(
                    $"æ­¢æŸå•å–æ¶ˆæ“ä½œå®Œæˆï¼\n\n" +
                    $"ï¿½?æˆåŠŸå–æ¶ˆ: {successCount} ä¸ªæ­¢æŸå•\n" +
                    $"ï¿½?å–æ¶ˆå¤±è´¥: {failedCount} ä¸ªæ­¢æŸå•\n\n" +
                    $"æ³¨æ„ï¼šæ­¢æŸå•å·²å–æ¶ˆï¼Œç›¸å…³æŒä»“å¤±å»é£é™©ä¿æŠ¤ï¼Œè¯·è°¨æ…æ“ä½œï¿½?,
                    "å–æ¶ˆç»“æœ",
                    System.Windows.MessageBoxButton.OK,
                    failedCount > 0 ? System.Windows.MessageBoxImage.Warning : System.Windows.MessageBoxImage.Information);
                
                // åˆ·æ–°æ•°æ®
                await RefreshDataAsync();
            }
            catch (Exception ex)
            {
                StatusMessage = $"å–æ¶ˆæ­¢æŸå•å¼‚ï¿½? {ex.Message}";
                Console.WriteLine($"ï¿½?å–æ¶ˆé€‰ä¸­æ­¢æŸå•å¼‚ï¿½? {ex.Message}");
                
                System.Windows.MessageBox.Show(
                    $"å–æ¶ˆæ­¢æŸå•æ—¶å‘ç”Ÿå¼‚å¸¸ï¼š\n\n{ex.Message}",
                    "æ“ä½œå¼‚å¸¸",
                    System.Windows.MessageBoxButton.OK,
                    System.Windows.MessageBoxImage.Error);
            }
            finally
            {
                IsLoading = false;
            }
        }

        // æ·»åŠ åˆçº¦åˆ°æœ€è¿‘åˆ—ï¿½?        private void AddToRecentContracts(string symbol)
        {
            if (string.IsNullOrEmpty(symbol))
                return;

            try
            {
                // ç§»é™¤å·²å­˜åœ¨çš„ç›¸åŒåˆçº¦ï¼ˆå¦‚æœæœ‰ï¿½?                if (RecentContracts.Contains(symbol))
                {
                    RecentContracts.Remove(symbol);
                }

                // æ·»åŠ åˆ°åˆ—è¡¨å¼€ï¿½?                RecentContracts.Insert(0, symbol);

                // ä¿æŒæœ€ï¿½?0ä¸ªåˆï¿½?                while (RecentContracts.Count > 10)
                {
                    RecentContracts.RemoveAt(RecentContracts.Count - 1);
                }

                Console.WriteLine($"ğŸ“ æœ€è¿‘åˆçº¦å·²æ›´æ–°: {symbol} (æ€»æ•°: {RecentContracts.Count})");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ï¿½?æ›´æ–°æœ€è¿‘åˆçº¦åˆ—è¡¨å¤±ï¿½? {ex.Message}");
            }
        }

        // é€‰æ‹©æœ€è¿‘åˆçº¦çš„å‘½ä»¤
        [RelayCommand]
        private async Task SelectRecentContractAsync(string symbol)
        {
            if (string.IsNullOrEmpty(symbol))
                return;

            try
            {
                Console.WriteLine($"ğŸ”„ åˆ‡æ¢åˆ°æœ€è¿‘åˆï¿½? {symbol}");
                
                // è®¾ç½®åˆçº¦åç§°
                Symbol = symbol;
                
                // æŸ¥è¯¢åˆçº¦ä¿¡æ¯
                await QueryContractInfoAsync();
                
                StatusMessage = $"å·²åˆ‡æ¢åˆ°åˆçº¦: {symbol}";
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ï¿½?åˆ‡æ¢æœ€è¿‘åˆçº¦å¤±ï¿½? {ex.Message}");
                StatusMessage = $"åˆ‡æ¢åˆçº¦å¤±è´¥: {ex.Message}";
            }
        }
    }
} 
