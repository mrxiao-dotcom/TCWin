# 币安API集成说明

## 当前实现状态

✅ **已完成：使用币安官网原生REST API**

程序现在直接调用币安官网API，无需依赖第三方库，具有更好的控制性和稳定性。

## API实现功能

### 已实现的API接口

1. **账户信息** - `/fapi/v2/account`
   - 获取总权益、保证金、浮盈、可用余额等信息
   - 需要签名认证

2. **持仓信息** - `/fapi/v2/positionRisk`
   - 获取所有持仓列表
   - 过滤非零持仓
   - 需要签名认证

3. **订单查询** - `/fapi/v1/openOrders`
   - 获取当前挂单列表
   - 支持按合约过滤
   - 需要签名认证

4. **价格查询** - `/fapi/v1/ticker/price`
   - 获取合约最新价格
   - 公开接口，无需认证

5. **下单接口** - `/fapi/v1/order`
   - 支持市价单、限价单
   - 支持止损、减仓等参数
   - 需要签名认证

6. **平仓操作** - `/fapi/v1/order`
   - 自动计算平仓方向和数量
   - 使用reduceOnly标志确保安全

7. **批量撤单** - `/fapi/v1/allOpenOrders`
   - 撤销所有或指定合约的挂单
   - 需要签名认证

## 技术实现特点

### 1. 签名算法
```csharp
private string GenerateSignature(string queryString, string secretKey)
{
    var keyBytes = Encoding.UTF8.GetBytes(secretKey);
    var messageBytes = Encoding.UTF8.GetBytes(queryString);
    
    using (var hmac = new HMACSHA256(keyBytes))
    {
        var hashBytes = hmac.ComputeHash(messageBytes);
        return BitConverter.ToString(hashBytes).Replace("-", "").ToLower();
    }
}
```

### 2. 时间戳处理
- 使用UTC时间戳（毫秒）
- 防止时间同步问题

### 3. 错误处理
- 网络错误自动降级到模拟数据
- API错误信息记录到控制台
- 保证界面操作不中断

### 4. 安全考虑
- API密钥仅在内存中存储
- 使用HTTPS加密传输
- 签名验证保证请求完整性

## 配置要求

### API权限设置
在币安账户中，API密钥需要以下权限：
- ✅ **现货与杠杆交易**
- ✅ **期货交易**
- ❌ 提币权限（不需要）

### 网络要求
- 需要连接到币安服务器
- 正式环境：`https://fapi.binance.com`
- 测试环境：`https://testnet.binancefuture.com`

## 条件单功能

### 实现原理
- 客户端轮询价格变化
- 检测突破条件
- 自动触发下单

### 支持的条件类型
1. **向上突破**：当前价格 > 设定价格时触发
2. **向下突破**：当前价格 < 设定价格时触发

### 使用方法
1. 勾选"启用条件单"
2. 选择条件类型（向上突破/向下突破）
3. 设置突破价格
4. 配置正常下单参数
5. 点击下单，系统开始监控

## 风险管理

### 自动计算功能
1. **最大风险金** = 权益 ÷ 风险倍数
2. **以损定量** = 止损金额 ÷ (价格 × 止损比例)
3. **止损价格** = 入场价 ± (价格 × 止损比例)

### 杠杆快捷设置
- 一键设置常用杠杆：1x, 3x, 5x, 10x, 20x
- 实时显示当前杠杆设置
- 智能提示杠杆风险

## 界面优化

### 布局改进
- 标签和输入框同行显示
- 条件单独立区域
- 杠杆快捷按钮栏
- 实时状态显示

### 响应式设计
- 支持窗口最大化
- 控件自适应布局
- 美观的Material Design风格

## 故障排除

### 常见问题

1. **API连接失败**
   - 检查网络连接
   - 验证API密钥设置
   - 确认权限配置

2. **签名错误**
   - 检查密钥是否正确
   - 确认系统时间同步
   - 验证参数格式

3. **下单失败**
   - 检查余额是否充足
   - 确认合约名称正确
   - 验证数量精度

### 日志记录
程序会在控制台输出详细的错误信息，便于调试：
```
Error getting account info: ...
API Error: 401, {"code":-2014,"msg":"API-key format invalid."}
```

## 扩展计划

### 计划中的功能
1. 更多订单类型支持（止盈止损单等）
2. 高级条件单（技术指标触发）
3. 批量操作优化
4. 更丰富的风险控制
5. 交易统计和分析

### 性能优化
1. 连接池管理
2. 请求频率控制
3. 缓存机制
4. 异步处理优化 