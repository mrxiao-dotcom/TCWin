# 盈亏风险金计算逻辑修复说明

## 问题描述
之前的盈亏风险金计算逻辑不正确，需要按照以下要求重新实现：
1. 找到当前合约的持仓和委托订单
2. 按照止损触发顺序排序
3. 将委托数量与止损委托逐一匹配
4. 计算每个止损委托的盈亏并累加

## 新的计算逻辑

### 1. 数据收集
- **当前合约持仓**：获取指定合约的所有持仓（`Symbol == 当前合约 && PositionAmt != 0`）
- **普通委托订单**：获取指定合约的所有非止损委托订单
- **止损委托订单**：获取指定合约的所有止损委托订单（`Type == "STOP_MARKET" && ReduceOnly == true`）

### 2. 仓位合并
将持仓和委托订单合并为统一的仓位列表：
```csharp
var allPositions = new List<(decimal quantity, decimal entryPrice, string side, string source)>();

// 添加现有持仓
foreach (var position in currentPositions)
{
    allPositions.Add((
        Math.Abs(position.PositionAmt),     // 数量（绝对值）
        position.EntryPrice,                 // 进场价
        position.PositionAmt > 0 ? "BUY" : "SELL", // 方向
        "持仓"                              // 来源
    ));
}

// 添加委托订单
foreach (var order in normalOrders)
{
    allPositions.Add((
        order.OrigQty,                      // 委托数量
        order.Price > 0 ? order.Price : LatestPrice, // 委托价格或当前价格
        order.Side,                         // 委托方向
        $"委托#{order.OrderId}"             // 来源
    ));
}
```

### 3. 止损委托排序
按照止损触发的先后顺序排序：
- **多头止损**（卖出平仓）：止损价从高到低排序（价格高的先触发）
- **空头止损**（买入平仓）：止损价从低到高排序（价格低的先触发）

### 4. 数量匹配与盈亏计算
按照止损触发顺序，将仓位数量与止损委托逐一匹配

### 计算公式
```
可用风险金 = 标准风险金 + 盈亏风险金

其中：
- 标准风险金 = 账户权益 ÷ 风险机会次数
- 盈亏风险金 = Σ(每个止损委托的盈亏)
```

### 盈亏计算公式
- **多头止损盈亏** = (止损价 - 平均进场价) × 数量
- **空头止损盈亏** = (平均进场价 - 止损价) × 数量

## 实际应用示例

### 示例1：多头持仓 + 多头止损
- 持仓：BTCUSDT 1.0张 @50000
- 止损：BTCUSDT 卖出1.0张 @48000
- 盈亏计算：(48000 - 50000) × 1.0 = -2000U（亏损）

### 示例2：空头持仓 + 空头止损
- 持仓：BTCUSDT -1.0张 @50000
- 止损：BTCUSDT 买入1.0张 @52000
- 盈亏计算：(50000 - 52000) × 1.0 = -2000U（亏损）

## 技术改进

### 1. 精确性
- 按照实际的止损触发顺序计算
- 考虑持仓和委托的组合情况
- 支持正负盈亏的准确计算

### 2. 完整性
- 处理剩余未匹配的数量
- 详细的计算过程展示
- 完善的日志记录

### 3. 用户体验
- 清晰的计算步骤显示
- 直观的盈亏展示（正数/负数标识）
- 鼠标悬停查看详细计算过程

## 注意事项

1. **合约特定性**：只计算当前选择合约的盈亏风险金
2. **触发顺序**：严格按照价格优先的止损触发顺序
3. **数量匹配**：确保每个止损单只处理对应的仓位数量
4. **盈亏准确性**：支持正负盈亏，真实反映风险和收益
5. **异常处理**：处理无止损单、数量不匹配等异常情况

这个新的计算逻辑更加准确地反映了实际交易中的盈亏风险情况，为用户提供了更可靠的风险管理依据。 