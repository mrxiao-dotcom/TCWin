# 🎯 浮盈条件单模式选择功能

## 📋 功能概述

为浮盈条件单添加了**平仓型**和**加仓型**两种模式选择，解决了之前条件单方向设置的问题，并提供了更灵活的交易策略选择。

## 🔧 新增功能

### **1. 模式选择**
- **平仓型**：用于止盈平仓，订单方向与原持仓相反
- **加仓型**：用于突破加仓，订单方向与原持仓相同

### **2. 界面改进**
- 在浮盈条件单设置区添加了模式选择单选按钮
- 优化了界面布局，将计算按钮移到计算价格输入框旁边
- 添加了详细的工具提示说明

### **3. 逻辑优化**
- 根据选择的模式自动设置正确的订单方向
- 智能设置 `ReduceOnly` 参数（平仓型为true，加仓型为false）
- 针对不同模式提供不同的价格验证逻辑

## 💡 使用场景

### **平仓型（默认模式）**
- **用途**：止盈平仓，锁定浮盈
- **方向**：与持仓相反
- **示例**：
  - 做多持仓 → 卖出平多
  - 做空持仓 → 买入平空
- **减仓模式**：是（ReduceOnly=true）

### **加仓型**
- **用途**：突破加仓，追涨杀跌
- **方向**：与持仓相同
- **示例**：
  - 做多持仓 → 买入加多
  - 做空持仓 → 卖出加空
- **减仓模式**：否（ReduceOnly=false）

## 🔍 技术实现

### **新增属性**
```csharp
[ObservableProperty]
private string _profitConditionalOrderMode = "平仓型"; // 默认平仓型

// 模式选择绑定属性
public bool IsProfitConditionalCloseModeSelected { get; set; }
public bool IsProfitConditionalAddModeSelected { get; set; }
```

### **智能方向设置**
```csharp
if (ProfitConditionalOrderMode == "平仓型")
{
    // 平仓型：方向与原持仓相反
    orderSide = isLong ? "SELL" : "BUY";
    isReduceOnly = true;
}
else // 加仓型
{
    // 加仓型：方向与原持仓相同
    orderSide = isLong ? "BUY" : "SELL";
    isReduceOnly = false;
}
```

### **差异化价格验证**
- **平仓型**：验证止盈价格合理性
  - 做多：触发价应高于当前价
  - 做空：触发价应低于当前价
- **加仓型**：验证突破价格合理性
  - 做多：突破价应高于当前价
  - 做空：突破价应低于当前价

## 🎛️ 界面布局

浮盈条件单设置区域现在包含：

```
第一行：
[选择持仓] [目标浮盈] [订单模式：○平仓型 ○加仓型] [计算价格 + 计算按钮]

第二行：
[持仓信息] [条件类型] [下浮盈单按钮]
```

## 🎯 解决的问题

### **1. 方向混淆问题**
- **修复前**：固定为平仓方向，无法加仓
- **修复后**：可选择平仓或加仓模式

### **2. -2021 立即触发错误**
- **原因**：方向设置错误导致订单立即执行
- **解决**：根据模式智能设置正确方向

### **3. 使用场景受限**
- **修复前**：只能用于止盈平仓
- **修复后**：既可止盈平仓，也可突破加仓

## 📝 使用说明

### **平仓型操作流程**
1. 选择有持仓的合约
2. 选择"平仓型"模式
3. 输入目标浮盈金额
4. 点击"计算"按钮计算触发价格
5. 选择条件单类型（STOP_MARKET 或 TAKE_PROFIT_MARKET）
6. 点击"下浮盈单"执行

### **加仓型操作流程**
1. 选择有持仓的合约
2. 选择"加仓型"模式
3. 输入目标浮盈金额（此时计算的是加仓触发价）
4. 点击"计算"按钮计算触发价格
5. 选择条件单类型
6. 点击"下浮盈单"执行

## ✅ 优势

1. **更灵活**：支持止盈和加仓两种策略
2. **更智能**：自动设置正确的订单参数
3. **更安全**：严格的价格验证防止错误下单
4. **更清晰**：明确的模式说明和工具提示
5. **更完整**：涵盖了更多的交易场景

## 🚀 未来扩展

可以考虑进一步扩展的功能：
- 止损型条件单（基于浮亏触发）
- 多重条件单（同时设置止盈和止损）
- 动态调整功能（根据市场变化自动调整触发价）
- 批量设置功能（为多个持仓批量设置条件单） 